<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>howToGetElementWidth</title>
      <link href="/2022/08/16/howToGetElementWidth/"/>
      <url>/2022/08/16/howToGetElementWidth/</url>
      
        <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><ul><li>ä¸€å®ä¹ å°±æ²¡æœ‰äº†æ›´æ–°çš„åŠ¨åŠ›ğŸ˜­ï¼ˆä¸»è¦è¿˜æ˜¯å¤ªæ‡’äº†ï¼‰ï¼Œç›´åˆ°æœ€è¿‘å®Œæˆä¸€ä¸ªéœ€æ±‚æ—¶ï¼Œæ‰æƒ³åˆ°å¯ä»¥æŠŠè¿™æ¬¡å­¦ä¹ åˆ°çš„ä¸€ç‚¹ç‚¹ä¸œè¥¿æ€»ç»“æˆä¸€ç‰‡åšå®¢å¥½å¥½æ°´ä¸€æ°´</li><li>æœ¬æ¬¡éœ€æ±‚ä¸­æœ‰ä¸€ä¸ªæ ¸å¿ƒè¯‰æ±‚ç‚¹ï¼Œ<strong>éœ€è¦çŸ¥é“ä¸€ä¸ªtextNodeä¸­æŸå‡ ä¸ªæ–‡å­—çš„å®½åº¦</strong>ï¼Œä¾‹å­å¦‚ä¸‹ï¼š<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">span</span>&gt;</span>è¿™æ˜¯ä¸€æ®µæ–‡å­—<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- å¦‚ä½•è·å–â€œè¿™æ˜¯ä¸€æ®µæ–‡å­—â€ä¸­â€œæ–‡å­—â€çš„å®½åº¦ --&gt;</span></span><br></pre></td></tr></table></figure></li><li>å…¶å®å¯ä»¥æ‰©å±•ä¸º<strong>å¦‚ä½•è·å–ä¸€ä¸ªå…ƒç´ çš„å¤§å°ï¼ˆDOMRectï¼‰</strong></li></ul><h2 id="å¯è¡Œæ–¹æ¡ˆ"><a href="#å¯è¡Œæ–¹æ¡ˆ" class="headerlink" title="å¯è¡Œæ–¹æ¡ˆ"></a>å¯è¡Œæ–¹æ¡ˆ</h2><h3 id="getBoundingClientRect"><a href="#getBoundingClientRect" class="headerlink" title="getBoundingClientRect"></a>getBoundingClientRect</h3><ul><li>æœ€å¸¸ç”¨ï¼Œæœ€å¸¸è§ï¼Œå¤§å¤šæ•°äººéƒ½åº”è¯¥çŸ¥é“çš„ä¸€ä¸ªAPI</li><li>å­˜åœ¨äºHTMLElementå…ƒç´ ä¸Šï¼Œè°ƒç”¨æ–¹å¼Element.getBoudingClientRect</li><li>å¯ä»¥è·å–è°ƒç”¨æ­¤æ–¹æ³•çš„å…ƒç´ çš„<strong>DOMRectä»¥åŠåŸºäºå½“å‰è§†çª—çš„ä½ç½®</strong><ul><li>è§†çª—åŸç‚¹æŒ‡çš„æ˜¯é¡µé¢å·¦ä¸Šè§’</li><li>æ‰€æœ‰å•ä½éƒ½æ˜¯<strong>åƒç´ ï¼ˆpxï¼‰</strong><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> <span class="title class_">DOMRect</span>&#123;</span><br><span class="line">    <span class="attr">height</span>: <span class="built_in">number</span>; <span class="comment">// å…ƒç´ é«˜åº¦</span></span><br><span class="line">    <span class="attr">width</span>: <span class="built_in">number</span>; <span class="comment">// å…ƒç´ å®½åº¦</span></span><br><span class="line">    <span class="attr">left</span>: <span class="built_in">number</span>; <span class="comment">// å…ƒç´ å·¦è¾¹ç•Œè·ç¦»è§†çª—åŸç‚¹çš„å®½åº¦</span></span><br><span class="line">    <span class="attr">top</span>: <span class="built_in">number</span>; <span class="comment">// å…ƒç´ ä¸Šè¾¹ç•Œè·ç¦»è§†çª—åŸç‚¹çš„å®½åº¦</span></span><br><span class="line">    <span class="attr">x</span>: <span class="built_in">number</span>; <span class="comment">// åŒleft</span></span><br><span class="line">    <span class="attr">y</span>: <span class="built_in">number</span>; <span class="comment">// åŒright</span></span><br><span class="line">    <span class="attr">bottom</span>: <span class="built_in">number</span>; <span class="comment">// å…ƒç´ ä¸‹è¾¹ç•Œè·ç¦»è§†çª—åŸç‚¹çš„å®½åº¦ï¼Œheight + top</span></span><br><span class="line">    <span class="attr">right</span>: <span class="built_in">number</span>; <span class="comment">// å…ƒç´ å³è¾¹ç•Œè·ç¦»è§†çª—åŸç‚¹çš„å®½åº¦ï¼Œwidth + left</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul></li><li>widthå’Œç›’å­æ¨¡å‹<ul><li>widthçš„å€¼åœ¨æ ‡å‡†ç›’å­æ¨¡å‹ä¼šæ˜¯border+padding+width</li><li>åœ¨border-sizing: border-boxåˆ™ä¼šæ˜¯content widthï¼Œæ²¡æœ‰borderå’Œpadding</li></ul></li></ul><h3 id="getClientRects"><a href="#getClientRects" class="headerlink" title="getClientRects"></a>getClientRects</h3><ul><li>å®é™…ä¸Šæ˜¯<strong>getBoundingClientRectçš„æ‰©å±•ç‰ˆ</strong>ï¼Œç‰¹æ®Šå¤„ç†äº†ä¸€ä¸‹è¡Œå†…å…ƒç´ </li><li>ç®€è¿°ä¸€ä¸‹ï¼šå—çº§å…ƒç´ å’ŒgetBoundingClientRectä¸€è‡´ï¼Œä½†æ˜¯<strong>è¡Œçº§å…ƒç´ åˆ™ä¼šåœ¨æ¢è¡Œæƒ…å†µä¸‹è®¡ç®—ä¸ºä¸€ä¸ªæ–°DOMRect</strong></li><li>å®ä¾‹<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">span</span>&gt;</span>è¿™æ˜¯ä¸€ä¸ªè¶…é•¿çš„æ–‡æœ¬ï¼Œå®é™…æ¸²æŸ“å°±ä¼šé€ æˆæ¢è¡Œ!è¿™æ˜¯ä¸€ä¸ªè¶…é•¿çš„æ–‡æœ¬ï¼Œå®é™…æ¸²æŸ“å°±ä¼šé€ æˆæ¢è¡Œ!è¿™æ˜¯ä¸€ä¸ªè¶…é•¿çš„æ–‡æœ¬ï¼Œå®é™…æ¸²æŸ“å°±ä¼šé€ æˆæ¢è¡Œ!è¿™æ˜¯ä¸€ä¸ªè¶…é•¿çš„æ–‡æœ¬ï¼Œå®é™…æ¸²æŸ“å°±ä¼šé€ æˆæ¢è¡Œ!è¿™æ˜¯ä¸€ä¸ªè¶…é•¿çš„æ–‡æœ¬ï¼Œå®é™…æ¸²æŸ“å°±ä¼šé€ æˆæ¢è¡Œ!è¿™æ˜¯ä¸€ä¸ªè¶…é•¿çš„æ–‡æœ¬ï¼Œå®é™…æ¸²æŸ“å°±ä¼šé€ æˆæ¢è¡Œ!è¿™æ˜¯ä¸€ä¸ªè¶…é•¿çš„æ–‡æœ¬ï¼Œå®é™…æ¸²æŸ“å°±ä¼šé€ æˆæ¢è¡Œ!è¿™æ˜¯ä¸€ä¸ªè¶…é•¿çš„æ–‡æœ¬ï¼Œå®é™…æ¸²æŸ“å°±ä¼šé€ æˆæ¢è¡Œ!<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">const</span> span = <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&quot;span&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">    <span class="variable language_">console</span>.<span class="title function_">log</span>(span.<span class="title function_">getClientRects</span>());</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><ul><li>ä»£ç è¿è¡Œç»“æœ</li></ul></li></ul><img src="/2022/08/16/howToGetElementWidth/1.png" class="" title="ä»£ç è¿è¡Œç»“æœ"><ul><li>æ¯ä¸€è¡Œæ–‡æœ¬å¯¹åº”ä¸€ä¸ªDOMRect</li><li>åœ¨æœ¬æ¬¡éœ€æ±‚ä¸­æœ¬åº”æ˜¯æœ€å®Œç¾çš„è§£å†³æ–¹æ¡ˆï¼Œä½†æ˜¯ç”±äºä¸€äº›åŸå› ï¼Œéœ€è¦å»è·å–æŸå‡ ä¸ªæ–‡å­—çš„å®½åº¦ï¼Œå¹¶éä¸€ä¸ªæ ‡ç­¾ï¼Œæ‰€ä»¥éœ€è¦ç»“åˆä¸‹é¢è¿™ä¸ªAPIä½¿ç”¨</li></ul><h3 id="Range"><a href="#Range" class="headerlink" title="Range"></a>Range</h3><ul><li>ä¸€ä¸ªå› ä¸ºæœ¬æ¬¡éœ€æ±‚æ‰çŸ¥é“çš„Web APIï¼Œå¾ˆniceçš„æµè§ˆå™¨å…¼å®¹æ€§</li></ul><img src="/2022/08/16/howToGetElementWidth/2.png" class="" title="caniuse"><ul><li>å¯ä»¥åˆ›å»ºä¸€ä¸ªRangeå¯¹è±¡ï¼Œè°ƒç”¨æ–¹æ³•è®¾ç½®èµ·ç‚¹ï¼ˆstartï¼‰å’Œç»ˆç‚¹ï¼ˆendï¼‰ï¼Œç„¶åå°±<strong>å¯ä»¥è°ƒç”¨ä¸Šé¢ä¸¤ä¸ªå…ƒç´ APIï¼Œè·å–DOMRect</strong>ï¼ˆå®é™…ç”¨èµ·æ¥å¾ˆcoolï½ï¼‰</li><li>ç¤ºä¾‹<ul><li>renderå‡½æ•°ä¼šæ ¹æ®ä¼ å…¥çš„DOMRectï¼Œæ¸²æŸ“å‡ºä¸€ä¸ªçº¢è‰²è¾¹æ¡†<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;box1&quot;</span>&gt;</span>è¿™æ˜¯box1<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;box2&quot;</span>&gt;</span>è¿™æ˜¯box2<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">const</span> box1 = <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&#x27;.box1&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">const</span> box2 = <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&#x27;.box2&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">const</span> range = <span class="variable language_">document</span>.<span class="title function_">createRange</span>(); <span class="comment">// åˆ›å»ºRange</span></span></span><br><span class="line"><span class="language-javascript">  range.<span class="title function_">setStart</span>(box1, <span class="number">0</span>); <span class="comment">// è®¾ç½®èµ·ç‚¹</span></span></span><br><span class="line"><span class="language-javascript">  range.<span class="title function_">setEnd</span>(box1, <span class="number">1</span>); <span class="comment">// è®¾ç½®ç»ˆç‚¹</span></span></span><br><span class="line"><span class="language-javascript">  <span class="title function_">render</span>(range.<span class="title function_">getBoundingClientRect</span>());</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li>ä»£ç è¿è¡Œç»“æœ</li></ul></li></ul><img src="/2022/08/16/howToGetElementWidth/3.png" class="" title="ä»£ç è¿è¡Œç»“æœ"><ul><li>å› ä¸ºbox1åªæœ‰ä¸€ä¸ªchildren Nodeï¼ˆâ€œè¿™æ˜¯box1â€çš„textNodeï¼‰ï¼Œæ‰€ä»¥ç»ˆç‚¹åªèƒ½è®¾ç½®ä¸º1ï¼Œå¦‚æœ<strong>è¶…è¿‡children Nodeå°±ä¼šæŠ¥é”™</strong></li><li>é‚£ä¹ˆå½“æˆ‘æŠŠç»ˆç‚¹è®¾ç½®ä¸ºbox2çš„textNodeï¼Œä¼šå‘ç”Ÿä»€ä¹ˆå‘¢ï¼Ÿ<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">  <span class="comment">// ...</span></span></span><br><span class="line"><span class="language-javascript">  range.<span class="title function_">setEnd</span>(box2, <span class="number">1</span>); <span class="comment">// è®¾ç½®ç»ˆç‚¹</span></span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li>è¿è¡Œç»“æœ</li></ul><img src="/2022/08/16/howToGetElementWidth/4.png" class="" title="ä»£ç è¿è¡Œç»“æœ"><ul><li>å¯ä»¥çœ‹åˆ°<strong>å®Œç¾å›Šæ‹¬äº†box1å’Œbox2</strong>ï¼Œé‚£ä¹ˆæˆ‘ä»¬åå…¶é“è€Œè¡Œä¹‹ï¼Œè®¾ç½®box1çš„textNodeä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">  <span class="comment">// ...</span></span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">const</span> box1TextNode = box1.<span class="property">childNodes</span>[<span class="number">0</span>]; <span class="comment">// è·å–box1çš„TextNode</span></span></span><br><span class="line"><span class="language-javascript">  range.<span class="title function_">setStart</span>(box1TextNode, <span class="number">0</span>);</span></span><br><span class="line"><span class="language-javascript">  range.<span class="title function_">setEnd</span>(box1TextNode, <span class="number">2</span>);</span></span><br><span class="line"><span class="language-javascript">  <span class="comment">// ...</span></span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li>ä»£ç è¿è¡Œç»“æœ</li></ul><img src="/2022/08/16/howToGetElementWidth/5.png" class="" title="ä»£ç è¿è¡Œç»“æœ"><ul><li>å®Œç¾è¾¾åˆ°äº†æˆ‘æƒ³è¦çš„æ•ˆæœï¼åªåœ¨<strong>å‰ä¸¤ä¸ªæ–‡å­—ï¼ˆâ€œè¿™æ˜¯â€ï¼‰ä¸Šé¢ç»˜åˆ¶äº†è¾¹æ¡†</strong>ï¼Œå°±æ˜¯è¯´åªè·å–äº†å‰ä¸¤ä¸ªæ–‡å­—çš„DOMRect</li><li>è‡³æ­¤ï¼Œæˆ‘å°±æ‰¾åˆ°äº†Web APIæ‰€æ”¯æŒçš„æ ‡å‡†è§£æ³•ï¼ˆå½“ç„¶ä¼šæœ‰å…¶ä»–hackæ–¹å¼ï¼Œä¸‹æ–‡å°±æ˜¯ä¸€ä¸ªï¼‰</li></ul><p>PSï¼šRangeä¹Ÿå¯ä»¥è°ƒç”¨getClientRectsæ–¹æ³•ï¼Œæ‰€ä»¥é‡åˆ°æ¢è¡Œçš„å­—ç¬¦ä¹Ÿå¯ä»¥å‡†ç¡®è·å–width</p><h3 id="measureText"><a href="#measureText" class="headerlink" title="measureText"></a>measureText</h3><ul><li>è¿™ä¸ªå…¶å®æ˜¯ä¸€ç§hackæ–¹å¼ï¼ŒmeasureTextå…¶å®æ˜¯canvasçš„2dä¸Šä¸‹æ–‡çš„ä¸€ä¸ªapiï¼Œå¯ä»¥è®¾ç½®æ–‡å­—å¤§å°å’Œå­—ä½“ï¼ˆfont-sizeå’Œfont- familyï¼‰<strong>è®¡ç®—æ–‡å­—å®½åº¦</strong></li><li>è¿™ç§æ–¹å¼å®Œå…¨<strong>ä¸éœ€è¦è·å–ç›®æ ‡æ–‡å­—æ‰€åœ¨çš„ç›¸å…³DOM</strong>ï¼Œä½ åªéœ€è¦åˆ›å»ºä¸€ä¸ªcanvasçš„ç»˜åˆ¶ä¸Šä¸‹æ–‡å³å¯<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> ctx = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;canvas&#x27;</span>).<span class="title function_">getContext</span>(<span class="string">&#x27;2d&#x27;</span>); <span class="comment">// åˆ›å»ºä¸Šä¸‹æ–‡</span></span><br><span class="line">ctx.<span class="property">font</span> = <span class="string">&#x27;12px serif&#x27;</span>; <span class="comment">// è®¾ç½®å­—ä½“å’Œå¤§å°</span></span><br><span class="line">ctx.<span class="title function_">measureText</span>(<span class="string">&#x27;è¿™æ˜¯&#x27;</span>); <span class="comment">// è·å–æ–‡å­—å¤§å°</span></span><br></pre></td></tr></table></figure></li><li>å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œåœ¨è®¾ç½®ctx.fontçš„æ—¶å€™ï¼Œéœ€è¦è®¾ç½®ä¸ºå½“å‰canvaså·²åŠ è½½çš„å­—ä½“</li></ul><h1 id="ç›¸å…³èµ„æ–™"><a href="#ç›¸å…³èµ„æ–™" class="headerlink" title="ç›¸å…³èµ„æ–™"></a>ç›¸å…³èµ„æ–™</h1><ul><li>MDN<ul><li><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Element/getBoundingClientRect">getBoundingClientRect</a></li><li><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Element/getClientRects">getClientRects</a></li><li><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Range">RangeAPI</a></li><li><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/CanvasRenderingContext2D/measureText">measureText</a></li></ul></li></ul>]]></content>
      
      
      <categories>
          
          <category> javascript </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Javascript </tag>
            
            <tag> Web Api </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>React ScheduleåŸºç¡€å­¦ä¹ </title>
      <link href="/2022/05/21/ReactScheduleBasic/"/>
      <url>/2022/05/21/ReactScheduleBasic/</url>
      
        <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><ul><li>ä¹‹å‰å­¦ä¹ Reactæºç è¿‡ç¨‹ä¸­ï¼Œç›¸å…³æ–‡ç« ä¸€ç›´æåŠReactçš„concurrent modeï¼ˆå¹¶å‘æ¸²æŸ“æ¨¡å¼ï¼‰ï¼Œç”±æ­¤éœ€è¦å…ˆå­¦ä¹ ä¸€äº›å‰ç½®çŸ¥è¯†<ul><li><strong><code>requestIdleCallback</code>ï¼šç”±æµè§ˆå™¨æä¾›çš„ä¸€ä¸ªAPI</strong>ï¼Œç±»ä¼¼äº<code>requestAnimation</code>ï¼Œå¯ä»¥å†ç‰¹å®šæ—¶é—´æ®µä¸­æ‰§è¡Œä»£ç </li><li><strong>ç„¶è€Œï¼Œä¸Šè¿°APIç”±äºåœ¨å®éªŒä¸­ï¼ŒReactæ¨¡æ‹Ÿå®ç°äº†ä¸€ä¸ªè‡ªå·±çš„APIï¼Œä¸è¿‡ä¸å¦¨ç¢ç”¨<code>requestIdleCallback</code>å»ç†è§£Reactçš„è°ƒåº¦</strong></li></ul></li></ul><h2 id="requestIdleCallback"><a href="#requestIdleCallback" class="headerlink" title="requestIdleCallback"></a>requestIdleCallback</h2><h3 id="å®˜æ–¹æ–‡æ¡£"><a href="#å®˜æ–¹æ–‡æ¡£" class="headerlink" title="å®˜æ–¹æ–‡æ¡£"></a>å®˜æ–¹æ–‡æ¡£</h3><ul><li><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Window/requestIdleCallback">MDNå¯¹æ­¤çš„æ–‡æ¡£</a></li></ul><h3 id="ç®€è¿°"><a href="#ç®€è¿°" class="headerlink" title="ç®€è¿°"></a>ç®€è¿°</h3><ul><li><strong><code>requestIdleCallback</code>å¯ä»¥è®©æˆ‘ä»¬åœ¨æµè§ˆå™¨ç©ºé—²æ—¶é—´è¿è¡ŒæŸäº›ä»£ç </strong></li><li>æµè§ˆå™¨ä¸€å¸§æ‰€è¿è¡Œçš„è¿‡ç¨‹å¦‚ä¸‹<ul><li>ç†ŸçŸ¥çš„<code>requestAnimationFrame</code>ä¼šåœ¨æµè§ˆå™¨è§£æHTMLå‰æ‰§è¡Œï¼ˆ<strong>ä¹Ÿæ˜¯åŠ¨ç”»é€»è¾‘æœ€é€‚å®œæ’å…¥çš„åœ°æ–¹</strong>ï¼‰</li><li><strong><code>requestIdleCallback</code>ä¼šåœ¨æµè§ˆå™¨å®Œæˆä¸€å¸§çš„ç»˜åˆ¶åæ‰§è¡Œ</strong></li></ul></li></ul><img src="/2022/05/21/ReactScheduleBasic/1.png" class="" title="æµè§ˆå™¨ä¸€å¸§æ‰€åšçš„äº‹æƒ…"><ul><li><p>å¦‚æœæœ‰ç©ºé—²æ—¶é—´çš„è¯ï¼Œå°±ä¼šå»æ‰§è¡Œ<code>requestIdleCallback</code>å‡½æ•°ä¸­çš„å›è°ƒå‡½æ•°</p><ul><li><p>åŸºæœ¬ä¾‹å­</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">someWork</span>(<span class="params">deadline</span>)&#123; <span class="comment">// deadlineå°±æ˜¯requestIdleCallbackæä¾›çš„å‚æ•°</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;å½“å‰å¸§å‰©ä½™æ—¶é—´:&#x27;</span>,deadline.<span class="title function_">timeRemaining</span>()); <span class="comment">// ms</span></span><br><span class="line">    <span class="keyword">if</span>(deadline.<span class="title function_">timeRemaining</span>() &gt; <span class="number">1</span>)&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;è¿˜æœ‰å‰©ä½™æ—¶é—´&#x27;</span>); <span class="comment">// å½“å‰å¸§æœ‰ç©ºé—²æ—¶é—´æ‰§è¡Œä»£ç </span></span><br><span class="line">    &#125;<span class="keyword">else</span> <span class="keyword">if</span>(deadline.<span class="property">didTimeout</span>)&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;è¶…æ—¶äº†ï¼&#x27;</span>); <span class="comment">// å½“å‰å¸§æ²¡æœ‰ç©ºé—²æ—¶é—´ï¼Œä¸”å·²è¶…è¿‡timeoutï¼Œæµè§ˆå™¨å°±ä¼šç«‹å³æ‰§è¡Œ</span></span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="title function_">requestIdleCallback</span>(someWork,&#123;<span class="attr">timeout</span>:<span class="number">1000</span>&#125;); <span class="comment">// å½“å‰å¸§æ²¡æœ‰ç©ºé—²æ—¶é—´ï¼Œä¸”æ²¡è¿‡timeoutï¼Œå°†å›è°ƒå‡½æ•°æ”¾åˆ°ä¸‹ä¸€å¸§å»</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">requestIdleCallback</span>(someWork,&#123;<span class="attr">timeout</span>:<span class="number">1000</span>&#125;);</span><br></pre></td></tr></table></figure></li></ul></li></ul><h2 id="Reactè°ƒåº¦â€”â€”æ—¶é—´åˆ†ç‰‡"><a href="#Reactè°ƒåº¦â€”â€”æ—¶é—´åˆ†ç‰‡" class="headerlink" title="Reactè°ƒåº¦â€”â€”æ—¶é—´åˆ†ç‰‡"></a>Reactè°ƒåº¦â€”â€”æ—¶é—´åˆ†ç‰‡</h2><h3 id="å¹¶å‘æ‰§è¡Œ"><a href="#å¹¶å‘æ‰§è¡Œ" class="headerlink" title="å¹¶å‘æ‰§è¡Œ"></a>å¹¶å‘æ‰§è¡Œ</h3><ul><li>Reactä¹‹æ‰€ä»¥ä½¿ç”¨Fiberï¼Œå¾ˆå¤§ç¨‹åº¦ä¸Šæ˜¯ä¸ºäº†å®ç°concurrent modeï¼ˆå¹¶å‘æ¸²æŸ“ï¼‰ï¼Œä¸ºäº†å®ç°å¤§æ¦‚è¿™æ ·çš„æ•ˆæœ<ul><li><p>åˆ©ç”¨Fiberè¿™ç§ç±»æ ‘çš„æ•°æ®ç»“æ„ï¼Œåœ¨å¯¹æ¯ä¸€ä¸ªFiberæ‰§è¡Œå®Œ<code>Work</code>çš„æ—¶å€™ï¼Œå¯ä»¥ä¸­æ–­ï¼Œä¹Ÿå°±æ˜¯åœæ­¢JavaScriptçš„æ‰§è¡Œï¼Œå°†çº¿ç¨‹äº¤ç»™æµè§ˆå™¨</p></li><li><p><strong>è¿™æ ·å°±ä¼šè¾¾åˆ°çº¿ç¨‹åœ¨JavaScriptæ‰§è¡Œå’Œæµè§ˆå™¨ç»˜åˆ¶é—´äº¤æ›¿è¿è¡Œâ€”â€”ä¹Ÿå°±æ˜¯å¹¶å‘æ‰§è¡Œï¼</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å¹¶å‘æ¸²æŸ“æ¨¡å¼ä¸‹çš„workLoopå‡½æ•°å¦‚ä¸‹</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">workLoopConcurrent</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// Perform work until Scheduler asks us to yield</span></span><br><span class="line">    <span class="keyword">while</span> (workInProgress !== <span class="literal">null</span> &amp;&amp; !<span class="title function_">shouldYield</span>()) &#123; <span class="comment">// shouldYieldå‡½æ•°ç”¨äºæŸ¥çœ‹æ˜¯å¦éœ€è¦æŠŠçº¿ç¨‹å½’è¿˜ç»™æµè§ˆå™¨</span></span><br><span class="line">        <span class="title function_">performUnitOfWork</span>(workInProgress);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p><code>ShouldTield</code>å‡½æ•°å¦‚ä¸‹ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">shouldYieldToHost</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> timeElapsed = <span class="built_in">exports</span>.<span class="title function_">unstable_now</span>() - startTime;</span><br><span class="line">    <span class="keyword">if</span> (timeElapsed &lt; frameInterval) &#123; <span class="comment">// frameInterval ä¸€èˆ¬æ˜¯5ms</span></span><br><span class="line">        <span class="comment">// è¿è¡Œæ—¶é—´å¾ˆå°ï¼Œä¸éœ€è¦yield</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// éœ€è¦æŠŠçº¿ç¨‹è¿”å›ç»™æµè§ˆå™¨</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul></li></ul><h3 id="React-å®é™…ä½¿ç”¨çš„æ–¹å¼"><a href="#React-å®é™…ä½¿ç”¨çš„æ–¹å¼" class="headerlink" title="React å®é™…ä½¿ç”¨çš„æ–¹å¼"></a>React å®é™…ä½¿ç”¨çš„æ–¹å¼</h3><ul><li><p>Reactä¸ºäº†å…¼å®¹æ€§ï¼ˆå› ä¸º<code>requestIdleCallback</code>å‡½æ•°æ˜¯å®éªŒæ€§å‡½æ•°ï¼‰ï¼Œæ¨¡æ‹Ÿå®ç°äº†è‡ªå·±çš„<code>requestIdleCallback</code>å‡½æ•°</p></li><li><p>å®ä»»åŠ¡æ— ç–‘æ˜¯æœ€ä½³çš„æ¨¡æ‹Ÿæ–¹å¼ï¼ŒåŸå› åœ¨åé¢ï¼Œ<strong>Reacté‡‡ç”¨äº†<code>MessageChannel</code>æ–¹å¼æ¨¡æ‹Ÿè‡ªå·±çš„<code>requestIdleCallback</code>å‡½æ•°</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> channel = <span class="keyword">new</span> <span class="title class_">MessageChannel</span>()</span><br><span class="line"><span class="keyword">const</span> port = channel.<span class="property">port2</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// æ¯æ¬¡ port.postMessage() è°ƒç”¨å°±ä¼šæ·»åŠ ä¸€ä¸ªå®ä»»åŠ¡</span></span><br><span class="line"><span class="comment">// è¯¥å®ä»»åŠ¡ä¸ºè°ƒç”¨ scheduler.scheduleTask æ–¹æ³•</span></span><br><span class="line">channel.<span class="property">port1</span>.<span class="property">onmessage</span> = scheduleTask</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">scheduleTask</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> task = <span class="title function_">getTask</span>(); <span class="comment">// è·å–ä¸€ä¸ªä»»åŠ¡å¹¶æ‰§è¡Œ</span></span><br><span class="line">    <span class="keyword">if</span>(!<span class="title function_">task</span>())&#123;</span><br><span class="line">        port.<span class="title function_">postMessage</span>(<span class="literal">null</span>); <span class="comment">// ä»»åŠ¡æœªå®Œæˆï¼Œä¸‹ä¸€ä¸ªä»»åŠ¡ç»§ç»­</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>é€‰æ‹©å®ä»»åŠ¡çš„åŸå› ï¼Œè¿™é‡Œéœ€è¦æ³¨æ„å®ä»»åŠ¡å’Œå¾®ä»»åŠ¡çš„æ‰§è¡Œæ—¶æœº</p><ul><li><strong>å®ä»»åŠ¡ä¸ä¼šé˜»å¡é¡µé¢æ¸²æŸ“ï¼Œè€Œå¾®ä»»åŠ¡ä¼šé˜»å¡</strong></li></ul></li></ul><img src="/2022/05/21/ReactScheduleBasic/2.png" class="" title="JSä»£ç å»æè¿°æµè§ˆå™¨æ‰§è¡Œ"><ul><li><p>æ­£å¦‚å›¾ç‰‡ä¸­æ‰€æè¿°çš„ï¼Œæ¯ä¸€æ¬¡æ¸²æŸ“éƒ½ä¼šå°†å¾®ä»»åŠ¡æ¸…ç©ºï¼Œæ‰ä¼šå»è¿›è¡Œä¸‹ä¸€æ­¥</p></li><li><p><a href="https://codepen.io/jackluson/pen/eYVgewE">ç½‘ä¸Šæ‰¾åˆ°çš„DEMOä¾‹å­</a></p></li></ul><h2 id="æ–‡ç« æ¨è"><a href="#æ–‡ç« æ¨è" class="headerlink" title="æ–‡ç« æ¨è"></a>æ–‡ç« æ¨è</h2><blockquote><p><a href="https://juejin.cn/post/7061947637167194142">2022å¹´äº†,è¿˜ä¸æ‡‚requestIdleCallbackä¹ˆ?â€”â€”æ˜é‡‘</a></p><p><a href="https://blog.csdn.net/weixin_45654582/article/details/122634214">Reactè°ƒåº¦ï¼ˆScheduleï¼‰åŸç†ç†è§£</a></p><p><a href="https://juejin.cn/post/6953804914715803678">React Scheduler ä¸ºä»€ä¹ˆä½¿ç”¨ MessageChannel å®ç°</a></p></blockquote>]]></content>
      
      
      <categories>
          
          <category> React </category>
          
      </categories>
      
      
        <tags>
            
            <tag> React </tag>
            
            <tag> Javascript </tag>
            
            <tag> concurrent </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ReactSourceEffectListDebug</title>
      <link href="/2022/05/04/ReactSourceEffectListDebug/"/>
      <url>/2022/05/04/ReactSourceEffectListDebug/</url>
      
        <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><h3 id="é—®é¢˜"><a href="#é—®é¢˜" class="headerlink" title="é—®é¢˜"></a>é—®é¢˜</h3><ul><li>Reactå¯¹Fiberæ ‘è¿›è¡Œéå†æ ‡è®°æ›´æ–°ä¹‹åï¼Œéœ€è¦åœ¨<strong>çœŸå®DOMä¸­è¿›è¡Œå®é™…æ“ä½œ</strong>ï¼Œå·²ç»çŸ¥é“ä¼šåœ¨<code>commit</code>é˜¶æ®µï¼Œé‚£ä¹ˆReactæ˜¯æ€ä¹ˆæ‰¾åˆ°éœ€è¦æ›´æ–°çš„Fiberçš„å‘¢ï¼Ÿ<ul><li>ä»Fiberæ ‘å¼€å§‹ä»å¤´éå†ä¼šä½¿å¾—æ€§èƒ½å¾ˆä½</li></ul></li></ul><h3 id="è§£å†³æ–¹æ¡ˆ"><a href="#è§£å†³æ–¹æ¡ˆ" class="headerlink" title="è§£å†³æ–¹æ¡ˆ"></a>è§£å†³æ–¹æ¡ˆ</h3><ul><li><strong>Reactåœ¨å¯¹Fiberè¿›è¡Œä¿®æ”¹çš„æ—¶å€™ï¼Œä¼šåŒæ—¶ç»´æŠ¤ä¸€ä¸ªç‰¹æ®Šçš„<code>EffectList</code>ç”¨æ¥ä¿å­˜éœ€è¦ä¿®æ”¹çš„Fiber</strong><ul><li><code>EffectList</code>å°±æ˜¯ä¸€ä¸ªé“¾è¡¨ï¼Œæ¯ä¸€ä¸ªèŠ‚ç‚¹çš„å€¼æ˜¯ä¸€ä¸ªFiber</li><li>æ¯ä¸ªFiberéƒ½æœ‰è‡ªå·±çš„<code>firstEffect</code>ã€<code>lastEffect</code>ï¼Œä¹Ÿå°±æ˜¯é“¾è¡¨çš„å¤´èŠ‚ç‚¹å’Œå°¾èŠ‚ç‚¹</li></ul></li></ul><h3 id="å­¦ä¹ å®ä¾‹"><a href="#å­¦ä¹ å®ä¾‹" class="headerlink" title="å­¦ä¹ å®ä¾‹"></a>å­¦ä¹ å®ä¾‹</h3><ul><li><p>DEMOå¦‚ä¸‹ï¼ˆè¿˜æ˜¯Diffæºç å­¦ä¹ ä¸­çš„æ¡ˆä¾‹ï¼‰</p><figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">Test</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">debugger</span>;</span><br><span class="line">  <span class="keyword">const</span> [list, setList] = useState&lt;<span class="title class_">ListItemType</span>[]&gt;([</span><br><span class="line">    &#123; <span class="attr">text</span>: <span class="string">&quot;22 a&quot;</span>, <span class="attr">key</span>: <span class="string">&quot;a&quot;</span> &#125;,</span><br><span class="line">    &#123; <span class="attr">text</span>: <span class="string">&quot;13 b&quot;</span>, <span class="attr">key</span>: <span class="string">&quot;b&quot;</span> &#125;,</span><br><span class="line">    &#123; <span class="attr">text</span>: <span class="string">&quot;21 c&quot;</span>, <span class="attr">key</span>: <span class="string">&quot;c&quot;</span> &#125;,</span><br><span class="line">    &#123; <span class="attr">text</span>: <span class="string">&quot;12 d&quot;</span>, <span class="attr">key</span>: <span class="string">&quot;d&quot;</span> &#125;,</span><br><span class="line">    &#123; <span class="attr">text</span>: <span class="string">&quot;32 e&quot;</span>, <span class="attr">key</span>: <span class="string">&quot;e&quot;</span> &#125;,</span><br><span class="line">    &#123; <span class="attr">text</span>: <span class="string">&quot;44 f&quot;</span>, <span class="attr">key</span>: <span class="string">&quot;f&quot;</span> &#125;,</span><br><span class="line">  ]);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">ul</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        &#123;list.map((item) =&gt; &#123;</span></span><br><span class="line"><span class="language-xml">          return item ? <span class="tag">&lt;<span class="name">li</span> <span class="attr">key</span>=<span class="string">&#123;item.key&#125;</span>&gt;</span>&#123;item.text&#125;<span class="tag">&lt;/<span class="name">li</span>&gt;</span> : null;</span></span><br><span class="line"><span class="language-xml">        &#125;)&#125;</span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">button</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">        <span class="attr">onClick</span>=<span class="string">&#123;()</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-xml">          debugger;</span></span><br><span class="line"><span class="language-xml">          setList((prev) =&gt; &#123;</span></span><br><span class="line"><span class="language-xml">            let newArr: ListItemType[] = [];</span></span><br><span class="line"><span class="language-xml">            prev.splice(Math.floor(Math.random() * 5), 1);</span></span><br><span class="line"><span class="language-xml">            newArr.push(...prev.splice(Math.floor(Math.random() * 4), 1));</span></span><br><span class="line"><span class="language-xml">            newArr = newArr.concat(prev);</span></span><br><span class="line"><span class="language-xml">            return newArr;</span></span><br><span class="line"><span class="language-xml">          &#125;);</span></span><br><span class="line"><span class="language-xml">        &#125;&#125;</span></span><br><span class="line"><span class="language-xml">      &gt;</span></span><br><span class="line"><span class="language-xml">        random all</span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></li></ul><h2 id="EffectList"><a href="#EffectList" class="headerlink" title="EffectList"></a>EffectList</h2><h3 id="DEOMæ›´æ–°çŠ¶æ€"><a href="#DEOMæ›´æ–°çŠ¶æ€" class="headerlink" title="DEOMæ›´æ–°çŠ¶æ€"></a>DEOMæ›´æ–°çŠ¶æ€</h3><ul><li>DEMOè¿è¡Œç‚¹å‡»æŒ‰é’®åå°†è¦æ›´æ–°çš„çŠ¶æ€ï¼Œå…³é”®æ›´æ–°å¦‚ä¸‹<ul><li>eåºåˆ—ç§»åŠ¨åˆ°ç¬¬ä¸€ä¸ªä½ç½®</li><li>åˆ é™¤cåºåˆ—</li></ul></li></ul><img src="/2022/05/04/ReactSourceEffectListDebug/111.png" class="" title="DEMOæ›´æ–°çŠ¶æ€"><h3 id="EffectListæ‰§è¡Œæ—¶æœº"><a href="#EffectListæ‰§è¡Œæ—¶æœº" class="headerlink" title="EffectListæ‰§è¡Œæ—¶æœº"></a>EffectListæ‰§è¡Œæ—¶æœº</h3><ul><li>æœ€ååœ¨<code>commit</code>é˜¶æ®µï¼Œä¿®æ”¹çœŸå®DOMæ—¶æœ‰è¿™æ ·çš„ä»£ç ï¼ˆå·²çœç•¥éƒ¨åˆ†ä»£ç ï¼‰<ul><li><strong>å°±æ˜¯å»å¾ªç¯è·å–<code>EffectList</code>ï¼Œæ ¹æ®æ¯ä¸€ä¸ª<code>Effect</code>çš„<code>flags</code>å»å†³å®šä¿®æ”¹æ–¹å¼</strong></li><li><strong>ä¼šé€šè¿‡FiberRootçš„<code>firstEffect</code>è·å–ç¬¬ä¸€ä¸ªeffectï¼Œç„¶åè¿›å…¥å¾ªç¯</strong></li><li><strong>æ¯ä¸€ä¸ªEffectéƒ½æ˜¯ä¸€ä¸ªFiber</strong></li><li><strong>ä¸€ä¸ªå…¸å‹çš„ç©ºé—´æ¢å–æ—¶é—´çš„ä¼˜åŒ–æœºåˆ¶</strong></li></ul></li></ul><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> (nextEffect !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="title function_">setCurrentFiber</span>(nextEffect); <span class="comment">// è®¾ç½®Fiberç¯å¢ƒ</span></span><br><span class="line">    <span class="keyword">var</span> flags = nextEffect.<span class="property">flags</span>; <span class="comment">// æ›´æ–°flags</span></span><br><span class="line">    <span class="keyword">var</span> primaryFlags = flags &amp; (<span class="title class_">Placement</span> | <span class="title class_">Update</span> | <span class="title class_">Deletion</span> | <span class="title class_">Hydrating</span>); <span class="comment">// è®¡ç®—flags</span></span><br><span class="line">    <span class="keyword">switch</span> (primaryFlags) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="title class_">Placement</span>: <span class="comment">// ç§»åŠ¨èŠ‚ç‚¹çš„effectæ“ä½œ</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="title function_">commitPlacement</span>(nextEffect);ct.<span class="property">flags</span> &amp;= ~<span class="title class_">Placement</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">resetCurrentFiber</span>(); <span class="comment">// é‡ç½®Fiberç¯å¢ƒ</span></span><br><span class="line">    nextEffect = nextEffect.<span class="property">nextEffect</span>; <span class="comment">// è·å–ä¸‹ä¸€ä¸ªeffectï¼Œ</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="EffectListå®ä¾‹"><a href="#EffectListå®ä¾‹" class="headerlink" title="EffectListå®ä¾‹"></a>EffectListå®ä¾‹</h3><ul><li>æ¡ˆä¾‹æ›´æ–°çŠ¶æ€çš„<code>EffectList</code>å¦‚ä¸‹</li></ul><img src="/2022/05/04/ReactSourceEffectListDebug/222.png" class="" title="EffectListé“¾è¡¨"><ul><li><p><strong>å³<code>c-&gt;a-&gt;b-&gt;d-&gt;button</code>è¿™ä¸ª<code>effectlist</code>åœ¨è¿™æ¬¡æ›´æ–°çŠ¶æ€ä¸­ç”Ÿæˆï¼Œ<code>commit</code>é˜¶æ®µéå†è¿™ä¸ªé“¾è¡¨ï¼Œä»è€Œä¸€ä¸ªä¸€ä¸ªæ›´æ–°çœŸå®DOM</strong></p></li><li><p><strong>å¯ä»¥çœ‹åˆ°æ²¡æœ‰<code>e</code>èŠ‚ç‚¹åœ¨<code>EffectList</code>ä¸­å¦‚åŒä¹‹å‰Diffä¸­è¯´è¿‡çš„ï¼ŒReactå¯¹èŠ‚ç‚¹åªè¿›è¡Œå³ç§»æ“ä½œï¼Œæ‰€ä»¥<code>e</code>èŠ‚ç‚¹ä¿æŒåŸä½å³å¯</strong></p></li></ul><h3 id="EffectListç”Ÿæˆæœºåˆ¶"><a href="#EffectListç”Ÿæˆæœºåˆ¶" class="headerlink" title="EffectListç”Ÿæˆæœºåˆ¶"></a>EffectListç”Ÿæˆæœºåˆ¶</h3><ul><li><p><strong>ä¸»è¦ç»§æ‰¿é€»è¾‘å°±åœ¨<code>completeWork</code>ä»£ç ä¸­ï¼Œå³FiberèŠ‚ç‚¹çš„<code>complete</code>é˜¶æ®µ</strong></p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (returnFiber !== <span class="literal">null</span> &amp;&amp;</span><br><span class="line">    (returnFiber.<span class="property">flags</span> &amp; <span class="title class_">Incomplete</span>) === <span class="title class_">NoFlags</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (returnFiber.<span class="property">firstEffect</span> === <span class="literal">null</span>) &#123; <span class="comment">// çˆ¶Fiberä¸å­˜åœ¨EffectListæ—¶</span></span><br><span class="line">        returnFiber.<span class="property">firstEffect</span> = completedWork.<span class="property">firstEffect</span>; <span class="comment">// ç›´æ¥ç»§æ‰¿å­Fiberçš„EffectList</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (completedWork.<span class="property">lastEffect</span> !== <span class="literal">null</span>) &#123; <span class="comment">// å­Fiberå­˜åœ¨EffectList</span></span><br><span class="line">        <span class="keyword">if</span> (returnFiber.<span class="property">lastEffect</span> !== <span class="literal">null</span>) &#123; <span class="comment">// çˆ¶Fiberä¹Ÿå­˜åœ¨EffectList</span></span><br><span class="line">            returnFiber.<span class="property">lastEffect</span>.<span class="property">nextEffect</span> = completedWork.<span class="property">firstEffect</span>; <span class="comment">// è®©çˆ¶Fiberçš„EffectListçš„æœ€åä¸€ä¸ªEffectè¿æ¥å­Fiberçš„Effectï¼Œå®é™…ä¸Šå°±æ˜¯å­é“¾è¡¨æ¥åˆ°çˆ¶é“¾è¡¨åé¢</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        returnFiber.<span class="property">lastEffect</span> = completedWork.<span class="property">lastEffect</span>; <span class="comment">// ä¿è¯çˆ¶é“¾è¡¨çš„å°¾æŒ‡é’ˆæŒ‡å‘æœ€åä¸€ä¸ªEffect</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">var</span> flags = completedWork.<span class="property">flags</span>; <span class="comment">// è·å–å½“å‰Fiberçš„æ›´æ–°æ ‡è¯†ï¼ˆflagsï¼‰</span></span><br><span class="line">    <span class="keyword">if</span> (flags &gt; <span class="title class_">PerformedWork</span>) &#123; <span class="comment">// å¦‚æœæ˜¯éœ€è¦æ“ä½œDOMçš„æ›´æ–°</span></span><br><span class="line">        <span class="comment">// æŠŠå½“å‰Fiberæ·»åŠ åˆ°çˆ¶Fiberçš„EffectListä¸­</span></span><br><span class="line">        <span class="keyword">if</span> (returnFiber.<span class="property">lastEffect</span> !== <span class="literal">null</span>) &#123;</span><br><span class="line">            returnFiber.<span class="property">lastEffect</span>.<span class="property">nextEffect</span> = completedWork;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            returnFiber.<span class="property">firstEffect</span> = completedWork;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// è®¾ç½®çˆ¶Fiberçš„å°¾æŒ‡é’ˆ</span></span><br><span class="line">        returnFiber.<span class="property">lastEffect</span> = completedWork;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p><strong><code>PerformedWork</code>çš„å€¼æ˜¯1ï¼Œè€Œä¸éœ€è¦å˜åŠ¨çš„Fiberæ‰€æ ‡è¯†çš„flagsæ˜¯0ï¼ˆä¾‹å¦‚æœ¬ä¾‹çš„èŠ‚ç‚¹<code>e</code>ï¼‰ï¼Œå…¶ä½™éƒ½ä¼šæ ‡è¯†éƒ½ä¼šå¤§äº<code>PerformedWork</code>è¿™æ ·å°±æŠŠç‰¹å®šçš„Fiberè¿æ¥åˆ°äº†<code>EffectList</code>ä¸­</strong></p></li><li><p><strong><code>a b d</code>èŠ‚ç‚¹çš„flagsæ—©åœ¨çˆ¶Fiberåœ¨Diffå­©å­èŠ‚ç‚¹çš„æ—¶å€™å°±å·²ç»æ ‡è®°äº†ï¼Œå…·ä½“å¦‚ä¸‹</strong></p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (oldIndex &lt; lastPlacedIndex) &#123;</span><br><span class="line">    newFiber.<span class="property">flags</span> = <span class="title class_">Placement</span>; <span class="comment">// æ ‡è®°ä¸ºç§»åŠ¨</span></span><br><span class="line">    <span class="keyword">return</span> lastPlacedIndex;</span><br><span class="line">&#125; <span class="keyword">else</span> </span><br><span class="line">    <span class="keyword">return</span> oldIndex;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// æ²¡é”™ï¼Œå°±æ˜¯ä¸Šä¸ªDiffæºç å­¦ä¹ ä¸­çš„PlaceChildå‡½æ•°(æ£€æŸ¥èŠ‚ç‚¹æ˜¯å¦éœ€è¦ç§»åŠ¨)ä¸­æ‰§è¡Œçš„æ“ä½œ</span></span><br></pre></td></tr></table></figure></li><li><p><strong><code>c</code>èŠ‚ç‚¹ä¹Ÿä¼šåœ¨Diffæ—¶æ ‡è®°ï¼Œå¹¶ä¸”ç›´æ¥è®¡å…¥<code>EffectList</code>ï¼Œå…·ä½“å¦‚ä¸‹</strong></p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> last = returnFiber.<span class="property">lastEffect</span>;</span><br><span class="line">last.<span class="property">nextEffect</span> = childToDelete;</span><br><span class="line">returnFiber.<span class="property">lastEffect</span> = childToDelete;</span><br><span class="line"><span class="comment">// å°±åœ¨Diffæ“ä½œçš„æœ€åé˜¶æ®µæ‰§è¡Œï¼Œç”¨äºæ ‡è®°éœ€è¦åˆ é™¤çš„childFiber</span></span><br></pre></td></tr></table></figure></li><li><p><strong>ç”±äºFiberæ ‘çš„éå†ä»¥åŠå®Œæˆæœºåˆ¶ï¼Œ<code>completeWork</code>åˆ°FiberRootæ—¶ï¼Œä¹Ÿå°±å®Œæˆäº†æ•´ä¸ª<code>EffectList</code>ï¼Œè¿™æ ·åœ¨<code>commit</code>é˜¶æ®µåªéœ€è¦è·å–FiberRootçš„<code>firstEffect</code>ï¼Œå³å¯å¼€å§‹éå†<code>EffectList</code>è¿›è¡Œæ›´æ–°æ“ä½œ</strong></p><ul><li>ä¸å±äºçœŸå®DOMçš„Effectä¹Ÿæ˜¯åŒæ ·çš„æœºåˆ¶ï¼ˆä¾‹å¦‚ï¼š<code>useEffect</code>æ³¨å†Œçš„å‡½æ•°ï¼‰</li></ul></li></ul>]]></content>
      
      
      <categories>
          
          <category> React </category>
          
      </categories>
      
      
        <tags>
            
            <tag> React </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ReactSourceDiffDebug</title>
      <link href="/2022/04/06/ReactSourceDiffDebug/"/>
      <url>/2022/04/06/ReactSourceDiffDebug/</url>
      
        <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><ul><li><p>Reactæºç ç‰ˆæœ¬ï¼š<code>17.0.2</code></p></li><li><p>DEMOå¦‚ä¸‹</p></li></ul><figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">Test</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">debugger</span>;</span><br><span class="line">  <span class="keyword">const</span> [list, setList] = useState&lt;<span class="title class_">ListItemType</span>[]&gt;([</span><br><span class="line">    &#123; <span class="attr">text</span>: <span class="string">&quot;22 a&quot;</span>, <span class="attr">key</span>: <span class="string">&quot;a&quot;</span> &#125;,</span><br><span class="line">    &#123; <span class="attr">text</span>: <span class="string">&quot;13 b&quot;</span>, <span class="attr">key</span>: <span class="string">&quot;b&quot;</span> &#125;,</span><br><span class="line">    &#123; <span class="attr">text</span>: <span class="string">&quot;21 c&quot;</span>, <span class="attr">key</span>: <span class="string">&quot;c&quot;</span> &#125;,</span><br><span class="line">    &#123; <span class="attr">text</span>: <span class="string">&quot;12 d&quot;</span>, <span class="attr">key</span>: <span class="string">&quot;d&quot;</span> &#125;,</span><br><span class="line">    &#123; <span class="attr">text</span>: <span class="string">&quot;32 e&quot;</span>, <span class="attr">key</span>: <span class="string">&quot;e&quot;</span> &#125;,</span><br><span class="line">    &#123; <span class="attr">text</span>: <span class="string">&quot;44 f&quot;</span>, <span class="attr">key</span>: <span class="string">&quot;f&quot;</span> &#125;,</span><br><span class="line">  ]);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">ul</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        &#123;list.map((item) =&gt; &#123;</span></span><br><span class="line"><span class="language-xml">          return item ? <span class="tag">&lt;<span class="name">li</span> <span class="attr">key</span>=<span class="string">&#123;item.key&#125;</span>&gt;</span>&#123;item.text&#125;<span class="tag">&lt;/<span class="name">li</span>&gt;</span> : null;</span></span><br><span class="line"><span class="language-xml">        &#125;)&#125;</span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">button</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">        <span class="attr">onClick</span>=<span class="string">&#123;()</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-xml">          debugger;</span></span><br><span class="line"><span class="language-xml">          setList((prev) =&gt; &#123;</span></span><br><span class="line"><span class="language-xml">            let newArr: ListItemType[] = [];</span></span><br><span class="line"><span class="language-xml">            // ç‚¹å‡»æŒ‰é’®ä¹‹åï¼Œéšæœºåˆ é™¤ä¸€ä¸ªlièŠ‚ç‚¹ï¼ŒéšæœºæŒ‘é€‰ä¸€ä¸ªèŠ‚ç‚¹æ”¾åˆ°ç¬¬ä¸€è¡Œ</span></span><br><span class="line"><span class="language-xml">            prev.splice(Math.floor(Math.random() * 5), 1);</span></span><br><span class="line"><span class="language-xml">            newArr.push(...prev.splice(Math.floor(Math.random() * 4), 1));</span></span><br><span class="line"><span class="language-xml">            newArr = newArr.concat(prev);</span></span><br><span class="line"><span class="language-xml">            return newArr;</span></span><br><span class="line"><span class="language-xml">          &#125;);</span></span><br><span class="line"><span class="language-xml">        &#125;&#125;</span></span><br><span class="line"><span class="language-xml">      &gt;</span></span><br><span class="line"><span class="language-xml">        random all</span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h2 id="Diffè§£æ"><a href="#Diffè§£æ" class="headerlink" title="Diffè§£æ"></a>Diffè§£æ</h2><h3 id="Debugæ—¶æœº"><a href="#Debugæ—¶æœº" class="headerlink" title="Debugæ—¶æœº"></a>Debugæ—¶æœº</h3><ul><li><strong>é¦–æ¬¡æ¸²æŸ“ä¹‹å</strong>ï¼Œç‚¹å‡»<code>random all</code>æŒ‰é’®éšæœºå¤„ç†<code>state</code>ä¹‹åæ‰§è¡Œ<code>performSyncWorkOnRoot</code>å‡½æ•°æ—¶è¿›è¡ŒDebug</li><li><strong><code>Test</code>ç»„ä»¶æ ¹æ®<code>hook</code>è·å–æœ€æ–°çš„<code>state</code>ï¼Œåç»­å…ˆå¯¹Fiberæ›´æ–°</strong></li></ul><h3 id="reconcileChildren"><a href="#reconcileChildren" class="headerlink" title="reconcileChildren"></a>reconcileChildren</h3><ul><li><code>beginWork</code>å¯¹<code>ul</code>æ ‡ç­¾è¿›è¡Œå¤„ç†æ—¶ï¼Œ<strong>ä¼šå¯¹å…¶<code>children</code>è¿›è¡Œä¸€æ¬¡Diffæ“ä½œ</strong></li></ul><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">reconcileChildren</span>(<span class="params">current, workInProgress, nextChildren, renderLanes</span>) &#123;</span><br><span class="line">    <span class="comment">// currentæ˜¯å½“å‰å·²ç»æ¸²æŸ“è¿‡çš„Fiberï¼ˆworkInProcess.alternateï¼‰</span></span><br><span class="line">    <span class="keyword">if</span> (current === <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// è¿™ä¸ªæ˜¯åˆå§‹åŒ–æ—¶è¿›è¡Œçš„æ“ä½œ</span></span><br><span class="line">        workInProgress.<span class="property">child</span> = <span class="title function_">mountChildFibers</span>(workInProgress, <span class="literal">null</span>, nextChildren, renderLanes);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// è¿™ä¸ªæ˜¯Fiberå·²ç»å­˜åœ¨æ—¶çš„å¤„ç†ï¼ˆåç»­æ›´æ–°ï¼‰</span></span><br><span class="line">        workInProgress.<span class="property">child</span> = <span class="title function_">reconcileChildFibers</span>(workInProgress, current.<span class="property">child</span>, nextChildren, renderLanes);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><code>reconcileChildFibers</code>é’ˆå¯¹ä¸åŒçš„<code>child</code>è°ƒç”¨ä¸åŒçš„å‡½æ•°å»å¤„ç†<code>Fiber</code>ï¼Œ<strong>è¿™é‡Œæˆ‘ä»¬ä¸»è¦çœ‹ React å¯¹å¤šä¸ªåŒçº§DOMçš„åˆ é™¤ã€æ›´æ–°æ€ä¹ˆå¤„ç†çš„ï¼ˆDOM Diffï¼‰</strong></li></ul><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">reconcileChildFibers</span>(<span class="params">returnFiber, currentFirstChild, newChild, lanes</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> isObject = <span class="keyword">typeof</span> newChild === <span class="string">&#x27;object&#x27;</span> &amp;&amp; newChild !== <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (isObject) &#123;</span><br><span class="line">        <span class="keyword">switch</span> (newChild.<span class="property">$$typeof</span>) &#123;</span><br><span class="line">            <span class="comment">// è¿™é‡Œå¤„ç†å•ä¸ªchild</span></span><br><span class="line">            <span class="keyword">case</span> <span class="attr">REACT_ELEMENT_TYPE</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="title function_">placeSingleChild</span>(<span class="title function_">reconcileSingleElement</span>(returnFiber, currentFirstChild, newChild, lanes));</span><br><span class="line">   <span class="comment">// ......... ä¾‹å¦‚ï¼šFragment</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">// childæ˜¯å­—ç¬¦ä¸²æˆ–è€…æ•°å­—çš„å¤„ç†</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> newChild === <span class="string">&#x27;string&#x27;</span> || <span class="keyword">typeof</span> newChild === <span class="string">&#x27;number&#x27;</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">placeSingleChild</span>(<span class="title function_">reconcileSingleTextNode</span>(returnFiber, currentFirstChild, <span class="string">&#x27;&#x27;</span> + newChild, lanes));</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">// DOM Diff</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_">isArray$1</span>(newChild)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">reconcileChildrenArray</span>(returnFiber, currentFirstChild, newChild, lanes);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">// ...........å…¶ä»–ç±»å‹</span></span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">deleteRemainingChildren</span>(returnFiber, currentFirstChild);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="reconcileChildrenArray"><a href="#reconcileChildrenArray" class="headerlink" title="reconcileChildrenArray"></a>reconcileChildrenArray</h3><ul><li><strong><code>reconcileChildrenArray</code>å¯¹<code>childs</code>è¿›è¡Œå¤„ç†ï¼ˆåˆ›å»ºæˆ–è€…å¤ç”¨DOMï¼‰</strong></li><li>ç®—æ³•æµ…æå¦‚ä¸‹ï¼š</li></ul><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">reconcileChildrenArray</span>(<span class="params">returnFiber, currentFirstChild, newChildren, lanes</span>) &#123;</span><br><span class="line"><span class="comment">// é¦–å…ˆå¯¹æ¯ä¸ªchildçš„keyè¿›è¡ŒéªŒè¯ï¼Œæ˜¯å¦é‡å¤ç­‰</span></span><br><span class="line">    <span class="comment">// ä»£ç çœç•¥</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> resultingFirstChild = <span class="literal">null</span>; <span class="comment">// æœ€åè¿”å›çš„Fiberï¼Œç”¨äºæ„å»ºFiberæ ‘</span></span><br><span class="line">    <span class="keyword">var</span> previousNewFiber = <span class="literal">null</span>; <span class="comment">// ä¿å­˜éå†è¿‡ç¨‹ä¸­çš„ä¸Šä¸€ä¸ªnewFiber</span></span><br><span class="line">    <span class="keyword">var</span> oldFiber = currentFirstChild; <span class="comment">// ç¬¬ä¸€ä¸ªoldFiber</span></span><br><span class="line">    <span class="comment">// Reactåªå…è®¸DOMèŠ‚ç‚¹å¤ç”¨æ—¶å‘å³ç§»åŠ¨</span></span><br><span class="line">    <span class="comment">// åªè¦oldFiberçš„ä¸‹æ ‡æ¯”lastPlacedIndexå¤§ï¼Œå°±è¯´æ˜è¿™ä¸ªèŠ‚ç‚¹éœ€è¦å³ç§»</span></span><br><span class="line">    <span class="comment">// å…·ä½“ç®—æ³•çœ‹ placeChild è¿™ä¸ªå‡½æ•°</span></span><br><span class="line">    <span class="keyword">var</span> lastPlacedIndex = <span class="number">0</span>; <span class="comment">// æ ‡è®°newFiberä¸­æœ€æ–°å·²å¤„ç†èŠ‚ç‚¹çš„ä¸‹æ ‡</span></span><br><span class="line">    <span class="keyword">var</span> newIdx = <span class="number">0</span>; <span class="comment">// æ–°Childçš„ç´¢å¼•</span></span><br><span class="line">    <span class="keyword">var</span> nextOldFiber = <span class="literal">null</span>; <span class="comment">// ä¸‹ä¸€ä¸ªoldFiber</span></span><br><span class="line"><span class="comment">// ç¬¬ä¸€æ¬¡éå†ï¼ŒoldChildå’ŒnewChildåŒæ­¥éå†</span></span><br><span class="line">    <span class="comment">// æ¯”å¦‚ï¼šoldChild[0]å’ŒnewChild[0]å°è¯•æ˜¯å¦å¯ä»¥å¤ç”¨</span></span><br><span class="line">    <span class="keyword">for</span> (; oldFiber !== <span class="literal">null</span> &amp;&amp; newIdx &lt; newChildren.<span class="property">length</span>; newIdx++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (oldFiber.<span class="property">index</span> &gt; newIdx) &#123; <span class="comment">// æ—§èŠ‚ç‚¹åœ¨æ–°èŠ‚ç‚¹å³è¾¹ï¼Œä¸äº†è§£è¿™ç§æƒ…å†µä»€ä¹ˆæ—¶å€™å‘ç”Ÿ...</span></span><br><span class="line">            nextOldFiber = oldFiber;</span><br><span class="line">            oldFiber = <span class="literal">null</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">   <span class="comment">// è·å–ä¸‹ä¸ªæ—§èŠ‚ç‚¹ï¼Œæ¯”å¦‚oldChild[0]çš„siblingå°±æ˜¯oldChild[1]ï¼ŒFiberæ ‘çš„åŸå› </span></span><br><span class="line">            nextOldFiber = oldFiber.<span class="property">sibling</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="comment">// å°è¯•å¤ç”¨æ—§Fiber</span></span><br><span class="line">        <span class="comment">// updateSlotå†…éƒ¨é€šè¿‡æ£€æµ‹keyå€¼æ˜¯å¦ç›¸åŒæ¥åˆ¤æ–­æ˜¯å¦èƒ½å¤Ÿå¤ç”¨</span></span><br><span class="line">        <span class="comment">// å¦‚æœèƒ½å¤Ÿå¤ç”¨ï¼ŒoldFiberä¿ç•™ï¼Œå¹¶æ ¹æ®newChildæ›´æ–°ä¸‹å±æ€§å³å¯</span></span><br><span class="line">        <span class="comment">// åŒæ—¶è¿˜æœ‰å¤„ç†åˆ«çš„newFiberçš„ä»£ç ï¼Œæ¯”å¦‚newFiberæ˜¯ä¸ªtextNodeï¼Œæˆ–è€…newFiberæ˜¯ä¸ªFragment</span></span><br><span class="line">        <span class="keyword">var</span> newFiber = <span class="title function_">updateSlot</span>(returnFiber, oldFiber, newChildren[newIdx], lanes);</span><br><span class="line">    <span class="comment">//å¦‚æœä¸èƒ½å¤ç”¨ï¼ŒnewFiberä¸ºnullï¼Œæ­¤æ—¶ç›´æ¥è·³å‡ºç¬¬ä¸€æ¬¡å¾ªç¯</span></span><br><span class="line">        <span class="keyword">if</span> (newFiber === <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (oldFiber === <span class="literal">null</span>) &#123;</span><br><span class="line">                oldFiber = nextOldFiber;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="comment">// éœ€è¦åˆ é™¤è¿™ä¸ªFiber</span></span><br><span class="line">        <span class="keyword">if</span> (shouldTrackSideEffects) &#123; <span class="comment">// shouldTrackSideEffetcsåœ¨æ›´æ–°æ“ä½œä¸­å§‹ç»ˆä¸ºtrue</span></span><br><span class="line">            <span class="keyword">if</span> (oldFiber &amp;&amp; newFiber.<span class="property">alternate</span> === <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="title function_">deleteChild</span>(returnFiber, oldFiber);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="comment">//æ›´æ–°lastPlacedIndex</span></span><br><span class="line">        lastPlacedIndex = <span class="title function_">placeChild</span>(newFiber, lastPlacedIndex, newIdx);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è·å–ç¬¬ä¸€ä¸ªnewFiberç”¨äºæ„å»ºFiberæ ‘ï¼Œå¹¶å°†ä¸Šä¸€ä¸ªnewFiberçš„siblingæŒ‡å‘è¿™ä¸ªnewFiber</span></span><br><span class="line">        <span class="keyword">if</span> (previousNewFiber === <span class="literal">null</span>) &#123; <span class="comment">// ç¬¬ä¸€æ¬¡å¾ªç¯æ‰ä¼šè¿›å…¥è¿™ä¸ª</span></span><br><span class="line">            resultingFirstChild = newFiber;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            previousNewFiber.<span class="property">sibling</span> = newFiber;</span><br><span class="line">        &#125;</span><br><span class="line">   <span class="comment">// è¿›å…¥ä¸‹ä¸€æ¬¡å¾ªç¯ï¼Œæ›´æ–°æ ‡è¯†å˜é‡</span></span><br><span class="line">        previousNewFiber = newFiber;</span><br><span class="line">        oldFiber = nextOldFiber;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (newIdx === newChildren.<span class="property">length</span>) &#123;</span><br><span class="line">        <span class="comment">//.... æ–°Childéå†å®Œæ¯•ï¼Œè¯´æ˜å‰©ä¸‹çš„oldFiberåœ¨æ–°DOMæ ‘ä¸­ä¸å­˜åœ¨ï¼Œç›´æ¥åˆ é™¤ï¼ˆè¿™é‡Œåªæ˜¯æ ‡è®°ï¼ŒDOMæ“ä½œéƒ½åœ¨ commitRoot å‡½æ•°é‡Œï¼‰</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (oldFiber === <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">//.... æ—§Childéå†å®Œæ¯•ï¼Œè¯´æ˜å‰©ä¸‹çš„newFiberæ˜¯æ–°æ·»åŠ çš„ï¼Œæ²¡æœ‰å¯å¤ç”¨Fiberï¼Œç›´æ¥åˆ›å»ºFiberå³å¯</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// éå†æ—§Fiberåˆ›å»ºsetï¼Œé”®ä¸ºkeyå€¼ï¼Œå€¼ä¸ºFiber</span></span><br><span class="line">    <span class="keyword">var</span> existingChildren = <span class="title function_">mapRemainingChildren</span>(returnFiber, oldFiber);</span><br><span class="line"><span class="comment">// ç¬¬äºŒæ¬¡éå†ï¼Œå¯¹äºæ¯ä¸€ä¸ªnewChildï¼Œç›´æ¥ä»seté‡Œæ‰¾æœ‰æ²¡æœ‰keyå€¼ç›¸åŒå¯ä»¥å¤ç”¨çš„Fiber</span></span><br><span class="line">    <span class="keyword">for</span> (; newIdx &lt; newChildren.<span class="property">length</span>; newIdx++) &#123;</span><br><span class="line">        <span class="comment">// updateFromMap ç›´æ¥å»ä¸Šé¢ç”Ÿæˆçš„mapé‡Œé¢å»æ‰¾æœ‰æ²¡æœ‰keyå€¼ç›¸åŒçš„Fiberï¼Œå¦‚æœæœ‰ç›´æ¥å¤ç”¨ï¼Œå¦åˆ™ç›´æ¥æ–°å»ºä¸€ä¸ª</span></span><br><span class="line">        <span class="keyword">var</span> _newFiber2 = <span class="title function_">updateFromMap</span>(existingChildren, returnFiber, newIdx, newChildren[newIdx], lanes);</span><br><span class="line">    <span class="comment">// åˆ é™¤mapä¸­çš„oldFiber</span></span><br><span class="line">        <span class="keyword">if</span> (_newFiber2 !== <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (shouldTrackSideEffects) &#123;</span><br><span class="line">                <span class="keyword">if</span> (_newFiber2.<span class="property">alternate</span> !== <span class="literal">null</span>) &#123;</span><br><span class="line">                    existingChildren.<span class="title function_">delete</span>(_newFiber2.<span class="property">key</span> === <span class="literal">null</span> ? newIdx : _newFiber2.<span class="property">key</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">   <span class="comment">// æ›´æ–°lastPlacedIndex</span></span><br><span class="line">            lastPlacedIndex = <span class="title function_">placeChild</span>(_newFiber2, lastPlacedIndex, newIdx);</span><br><span class="line">  <span class="comment">// å’Œç¬¬ä¸€æ¬¡éå†æ—¶çš„æ“ä½œä¸€æ ·</span></span><br><span class="line">            <span class="keyword">if</span> (previousNewFiber === <span class="literal">null</span>) &#123;</span><br><span class="line">                resultingFirstChild = _newFiber2;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                previousNewFiber.<span class="property">sibling</span> = _newFiber2;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            previousNewFiber = _newFiber2;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">// åˆ é™¤æ²¡æœ‰ç”¨åˆ°çš„æ—§ChildFiber</span></span><br><span class="line">    <span class="keyword">if</span> (shouldTrackSideEffects) &#123;</span><br><span class="line">        existingChildren.<span class="title function_">forEach</span>(<span class="keyword">function</span> (<span class="params">child</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="title function_">deleteChild</span>(returnFiber, child);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> resultingFirstChild;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><strong>ä¸¤æ¬¡éå†</strong><ul><li><strong>ç¬¬ä¸€æ¬¡åŒæ­¥éå†æ‰¾å¯å¤ç”¨èŠ‚ç‚¹</strong></li><li><strong>ç¬¬äºŒæ¬¡åˆ©ç”¨<code>Set</code>æ‰¾å¯å¤ç”¨èŠ‚ç‚¹</strong></li></ul></li></ul><h3 id="placeChild"><a href="#placeChild" class="headerlink" title="placeChild"></a>placeChild</h3><ul><li><strong>ç”¨äºæ¯”è¾ƒ<code>newFiber</code>å’Œ<code>oldFiber</code>çš„<code>index</code>ï¼Œæ¥ç¡®å®š<code>newFiber</code>å…·ä½“çš„DOMæ“ä½œ</strong></li><li>ä»£ç è§£æå¦‚ä¸‹ï¼š</li></ul><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">placeChild</span>(<span class="params">newFiber, lastPlacedIndex, newIndex</span>) &#123;</span><br><span class="line">    newFiber.<span class="property">index</span> = newIndex; <span class="comment">// è®¾ç½®newFiberçš„index</span></span><br><span class="line">    <span class="keyword">if</span> (!shouldTrackSideEffects) &#123; <span class="comment">// åˆå§‹åŒ–æ—¶ä¸éœ€è¦æ ‡è®°èŠ‚ç‚¹æ˜¯å¦éœ€è¦ç§»åŠ¨</span></span><br><span class="line">        <span class="keyword">return</span> lastPlacedIndex;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">var</span> current = newFiber.<span class="property">alternate</span>; <span class="comment">// oldFiber</span></span><br><span class="line">    <span class="keyword">if</span> (current !== <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> oldIndex = current.<span class="property">index</span>; <span class="comment">// oldFiberä¸‹æ ‡</span></span><br><span class="line">        <span class="keyword">if</span> (oldIndex &lt; lastPlacedIndex) &#123;</span><br><span class="line">            <span class="comment">// æ—§èŠ‚ç‚¹åœ¨æœ€æ–°èŠ‚ç‚¹ä¸‹æ ‡å·¦è¾¹ï¼Œè¯´æ˜åœ¨æ–°DOMä¸­éœ€è¦å³ç§»</span></span><br><span class="line">            newFiber.<span class="property">flags</span> = <span class="title class_">Placement</span>; <span class="comment">// æ ‡è®°</span></span><br><span class="line">            <span class="keyword">return</span> lastPlacedIndex;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// è¿”å›è¦†ç›–lastPlacedIndex</span></span><br><span class="line">            <span class="keyword">return</span> oldIndex; <span class="comment">// è¿™ä¸ªèŠ‚ç‚¹ä¸éœ€è¦ç§»åŠ¨ï¼Œåœ¨æ›´æ–°åçš„DOMæ ‘ä¸­ä¿æŒåŸä½å³å¯(å› ä¸ºReactä¸­åŒçº§DOMèŠ‚ç‚¹Diffæ—¶åªå³ç§»)ï¼Œæ ‡è®°ä¸‹è¿™æ˜¯æ–°DOMä¸­æœ€æ–°Fiberçš„index</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// æ’å…¥æ“ä½œ</span></span><br><span class="line">        newFiber.<span class="property">flags</span> = <span class="title class_">Placement</span>;</span><br><span class="line">        <span class="keyword">return</span> lastPlacedIndex;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="commitMutationEffects"><a href="#commitMutationEffects" class="headerlink" title="commitMutationEffects"></a>commitMutationEffects</h3><ul><li><strong><code>commitRoot</code>é˜¶æ®µç”¨äºæ›´æ–°çœŸå®DOMçš„å‡½æ•°ï¼Œçœ‹ä¸‹<code>Diff</code>é˜¶æ®µæ ‡è®°Fiberä¹‹åï¼ŒçœŸå®DOMæ€ä¹ˆæ“ä½œ</strong></li><li><strong><code>nextEffect</code>æ„æˆä¸€ä¸ªæ›´æ–°é“¾ï¼ˆæ‰€æœ‰éœ€è¦æ“ä½œçš„Fiberä¼šå½¢æˆä¸€ä¸ªé“¾è¡¨ï¼Œä¸€ä¸ªæ¥ä¸€ä¸ªå¤„ç†ï¼‰ï¼Œè¿˜æ²¡ææ‡‚è¿™ä¸ªæ ¹æ®ä»€ä¹ˆé¡ºåºè¿æ¥èµ·æ¥â€¦â€¦</strong></li><li>å·²çœç•¥éƒ¨åˆ†ä»£ç </li></ul><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">commitMutationEffects</span>(<span class="params">root, renderPriorityLevel</span>) &#123;</span><br><span class="line">  <span class="keyword">while</span> (nextEffect !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="title function_">setCurrentFiber</span>(nextEffect); <span class="comment">// nextEffect å°±æ˜¯éœ€è¦æ›´æ–°çš„Fiber</span></span><br><span class="line">    <span class="keyword">var</span> flags = nextEffect.<span class="property">flags</span>; <span class="comment">// flags Fiberçš„æ ‡è®°ï¼Œæ¯”å¦‚placeChildè®¾ç½®çš„ç§»åŠ¨æ ‡è®°</span></span><br><span class="line">    <span class="keyword">var</span> primaryFlags = flags &amp; (<span class="title class_">Placement</span> | <span class="title class_">Update</span> | <span class="title class_">Deletion</span> | <span class="title class_">Hydrating</span>); <span class="comment">// è®¡ç®—flags</span></span><br><span class="line">    <span class="keyword">switch</span> (primaryFlags) &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="title class_">Placement</span>:</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="title function_">commitPlacement</span>(nextEffect); <span class="comment">// ç§»åŠ¨èŠ‚ç‚¹çš„å‡½æ•°</span></span><br><span class="line">          nextEffect.<span class="property">flags</span> &amp;= ~<span class="title class_">Placement</span>;</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      <span class="keyword">case</span> <span class="title class_">PlacementAndUpdate</span>:</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">      <span class="keyword">case</span> <span class="title class_">Hydrating</span>:</span><br><span class="line">       <span class="comment">// ...</span></span><br><span class="line">      <span class="keyword">case</span> <span class="title class_">HydratingAndUpdate</span>:</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">      <span class="keyword">case</span> <span class="title class_">Update</span>:</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">      <span class="keyword">case</span> <span class="title class_">Deletion</span>:</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">resetCurrentFiber</span>();</span><br><span class="line">    nextEffect = nextEffect.<span class="property">nextEffect</span>; <span class="comment">// è·å–ä¸‹ä¸€ä¸ªéœ€è¦æ›´æ–°çš„Fiber</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="commitPlacement"><a href="#commitPlacement" class="headerlink" title="commitPlacement"></a>commitPlacement</h3><ul><li><strong><code>commitPlacement</code>å‡½æ•°å†…éƒ¨çœŸæ­£è°ƒç”¨DOMæ“ä½œå¤„ç†DOMèŠ‚ç‚¹</strong></li><li>å·²çœç•¥éƒ¨åˆ†ä»£ç </li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">commitPlacement</span>(<span class="params">finishedWork</span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> parentFiber = <span class="title function_">getHostParentFiber</span>(finishedWork); <span class="comment">// è·å–çˆ¶çº§DOMï¼Œæœ¬DEMOä¸­å°±æ˜¯ ul èŠ‚ç‚¹</span></span><br><span class="line">  <span class="keyword">var</span> parent;</span><br><span class="line">  <span class="keyword">var</span> isContainer;</span><br><span class="line">  <span class="keyword">var</span> parentStateNode = parentFiber.<span class="property">stateNode</span>; <span class="comment">// è·å–çˆ¶èŠ‚ç‚¹çš„çœŸå®DOM</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">switch</span> (parentFiber.<span class="property">tag</span>) &#123; <span class="comment">//æ ¹æ®çˆ¶èŠ‚ç‚¹ç±»å‹ï¼Œè®¾ç½®å˜é‡</span></span><br><span class="line">    <span class="keyword">case</span> <span class="title class_">HostComponent</span>: <span class="comment">// æœ¬DEMOä¸­ä¼šèµ°è¿™ä¸ª</span></span><br><span class="line">      parent = parentStateNode;</span><br><span class="line">      isContainer = <span class="literal">false</span>;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="title class_">HostRoot</span>:</span><br><span class="line">      <span class="comment">//...</span></span><br><span class="line">    <span class="keyword">case</span> <span class="title class_">HostPortal</span>:</span><br><span class="line">      <span class="comment">//...</span></span><br><span class="line">    <span class="keyword">case</span> <span class="title class_">FundamentalComponent</span>:</span><br><span class="line">      <span class="comment">//...</span></span><br><span class="line">    <span class="attr">default</span>:</span><br><span class="line">      <span class="comment">// ... æ²¡æ‰¾åˆ°åˆé€‚çš„èŠ‚ç‚¹ç±»å‹è€ŒæŠ¥é”™</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> before = <span class="title function_">getHostSibling</span>(finishedWork); <span class="comment">// è·å–Fiberçš„siblingé“¾ä¸­ç¬¬ä¸€ä¸ªflagsä¸æ˜¯Placementçš„èŠ‚ç‚¹(å³ä¸éœ€è¦ç§»åŠ¨çš„èŠ‚ç‚¹)</span></span><br><span class="line">  <span class="keyword">if</span> (isContainer) &#123;</span><br><span class="line">    <span class="title function_">insertOrAppendPlacementNodeIntoContainer</span>(finishedWork, before, parent);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// æœ¬DEMOè°ƒç”¨è¿™ä¸ªå‡½æ•°</span></span><br><span class="line">    <span class="title function_">insertOrAppendPlacementNode</span>(finishedWork, before, parent);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><strong>æœ€åçš„<code>insertOrAppendPlacementNode</code>ä¼šæ ¹æ®<code>before</code>å˜é‡æ˜¯å¦å­˜åœ¨æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š</strong><ul><li><strong><code>before</code>å­˜åœ¨ï¼Œç›´æ¥è°ƒç”¨<code>parent.insertBefore(current,before)</code>å°†<code>current</code>æ”¾åˆ°<code>before</code>ä¹‹å‰</strong></li><li><strong><code>before</code>ä¸å­˜åœ¨ï¼Œç›´æ¥è°ƒç”¨<code>parent.appendChild(current)</code></strong></li></ul></li></ul>]]></content>
      
      
      <categories>
          
          <category> React </category>
          
      </categories>
      
      
        <tags>
            
            <tag> React </tag>
            
            <tag> Diff </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ReactSourceHookDebug</title>
      <link href="/2022/03/27/ReactSourceHookDebug/"/>
      <url>/2022/03/27/ReactSourceHookDebug/</url>
      
        <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><ul><li>Reactæºç ç‰ˆæœ¬ï¼š<code>17.0.2</code></li><li>Debug Demo å¦‚ä¸‹ï¼š</li></ul><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">Test</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> [num, setNum] = <span class="title function_">useState</span>(<span class="number">0</span>);</span><br><span class="line">  <span class="title function_">useEffect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;effect!&quot;</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">button</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">      <span class="attr">onClick</span>=<span class="string">&#123;()</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-xml">        setNum((prev) =&gt; &#123;</span></span><br><span class="line"><span class="language-xml">          return prev + 1;</span></span><br><span class="line"><span class="language-xml">        &#125;);</span></span><br><span class="line"><span class="language-xml">      &#125;&#125;</span></span><br><span class="line"><span class="language-xml">    &gt;</span></span><br><span class="line"><span class="language-xml">      &#123;num&#125;</span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><ul><li><strong>æœ¬æ–‡ç« è®°å½•å­¦ä¹ React Hookæºç æ—¶çš„ä¸€äº›æ”¶è·</strong></li></ul><h2 id="Hookæµç¨‹"><a href="#Hookæµç¨‹" class="headerlink" title="Hookæµç¨‹"></a>Hookæµç¨‹</h2><h3 id="beginWork"><a href="#beginWork" class="headerlink" title="beginWork"></a>beginWork</h3><ul><li>è·³è¿‡<code>rootContainer</code>çš„åˆ›å»ºï¼Œlanesç®—æ³•åˆå§‹åŒ–ç­‰ç­‰ä»£ç ï¼Œé¦–å…ˆå…³æ³¨<code>&lt;Test /&gt;</code>ç»„ä»¶çš„Fiberåˆå§‹åŒ–ï¼Œæ ¹æ®DEMOï¼Œ<strong>æ­¤æ—¶<code>beginWork</code>å·²ç»å¤„ç†rootFiberå¹¶åˆ›å»ºäº†<code>&lt;Test /&gt;</code>ç»„ä»¶çš„Fiber</strong>ï¼Œç°åœ¨è¦å¯¹å…¶è¿›è¡Œåˆå§‹åŒ–</li></ul><p>æ­¤æ—¶<code>&lt;Test /&gt;</code>çš„Fiberï¼ˆå·²çœç•¥éƒ¨åˆ†å±æ€§ï¼‰</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">tag</span>: <span class="number">2</span>,</span><br><span class="line">  <span class="attr">key</span>: <span class="literal">null</span>,</span><br><span class="line">  <span class="comment">/*å¯ä»¥çœ‹åˆ°webpackå¤„ç†åçš„Testå‡½æ•°ä¸­çš„JSXéƒ½è¢«jsxDevè§£æå‡½æ•°åŒ…è£¹*/</span></span><br><span class="line">  <span class="attr">elementType</span>: <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="title function_">_s</span>();</span><br><span class="line">    <span class="keyword">const</span> [num, setNum] = (<span class="number">0</span>,react__WEBPACK_IMPORTED_MODULE_0__.<span class="property">useState</span>)(<span class="number">0</span>);</span><br><span class="line">    (<span class="number">0</span>,react__WEBPACK_IMPORTED_MODULE_0__.<span class="property">useEffect</span>)(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">debugger</span>;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;effect!&quot;</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> <span class="comment">/*#__PURE__*/</span>(<span class="number">0</span>,react_jsx_dev_runtime__WEBPACK_IMPORTED_MODULE_4__.<span class="property">jsxDEV</span>)(<span class="string">&quot;button&quot;</span>, &#123;</span><br><span class="line">      <span class="attr">onClick</span>: <span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">debugger</span>;</span><br><span class="line">        <span class="title function_">setNum</span>(<span class="function"><span class="params">prev</span> =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">return</span> prev + <span class="number">1</span>;</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">children</span>: num</span><br><span class="line">    &#125;, <span class="built_in">void</span> <span class="number">0</span>, <span class="literal">false</span>, &#123;</span><br><span class="line">      <span class="attr">fileName</span>: _jsxFileName,</span><br><span class="line">      <span class="attr">lineNumber</span>: <span class="number">59</span>,</span><br><span class="line">      <span class="attr">columnNumber</span>: <span class="number">5</span></span><br><span class="line">    &#125;, <span class="literal">undefined</span>);</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">type</span>: <span class="function">() =&gt;</span> &#123;<span class="comment">/*webpackå¤„ç†åçš„Testå‡½æ•°å’ŒelementTypeä¸€è‡´*/</span>&#125;,</span><br><span class="line">  <span class="attr">stateNode</span>: <span class="literal">null</span>,</span><br><span class="line">  <span class="attr">return</span>: &#123;<span class="comment">/*rootFiber*/</span>&#125;,</span><br><span class="line">  <span class="attr">child</span>: <span class="literal">null</span>,</span><br><span class="line">  <span class="attr">sibling</span>: <span class="literal">null</span>,</span><br><span class="line">  <span class="attr">index</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">ref</span>: <span class="literal">null</span>,</span><br><span class="line">  <span class="attr">pendingProps</span>: &#123;&#125;,</span><br><span class="line">  <span class="attr">memoizedProps</span>: <span class="literal">null</span>,</span><br><span class="line">  <span class="attr">updateQueue</span>: <span class="literal">null</span>,</span><br><span class="line">  <span class="attr">memoizedState</span>: <span class="literal">null</span>,</span><br><span class="line">  <span class="attr">dependencies</span>: <span class="literal">null</span>,</span><br><span class="line">  <span class="attr">mode</span>: <span class="number">8</span>,</span><br><span class="line">  <span class="attr">flags</span>: <span class="number">2</span>,</span><br><span class="line">  <span class="attr">nextEffect</span>: <span class="literal">null</span>,</span><br><span class="line">  <span class="attr">firstEffect</span>: <span class="literal">null</span>,</span><br><span class="line">  <span class="attr">lastEffect</span>: <span class="literal">null</span>,</span><br><span class="line">  <span class="attr">alternate</span>: <span class="literal">null</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ­¤æ—¶çš„è°ƒç”¨æ ˆ</p><img src="/2022/03/27/ReactSourceHookDebug/11.png" class="" title="è°ƒç”¨æ ˆ"><ul><li>Fiberçš„tagä¸º2ï¼Œç”±å¦‚ä¸‹æºç å¯çŸ¥ï¼Œæ˜¯å› ä¸ºReactè¿˜ä¸çŸ¥é“æ˜¯<code>class</code>è¿˜æ˜¯<code>function</code></li></ul><blockquote><p>var IndeterminateComponent &#x3D; 2; <em>&#x2F;&#x2F; Before we know whether it is function or class</em></p></blockquote><h3 id="renderWithHooks"><a href="#renderWithHooks" class="headerlink" title="renderWithHooks"></a>renderWithHooks</h3><ul><li>åç»­è°ƒç”¨å‡½æ•°å»ä¸“é—¨å¤„ç†tagä¸º2çš„ç»„ä»¶ï¼Œä»¥ä¸‹æ˜¯Reactåˆ¤æ–­ç»„ä»¶æ—¶<code>class</code>è¿˜æ˜¯<code>function</code>çš„ä»£ç </li></ul><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="title class_">Component</span>.<span class="property"><span class="keyword">prototype</span></span> &amp;&amp; <span class="keyword">typeof</span> <span class="title class_">Component</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">render</span> === <span class="string">&#x27;function&#x27;</span>)&#123;</span><br><span class="line">    <span class="comment">//æ˜¯classç»„ä»¶ï¼Œ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>ç„¶åä¿å­˜Fiberè¿›è¡Œå¤„ç†</li></ul><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">ReactCurrentOwner</span>$<span class="number">1.</span>current = workInProgress; <span class="comment">// workInProgress å°±æ˜¯å½“å‰å¤„ç†çš„Fiber</span></span><br><span class="line">value = <span class="title function_">renderWithHooks</span>(<span class="literal">null</span>, workInProgress, <span class="title class_">Component</span>, props, context, renderLanes);</span><br></pre></td></tr></table></figure><ul><li><strong>ä¹‹åä¼šè°ƒç”¨è¿™ä¸ªä»£ç ï¼Œä¸ºå½“å‰ç¯å¢ƒè®¾ç½®hookï¼Œä¹‹åä¼šä½¿ç”¨<code>throwError</code>ç‰ˆæœ¬è¦†ç›–ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆhookåªèƒ½åœ¨<code>function</code>ç»„ä»¶ä¸­ä½¿ç”¨çš„åŸå› </strong></li></ul><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">ReactCurrentDispatcher</span>$<span class="number">1.</span>current = <span class="title class_">HooksDispatcherOnMountInDEV</span>;</span><br><span class="line"><span class="comment">// è€ŒHooksDispatchOnMountInDEVåˆ™ä¿å­˜äº†æ‰€æœ‰Reactçš„hookï¼ˆå½“ç„¶ä¹Ÿæœ‰updateç‰ˆæœ¬ï¼‰</span></span><br></pre></td></tr></table></figure><p>ä¸‹å›¾ä¸ºéƒ¨åˆ†hook</p><img src="/2022/03/27/ReactSourceHookDebug/22.png" class="" title="éƒ¨åˆ†hook"><ul><li>ä¹‹åè°ƒç”¨<code>function</code>ç»„ä»¶ï¼Œæ‰§è¡Œç”¨æˆ·ä»£ç ï¼Œè·å–<code>child</code></li></ul><p>è°ƒç”¨æ ˆå¦‚å›¾</p><img src="/2022/03/27/ReactSourceHookDebug/33.png" class="" title="è°ƒç”¨æ ˆ"><h3 id="useState"><a href="#useState" class="headerlink" title="useState"></a>useState</h3><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// useStateæºç  çœç•¥éƒ¨åˆ†æºç </span></span><br><span class="line"><span class="attr">useState</span>: <span class="keyword">function</span> (<span class="params">initialState</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> prevDispatcher = <span class="title class_">ReactCurrentDispatcher</span>$<span class="number">1.</span>current; <span class="comment">// è¿™é‡Œå°±ä¼šè·å–æ­£å¸¸è¿è¡Œçš„Hookä»£ç </span></span><br><span class="line">    <span class="title class_">ReactCurrentDispatcher</span>$<span class="number">1.</span>current = <span class="title class_">InvalidNestedHooksDispatcherOnMountInDEV</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">mountState</span>(initialState); <span class="comment">// useStateä¸»è¦æ‰§è¡Œçš„é€»è¾‘</span></span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="title class_">ReactCurrentDispatcher</span>$<span class="number">1.</span>current = prevDispatcher;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>æ¥å—ç”¨æˆ·çš„å€¼ä½œä¸º<code>initialState</code>ï¼Œå¹¶æœ€åè°ƒç”¨<code>mountState</code></li></ul><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//mountState æºç </span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">mountState</span>(<span class="params">initialState</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> hook = <span class="title function_">mountWorkInProgressHook</span>(); <span class="comment">// ç”Ÿæˆhookå¯¹è±¡</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> initialState === <span class="string">&#x27;function&#x27;</span>) &#123; <span class="comment">// å¦‚æœinitialStateæ˜¯å‡½æ•°ï¼Œå°±ä¼šæ‰§è¡Œå¹¶è·å–è¿”å›å€¼</span></span><br><span class="line">        <span class="comment">// $FlowFixMe: Flow doesn&#x27;t like mixed types</span></span><br><span class="line">        initialState = <span class="title function_">initialState</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    hook.<span class="property">memoizedState</span> = hook.<span class="property">baseState</span> = initialState; <span class="comment">// è·å–åˆå§‹å€¼ï¼Œå¹¶ä¿å­˜ï¼ˆé—­åŒ…ï¼‰</span></span><br><span class="line">    <span class="keyword">var</span> queue = hook.<span class="property">queue</span> = &#123;</span><br><span class="line">        <span class="attr">pending</span>: <span class="literal">null</span>,</span><br><span class="line">        <span class="attr">dispatch</span>: <span class="literal">null</span>,</span><br><span class="line">        <span class="attr">lastRenderedReducer</span>: basicStateReducer, <span class="comment">// æ›´æ–°å‡½æ•°</span></span><br><span class="line">        <span class="attr">lastRenderedState</span>: initialState</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">var</span> dispatch = queue.<span class="property">dispatch</span> = dispatchAction.<span class="title function_">bind</span>(<span class="literal">null</span>, currentlyRenderingFiber$<span class="number">1</span>, queue); <span class="comment">// useStateè¿”å›çš„æ›´æ–°å‡½æ•°ï¼Œå·²ç»ç¡¬ç»‘å®šäº†2ä¸ªå‚æ•°</span></span><br><span class="line">    <span class="keyword">return</span> [hook.<span class="property">memoizedState</span>, dispatch]; <span class="comment">// è¿”å›å½¢å¼ï¼Œä¹Ÿæ˜¯ä¸ºä»€ä¹ˆä½¿ç”¨ const [val,setVal] = useState(0); çš„åŸå› </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><p>é¦–å…ˆåˆå§‹åŒ–hookå¯¹è±¡ï¼Œç”¨æ¥ä¿å­˜<code>state</code>æ•°æ®ã€è°ƒç”¨é˜Ÿåˆ—ç­‰</p></li><li><p><strong><code>dispatch</code>å‡½æ•°ç»‘å®šäº†å½“å‰Fiberï¼Œå¹¶ä¸”è°ƒç”¨<code>lastRenderedReducer</code>ï¼ˆä¹Ÿå°±æ˜¯<code>basicStateReducer</code>ï¼‰ï¼Œæœ€åè¿›è¡Œ<code>scheduleUpdateOnFiber</code>ï¼ˆå‘èµ·è°ƒåº¦æ›´æ–°ï¼‰</strong></p></li></ul><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å·²çœç•¥å¤§éƒ¨åˆ†ä»£ç </span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">dispatchAction</span>(<span class="params">fiber, queue, action</span>) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">var</span> currentState = queue.<span class="property">lastRenderedState</span>; <span class="comment">// è·å–ä¿å­˜çš„state</span></span><br><span class="line">        <span class="keyword">var</span> eagerState = <span class="title function_">lastRenderedReducer</span>(currentState, action); <span class="comment">// è·å–æ–°çš„state</span></span><br><span class="line"><span class="comment">// å‡†å¤‡update</span></span><br><span class="line">        update.<span class="property">eagerReducer</span> = lastRenderedReducer;</span><br><span class="line">        update.<span class="property">eagerState</span> = eagerState;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;<span class="comment">// Suppress the error. It will throw again in the render phase.</span></span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="title class_">ReactCurrentDispatcher</span>$<span class="number">1.</span>current = prevDispatcher;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">// æ‰§è¡Œè°ƒåº¦æ›´æ–°</span></span><br><span class="line">    <span class="title function_">scheduleUpdateOnFiber</span>(fiber, lane, eventTime);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><strong><code>action</code>æ˜¯ç”¨æˆ·ä¼ å…¥çš„å‡½æ•°ï¼Œä»¥ä¸‹æ˜¯<code>lastRenderReducer</code>æºç ï¼Œæ‰€ä»¥å‡½æ•°å†…éƒ¨å¯ä»¥è·å–ä¹‹å‰çš„state</strong></li></ul><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">basicStateReducer</span>(<span class="params">state, action</span>) &#123;</span><br><span class="line">  <span class="comment">// $FlowFixMe: Flow doesn&#x27;t like mixed types</span></span><br><span class="line">  <span class="comment">// å¦‚æœæ˜¯å‡½æ•°ï¼Œå°±ä¼ å…¥ä¹‹å‰stateå¹¶è°ƒç”¨ï¼Œå¦åˆ™ç›´æ¥ä½¿ç”¨æ–°çš„state</span></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">typeof</span> action === <span class="string">&#x27;function&#x27;</span> ? <span class="title function_">action</span>(state) : action;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="useEffect"><a href="#useEffect" class="headerlink" title="useEffect"></a>useEffect</h3><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// useEffectæºç </span></span><br><span class="line"><span class="attr">useEffect</span>: <span class="keyword">function</span> (<span class="params">create, deps</span>) &#123;</span><br><span class="line">    currentHookNameInDev = <span class="string">&#x27;useEffect&#x27;</span>;</span><br><span class="line">    <span class="title function_">mountHookTypesDev</span>(); <span class="comment">// æ·»åŠ  hookName åˆ° hookTpyeDev</span></span><br><span class="line">    <span class="title function_">checkDepsAreArrayDev</span>(deps); <span class="comment">// æ£€æŸ¥useEffectçš„depsæ ¼å¼æ˜¯å¦ä¸ºæ•°ç»„</span></span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">mountEffect</span>(create, deps); <span class="comment">// useEffectçš„ä¸»è¦é€»è¾‘</span></span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure><ul><li><code>mountEffect</code>æ£€æŸ¥ä¸€ä¸‹<code>jest</code>ä¼šè°ƒç”¨ä¸‹é¢è¿™ä¸ªå‡½æ•°ï¼Œæ‰§è¡Œé€»è¾‘</li></ul><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">mountEffectImpl</span>(<span class="params">fiberFlags, hookFlags, create, deps</span>) &#123;</span><br><span class="line">    <span class="comment">// createå°±æ˜¯ç”¨æˆ·è®¢é˜…çš„effectå‡½æ•°</span></span><br><span class="line">    <span class="keyword">var</span> hook = <span class="title function_">mountWorkInProgressHook</span>(); <span class="comment">// ç”Ÿæˆhookå¯¹è±¡</span></span><br><span class="line">    <span class="keyword">var</span> nextDeps = deps === <span class="literal">undefined</span> ? <span class="literal">null</span> : deps;</span><br><span class="line">    currentlyRenderingFiber$<span class="number">1.</span>flags |= fiberFlags;</span><br><span class="line">    hook.<span class="property">memoizedState</span> = <span class="title function_">pushEffect</span>(<span class="title class_">HasEffect</span> | hookFlags, create, <span class="literal">undefined</span>, nextDeps);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><code>hook</code>çš„<code>memoizedState</code>ä¸åŒäº<code>useState</code>ï¼Œ<code>useEffect</code>ä¼šè®°å½•å½“å‰çš„<code>create</code>å‡½æ•°ã€<code>deps</code>ä¾èµ–æ•°æ®å’Œè°ƒç”¨é¡ºåº</li></ul><h3 id="commitRoot"><a href="#commitRoot" class="headerlink" title="commitRoot"></a>commitRoot</h3><ul><li><code>commitRoot</code>åœ¨æ‰§è¡ŒæŒ‚è½½çœŸæ­£DOMæ ‘çš„æ“ä½œä¹‹å‰è¿˜ä¼šæ‰§è¡Œä¸€ä¸ªé¢å¤–çš„ç¨‹åº</li></ul><blockquote><p>invokeGuardedCallback(null, commitBeforeMutationEffects, null);</p></blockquote><ul><li><p><strong><code>invokeGuardedCallback</code>æ˜¯Reactä¸­ç”¨äº<code>DEV</code>ç¯å¢ƒä¸‹è§¦å‘äº‹ä»¶çš„ï¼Œé™„å¸¦æœ‰å„ç§é”™è¯¯æ•è·å’Œæ¶ˆæ¯æç¤º</strong></p></li><li><p>åœ¨ç»è¿‡ä¸€ç³»åˆ—æˆ‘çœ‹ä¸æ‡‚çš„è°ƒç”¨ä¹‹åï¼Œä¼šæ‰§è¡Œ<code>flushPassiveEffects</code>å‡½æ•°ï¼Œåœ¨è¿™ä¸ªå‡½æ•°å†…éƒ¨ä¼šæ‰§è¡Œç”¨æˆ·å®šä¹‰çš„<code>effectå‡½æ•°</code></p></li></ul><p>æ­¤æ—¶çš„è°ƒç”¨æ ˆ</p><img src="/2022/03/27/ReactSourceHookDebug/44.png" class="" title="è°ƒç”¨æ ˆ"><h3 id="commitBeforeMutationEffects"><a href="#commitBeforeMutationEffects" class="headerlink" title="commitBeforeMutationEffects"></a>commitBeforeMutationEffects</h3><ul><li>ç»è¿‡æµ‹è¯•åï¼Œdebugæ“ä½œä¸åŒï¼Œä¸‹é¢<code>flushPassiveEffects</code>å‡½æ•°è°ƒç”¨æ—¶æœºä¸åŒï¼Œè¿™é‡Œçœ‹å¾—å¾ˆè¿·ï¼ˆåº”è¯¥æ˜¯ä¸æ‡‚Reactè¯¦ç»†æ›´æ–°ç®—æ³•å’Œé€»è¾‘çš„é—®é¢˜ï¼‰<ul><li>å•æ­¥è¿›å…¥ï¼Œ<code>flushPassiveEffects</code>å‡½æ•°ä¼šåœ¨<code>commitBeforeMutationEffects</code>å‡½æ•°ä¸­ç›´æ¥æ‰§è¡Œ</li><li>å•æ­¥è·³è¿‡<code>commitBeforeMutationEffects</code>ï¼Œä¼šåœ¨Reactæ¸²æŸ“å®Œæˆä¹‹åå•ç‹¬æ‰§è¡Œ</li></ul></li></ul><h4 id="flushPassiveEffects"><a href="#flushPassiveEffects" class="headerlink" title="flushPassiveEffects"></a>flushPassiveEffects</h4><ul><li>çœç•¥äº†å…¶ä»–ä»£ç ï¼ˆä¾‹å¦‚ï¼šè¿™é‡Œè¿˜å¤„ç†äº†<code>unMountEffects</code>ï¼Œåªä¸è¿‡æ²¡æœ‰æ‰§è¡Œï¼‰</li></ul><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> mountEffects = pendingPassiveHookEffectsMount; <span class="comment">// è¿™é‡Œæ˜¯æ”¶é›†åˆ°çš„effectsï¼Œå¹¶ä¸”å®åœ¨mounté˜¶æ®µæ‰§è¡Œçš„effects</span></span><br><span class="line">pendingPassiveHookEffectsMount = [];</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">var</span> _i = <span class="number">0</span>; _i &lt; mountEffects.<span class="property">length</span>; _i += <span class="number">2</span>) &#123;</span><br><span class="line">    <span class="comment">// effectsæ•°ç»„æ¯ä¸¤ä¸ªä¸€ç»„ï¼Œå‰ä¸€ä¸ªæ˜¯effectsï¼Œåä¸€ä¸ªæ˜¯å½“å‰effectså¯¹åº”çš„fiber</span></span><br><span class="line">    <span class="keyword">var</span> _effect2 = mountEffects[_i];</span><br><span class="line">    <span class="keyword">var</span> _fiber = mountEffects[_i + <span class="number">1</span>];</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="title function_">setCurrentFiber</span>(_fiber); <span class="comment">// è®¾ç½®å½“å‰ç¯å¢ƒfiber</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// ä½¿ç”¨invokePassiveEffectCreateæ‰§è¡Œeffectså‡½æ•°</span></span><br><span class="line">            <span class="title function_">invokeGuardedCallback</span>(<span class="literal">null</span>, invokePassiveEffectCreate, <span class="literal">null</span>, _effect2);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_">hasCaughtError</span>()) &#123;</span><br><span class="line">            <span class="comment">// ...</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="title function_">resetCurrentFiber</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>å‡½æ•°æœ€åè¿˜ä¼šè°ƒç”¨ä¸‹é¢è¿™ä¸ªå‡½æ•°ï¼Œè¿™æ ·ä¼šå»æ¸…é™¤<code>syncQueue</code>é˜Ÿåˆ—å†…éƒ¨çš„æ›´æ–°äº‹ä»¶ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆå¦‚æœåœ¨<code>useEffect</code>ä¸­è®¾ç½®<code>state</code>ä¼šå¯¼è‡´æ— é™æ›´æ–°çš„åŸå› </li></ul><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">flushSyncCallbackQueue</span>(); </span><br><span class="line"><span class="comment">// è¿™ä¸ªå‡½æ•°å†…éƒ¨ä¼šè°ƒç”¨flushSyncCallbackQueue()</span></span><br></pre></td></tr></table></figure><h4 id="invokePassiveEffectCreate"><a href="#invokePassiveEffectCreate" class="headerlink" title="invokePassiveEffectCreate"></a>invokePassiveEffectCreate</h4><ul><li>çœŸæ­£æ‰§è¡Œ<code>effects</code>å‡½æ•°çš„ä»£ç </li></ul><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">invokePassiveEffectCreate</span>(<span class="params">effect</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> create = effect.<span class="property">create</span>;</span><br><span class="line">    effect.<span class="property">destroy</span> = <span class="title function_">create</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// effectså¦‚ä¸‹</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">tag</span>: <span class="number">5</span>, <span class="comment">// æ ‡è¯†hookç±»å‹</span></span><br><span class="line">  <span class="attr">create</span>: <span class="function">() =&gt;</span> &#123; <span class="comment">// è¿™ä¸ªå°±æ˜¯ç”¨æˆ·çš„effectå‡½æ•°</span></span><br><span class="line">    <span class="keyword">debugger</span>;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;effect!&quot;</span>);</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">destroy</span>: <span class="literal">undefined</span>, <span class="comment">// å­˜å‚¨å¯èƒ½å­˜åœ¨çš„é”€æ¯å‡½æ•°</span></span><br><span class="line">  <span class="attr">deps</span>: <span class="literal">null</span>, <span class="comment">// ä¾èµ–æ•°ç»„</span></span><br><span class="line">  <span class="attr">next</span>: [<span class="title class_">Circular</span>], <span class="comment">// ä¸‹ä¸€ä¸ªeffect</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="commitMutationEffects"><a href="#commitMutationEffects" class="headerlink" title="commitMutationEffects"></a>commitMutationEffects</h3><ul><li><strong>ä¹‹å‰è¯´è¿‡ï¼ŒReactåœ¨è¿™ä¸ªå‡½æ•°ä¸­æŠŠFiberæ ‘å¯¹åº”æ¸²æŸ“å¥½çš„çœŸå®DOMæ ‘æ·»åŠ åˆ°é¡µé¢ä¸Šï¼Œé™¤æ­¤ä¹‹å¤–è¿˜ä¼šæ‰§è¡Œä¸€æ¬¡ç‰¹å®š<code>effects</code></strong></li></ul><h4 id="commitHookEffectListUnmount"><a href="#commitHookEffectListUnmount" class="headerlink" title="commitHookEffectListUnmount"></a>commitHookEffectListUnmount</h4><ul><li><strong>æ‰§è¡Œæ‰€æœ‰<code>effects</code>çš„é”€æ¯å‡½æ•°ï¼Œå› ä¸ºç»„ä»¶è¿›è¡Œäº†ä¸€æ¬¡æ›´æ–°</strong></li></ul><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// éƒ¨åˆ†æºç </span></span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> ((effect.<span class="property">tag</span> &amp; tag) === tag) &#123;</span><br><span class="line">        <span class="comment">// Unmount</span></span><br><span class="line">        <span class="keyword">var</span> destroy = effect.<span class="property">destroy</span>; <span class="comment">// effect å¯¹è±¡</span></span><br><span class="line">        effect.<span class="property">destroy</span> = <span class="literal">undefined</span>;</span><br><span class="line">        <span class="keyword">if</span> (destroy !== <span class="literal">undefined</span>) &#123;</span><br><span class="line">          <span class="title function_">destroy</span>(); <span class="comment">// è¿™ä¸ªå°±æ˜¯é”€æ¯å‡½æ•°</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      effect = effect.<span class="property">next</span>; <span class="comment">// æ‰§è¡Œä¸‹ä¸€ä¸ªeffect</span></span><br><span class="line">    &#125; <span class="keyword">while</span> (effect !== firstEffect);</span><br></pre></td></tr></table></figure><h3 id="commitLayoutEffects"><a href="#commitLayoutEffects" class="headerlink" title="commitLayoutEffects"></a>commitLayoutEffects</h3><ul><li>åœ¨çœŸå®DOMæ¸²æŸ“å®Œæˆä¹‹åç±»ä¼¼æ–¹å¼è°ƒç”¨çš„å‡½æ•°</li></ul><blockquote><p>invokeGuardedCallback(null, commitLayoutEffects, null, root, lanes);</p></blockquote><h4 id="commitLifeCycles"><a href="#commitLifeCycles" class="headerlink" title="commitLifeCycles"></a>commitLifeCycles</h4><ul><li><p>å¦‚åŒå‡½æ•°åç§°ä¸€æ ·ï¼Œä¼šå¤„ç†å„ç§ç”Ÿå‘½å‘¨æœŸå‡½æ•°ï¼ˆåŒ…æ‹¬ï¼šeffectsï¼‰</p></li><li><p><code>commitHookEffectListMount</code>å‡½æ•°åœ¨æ»¡è¶³æŸç§æ¡ä»¶ä¸‹ï¼ˆæ²¡çœ‹æ‡‚â€¦ï¼‰ï¼Œæ‰§è¡Œ<code>effect</code>å‡½æ•°</p></li></ul><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// éƒ¨åˆ†æºç </span></span><br><span class="line"><span class="keyword">if</span> ((effect.<span class="property">tag</span> &amp; tag) === tag) &#123;</span><br><span class="line">    <span class="comment">// Mount</span></span><br><span class="line">    <span class="keyword">var</span> create = effect.<span class="property">create</span>;</span><br><span class="line">    effect.<span class="property">destroy</span> = <span class="title function_">create</span>();</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> destroy = effect.<span class="property">destroy</span>;</span><br><span class="line">        <span class="keyword">if</span> (destroy !== <span class="literal">undefined</span> &amp;&amp; <span class="keyword">typeof</span> destroy !== <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">            <span class="comment">// ... å¾ˆå¤šå¯¹è¿”å›çš„destroyå‡½æ•°ä½¿ç”¨ä¸å½“çš„warn</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="schedulePassiveEffects"><a href="#schedulePassiveEffects" class="headerlink" title="schedulePassiveEffects"></a>schedulePassiveEffects</h4><ul><li><code>schedulePassiveEffects</code>å‡½æ•°ä¼šå°†éœ€è¦æ‰§è¡Œçš„<code>effect</code>ä¿å­˜ä¸‹æ¥ï¼Œåœ¨åç»­è°ƒç”¨ï¼Ÿ</li></ul><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// éƒ¨åˆ†æºç </span></span><br><span class="line"><span class="keyword">do</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> _effect = effect,</span><br><span class="line">        next = _effect.<span class="property">next</span>,</span><br><span class="line">        tag = _effect.<span class="property">tag</span>;</span><br><span class="line">    <span class="keyword">if</span> ((tag &amp; <span class="title class_">Passive</span>$<span class="number">1</span>) !== <span class="title class_">NoFlags</span>$<span class="number">1</span> &amp;&amp; (tag &amp; <span class="title class_">HasEffect</span>) !== <span class="title class_">NoFlags</span>$<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="comment">// ä¸‹é¢ä¸¤ä¸ªå‡½æ•°åˆ†åˆ«å°†fiberå’Œhookå­˜å…¥pendingPassiveHookEffectsUnmountå’ŒpendingPassiveHookEffectsMount</span></span><br><span class="line">        <span class="comment">// è€ŒpendingPassiveHookEffectsMountå°±æ˜¯åœ¨flushPassiveEffectså‡½æ•°ä¸­è·å–effectçš„æ•°ç»„</span></span><br><span class="line">        <span class="title function_">enqueuePendingPassiveHookEffectUnmount</span>(finishedWork, effect);</span><br><span class="line">        <span class="title function_">enqueuePendingPassiveHookEffectMount</span>(finishedWork, effect);</span><br><span class="line">    &#125;</span><br><span class="line">    effect = next;</span><br><span class="line">&#125; <span class="keyword">while</span> (effect !== firstEffect);</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> React </category>
          
      </categories>
      
      
        <tags>
            
            <tag> React </tag>
            
            <tag> source </tag>
            
            <tag> javascript </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ReactSourceDebug</title>
      <link href="/2022/03/21/ReactSourceDebug/"/>
      <url>/2022/03/21/ReactSourceDebug/</url>
      
        <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><ul><li>Reactæºç ç‰ˆæœ¬ï¼š<code>17.0.2</code></li><li>Debug Demo å¦‚ä¸‹ï¼š</li></ul><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Test</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.Component</span>&lt;<span class="built_in">any</span>, &#123; <span class="attr">text</span>: <span class="built_in">string</span> &#125;&gt; &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">props: <span class="built_in">any</span></span>) &#123;</span><br><span class="line">    <span class="variable language_">super</span>(props);</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">state</span> = &#123;</span><br><span class="line">      <span class="attr">text</span>: <span class="string">&quot;hello&quot;</span>,</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">span</span>&gt;</span>&#123;this.state.text&#125;<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">span</span>&gt;</span>normal<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">button</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">          <span class="attr">onClick</span>=<span class="string">&#123;()</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-xml">            debugger;</span></span><br><span class="line"><span class="language-xml">            this.setState(&#123; text: &quot;check&quot; &#125;);</span></span><br><span class="line"><span class="language-xml">          &#125;&#125;</span></span><br><span class="line"><span class="language-xml">        &gt;</span></span><br><span class="line"><span class="language-xml">          setState</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title class_">ReactDOM</span>.<span class="title function_">render</span>(<span class="language-xml"><span class="tag">&lt;<span class="name">Test</span> /&gt;</span></span>, <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;root&quot;</span>));</span><br></pre></td></tr></table></figure><ul><li>æ ¹æ®DEMOï¼Œæœ¬æ¬¡å­¦ä¹ ä»…é’ˆå¯¹Reactåœ¨Webå±‚çš„æ¸²æŸ“<ul><li>é¡µé¢çš„åˆå§‹æ¸²æŸ“</li><li>ç‚¹å‡»æŒ‰é’®åçš„ä¸€æ¬¡æ›´æ–°æ¸²æŸ“</li></ul></li><li>è¾…åŠ©å­¦ä¹ æ–‡ç« â€”â€”<a href="https://www.zhihu.com/people/lam-14-21-74">Lamå¤§ä½¬çš„Reactæºç è§£ææ–‡ç« </a></li><li><strong>æœ¬æ–‡ä»…æ˜¯å­¦ä¹ è®°å½•ï¼Œè®°å½•ä¸€äº›æºç çš„ç†è§£ï¼Œå¹¶éè¯¦ç»†åˆ†ææºç </strong></li></ul><h2 id="åˆæ¬¡æ¸²æŸ“"><a href="#åˆæ¬¡æ¸²æŸ“" class="headerlink" title="åˆæ¬¡æ¸²æŸ“"></a>åˆæ¬¡æ¸²æŸ“</h2><h3 id="å…¥å£"><a href="#å…¥å£" class="headerlink" title="å…¥å£"></a>å…¥å£</h3><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">ReactDOM</span>.<span class="title function_">render</span>(<span class="language-xml"><span class="tag">&lt;<span class="name">Test</span> /&gt;</span></span>, <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;root&quot;</span>));</span><br></pre></td></tr></table></figure><ul><li>é€šè¿‡ä¼ å…¥å…¥å£ç»„ä»¶ï¼ˆé€šå¸¸æ˜¯<code>&lt;App /&gt;</code>ï¼‰è¿›è¡Œæ•´ä½“é¡µé¢çš„æ¸²æŸ“</li></ul><h3 id="JSXå¤„ç†"><a href="#JSXå¤„ç†" class="headerlink" title="JSXå¤„ç†"></a>JSXå¤„ç†</h3><ul><li>æ³¨æ„ä¸‹<code>webpack</code>å¯¹æ‰€æœ‰çš„JSXè¿›è¡Œäº†å¤„ç†ï¼Œæ¯”å¦‚å…¥å£ä»£æ‰“åŒ…æˆäº†è¿™æ ·</li></ul><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">react_dom__WEBPACK_IMPORTED_MODULE_1__.<span class="title function_">render</span>( <span class="comment">/*#__PURE__*/</span>(<span class="number">0</span>,react_jsx_dev_runtime__WEBPACK_IMPORTED_MODULE_4__.<span class="property">jsxDEV</span>)(<span class="title class_">Test</span>, &#123;&#125;, <span class="built_in">void</span> <span class="number">0</span>, <span class="literal">false</span>, &#123;</span><br><span class="line">  <span class="attr">fileName</span>: _jsxFileName,</span><br><span class="line">  <span class="attr">lineNumber</span>: <span class="number">52</span>,</span><br><span class="line">  <span class="attr">columnNumber</span>: <span class="number">17</span></span><br><span class="line">&#125;, <span class="literal">undefined</span>), <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;root&quot;</span>));</span><br></pre></td></tr></table></figure><ul><li>å¯ä»¥çœ‹åˆ°æ‰€æœ‰çš„JSXéƒ½åŒ…è£¹åœ¨äº†ä¸€ä¸ªå‡½æ•°ä¸­ï¼Œå‡½æ•°ä¸­æœ‰ä¸¤ä¸ªå…³é”®åŠ¨ä½œ<ul><li>å¯¹JSXå†™æ³•è¿›è¡ŒéªŒè¯ï¼Œæ˜¯å¦ç¬¦åˆè¯­æ³•</li><li>å¯¹JSXè¿›è¡Œè§£æ</li></ul></li></ul><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// DEMOä¸­çš„Testè§£æè¿”å›çš„ç»“æœ</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">$$typeof</span>: <span class="title class_">Symbol</span>(react.<span class="property">element</span>),</span><br><span class="line">  <span class="attr">type</span>: <span class="keyword">class</span> <span class="title class_">Test</span> <span class="comment">/* è¿™é‡Œçœç•¥Testçš„ç»“æ„ */</span>,</span><br><span class="line">  <span class="attr">key</span>: <span class="literal">null</span>,</span><br><span class="line">  <span class="attr">ref</span>: <span class="literal">null</span>,</span><br><span class="line">  <span class="attr">props</span>: &#123;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">_owner</span>: <span class="literal">null</span>,</span><br><span class="line">  <span class="attr">_store</span>: &#123;</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="render"><a href="#render" class="headerlink" title="render"></a>render</h3><ul><li>é¦–æ¬¡æ¸²æŸ“æ—¶ä¼šå»åˆ›å»º<code>root</code>ï¼ŒåŒæ—¶ä»£ç é¦–æ¬¡æ¶‰åŠåˆ°React16åŠ å…¥çš„<code>Fiber</code>æ•°æ®ç»“æ„</li></ul><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åˆ›å»ºFiberRootçš„å‡½æ•°</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">createFiberRoot</span>(<span class="params">containerInfo, tag, hydrate, hydrationCallbacks</span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> root = <span class="keyword">new</span> <span class="title class_">FiberRootNode</span>(containerInfo, tag, hydrate);</span><br><span class="line">  <span class="keyword">var</span> uninitializedFiber = <span class="title function_">createHostRootFiber</span>(tag);</span><br><span class="line">  root.<span class="property">current</span> = uninitializedFiber;</span><br><span class="line">  uninitializedFiber.<span class="property">stateNode</span> = root;</span><br><span class="line">  <span class="title function_">initializeUpdateQueue</span>(uninitializedFiber);</span><br><span class="line">  <span class="keyword">return</span> root;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é™„ä¸Šæ­¤æ—¶çš„è°ƒç”¨æ ˆ</p><img src="/2022/03/21/ReactSourceDebug/3.png" class="" title="è°ƒç”¨æ ˆ"><h4 id="Fiber"><a href="#Fiber" class="headerlink" title="Fiber"></a>Fiber</h4><ul><li>æºç æ•´ä½“Debugä¸‹æ¥ï¼Œæ¯ä¸€ä¸ªFiberå¯¹åº”<code>JSX</code>çš„æ¯ä¸€ä¸ªèŠ‚ç‚¹ï¼ˆä¸åŒäºçœŸå®DOMæ ‘ï¼‰ï¼ŒFiberæ ‘åŒ…æ‹¬äº†<code>&lt;App /&gt;</code>è¿™æ ·çš„ç»„ä»¶</li><li>Reactæ•´ä½“åŸºäºFiberæ ‘è¿›è¡Œæ›´æ–°ï¼Œå¯ä»¥è¯´Fiberæ ‘å°±æ˜¯Reactçš„è™šæ‹ŸDOM</li><li>Fiberæ ‘çš„ç»“æ„å¦‚ä¸‹ï¼Œä»¥DEMOä¸ºä¾‹ï¼š</li></ul><img src="/2022/03/21/ReactSourceDebug/1.png" class="" title="Fiberæ ‘ç»“æ„"><ul><li><p><strong>æ¯ä¸ªFiberåªæœ‰ä¸€ä¸ªçˆ¶èŠ‚ç‚¹ã€ä¸€ä¸ªå­èŠ‚ç‚¹ã€ä¸€ä¸ªå…„å¼ŸèŠ‚ç‚¹</strong>ï¼Œå¯èƒ½æ²¡æœ‰çˆ¶èŠ‚ç‚¹ï¼ˆrootï¼‰ï¼Œå¯èƒ½æ²¡æœ‰å­èŠ‚ç‚¹ï¼ˆä¸¤ä¸ªspanå’Œbuttonï¼‰ã€å¯èƒ½æ²¡æœ‰å…„å¼ŸèŠ‚ç‚¹ï¼Œä½†æœ‰ä¹Ÿä¸ä¼šè¶…è¿‡ä¸€ä¸ª</p><ul><li>æ‰€ä»¥Fiberæœ‰ä»¥ä¸‹çš„æ•°æ®ç»“æ„ï¼š</li></ul><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> <span class="title class_">Fiber</span> &#123;</span><br><span class="line">    <span class="attr">return</span>:<span class="title class_">FiberNode</span>, <span class="comment">//çˆ¶èŠ‚ç‚¹</span></span><br><span class="line">    <span class="attr">sibiling</span>:<span class="title class_">FiberNode</span>, <span class="comment">//å…„å¼ŸèŠ‚ç‚¹</span></span><br><span class="line">    <span class="attr">child</span>:<span class="title class_">FiberNode</span>, <span class="comment">//å­èŠ‚ç‚¹</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>FiberèŠ‚ç‚¹ä¸Šè®°å½•äº†å¯¹åº”èŠ‚ç‚¹çš„æ‰€æœ‰éœ€è¦æ¸²æŸ“çš„å±æ€§ï¼Œä¾‹å¦‚ï¼šrootFiberæœ‰ä¸‹é¢è¿™äº›å±æ€§ï¼ˆ<strong>æŸäº›å±æ€§æ˜¯rootFiberç‹¬æœ‰çš„</strong>ï¼‰ï¼š</p></li></ul><img src="/2022/03/21/ReactSourceDebug/2.png" class="" title="Fiberå±æ€§"><h4 id="äº‹ä»¶ç›‘å¬"><a href="#äº‹ä»¶ç›‘å¬" class="headerlink" title="äº‹ä»¶ç›‘å¬"></a>äº‹ä»¶ç›‘å¬</h4><ul><li>Reactä¼šåœ¨rootèŠ‚ç‚¹ä¸Šç›‘å¬æ‰€æœ‰å¯èƒ½çš„äº‹ä»¶</li></ul><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åˆ›å»ºrootFiberä¹‹åï¼Œè°ƒç”¨çš„ç›‘å¬å‡½æ•°</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">listenToAllSupportedEvents</span>(<span class="params">rootContainerElement</span>) &#123;</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> (rootContainerElement[listeningMarker]) &#123;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    rootContainerElement[listeningMarker] = <span class="literal">true</span>;</span><br><span class="line">    allNativeEvents.<span class="title function_">forEach</span>(<span class="keyword">function</span> (<span class="params">domEventName</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (!nonDelegatedEvents.<span class="title function_">has</span>(domEventName)) &#123;</span><br><span class="line">        <span class="title function_">listenToNativeEvent</span>(domEventName, <span class="literal">false</span>, rootContainerElement, <span class="literal">null</span>);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="title function_">listenToNativeEvent</span>(domEventName, <span class="literal">true</span>, rootContainerElement, <span class="literal">null</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><code>allNativeEvents</code>åŒ…å«äº†Reacté¢„å®šçš„æ‰€æœ‰äº‹ä»¶ï¼ŒReactå°†äº‹ä»¶åˆ†æˆäº†ä¸‰ç»„ï¼Œåˆ†ä¸ºä¸‰ç§ä¼˜å…ˆçº§ï¼Œä¾‹å¦‚ä¼˜å…ˆçº§æœ€ä½çš„ä¸€ç»„ä¸ºï¼š</li></ul><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> discreteEventPairsForSimpleEventPlugin = [<span class="string">&#x27;cancel&#x27;</span>, <span class="string">&#x27;cancel&#x27;</span>, <span class="string">&#x27;click&#x27;</span>, <span class="string">&#x27;click&#x27;</span>, <span class="string">&#x27;close&#x27;</span>, <span class="string">&#x27;close&#x27;</span>,<span class="comment">/*...å…¶ä½™å¥½å¤šäº‹ä»¶*/</span>];</span><br></pre></td></tr></table></figure><ul><li>åœ¨<code>root</code>ä¸Šç›‘å¬äº‹ä»¶ä¹‹åï¼Œæ‰€æœ‰äº‹ä»¶éƒ½ä¼šåœ¨<code>root</code>ä¸Šè§¦å‘å¯¹åº”å¤„ç†å‡½æ•°ï¼Œå¹¶åç»­è°ƒç”¨<code>dispatchEvent</code>å‡½æ•°ï¼Œ<strong>è¿™ä¸ªå‡½æ•°ä¼šç»Ÿä¸€è°ƒåº¦å’Œå¤„ç†æ‰€æœ‰äº‹ä»¶ï¼Œå¹¶åœ¨æœ€åè¿›è¡Œæ›´æ–°</strong></li></ul><h3 id="updateContainer"><a href="#updateContainer" class="headerlink" title="updateContainer"></a>updateContainer</h3><ul><li>æ›´æ–°ï¼ˆå¤„ç†Fiberï¼‰å‡½æ•°<ul><li><code>unbatchedUpdates</code>æ¶‰åŠåˆ°äº†Reactçš„åˆæˆäº‹ä»¶ç³»ç»Ÿï¼ˆæ²¡æœ‰è¯¦ç»†äº†è§£â€¦ï¼‰</li></ul></li></ul><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">unbatchedUpdates</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title function_">updateContainer</span>(children, fiberRoot, parentComponent, callback);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><ul><li>å‡½æ•°å†…éƒ¨å¯¹Reactçš„æ›´æ–°ç®—æ³•è¿›è¡Œäº†åˆå§‹åŒ–<ul><li><code>updatequeue</code></li><li><code>lane</code>ç®—æ³•</li></ul></li></ul><h3 id="workLoopSync"><a href="#workLoopSync" class="headerlink" title="workLoopSync"></a>workLoopSync</h3><ul><li>æ­¤å‡½æ•°å¯¹Fiberæ ‘è¿›è¡Œéå†ï¼ŒåŒæ—¶<strong>åˆ›å»ºå’Œå¤„ç†</strong>æ‰€æœ‰çš„FiberèŠ‚ç‚¹</li></ul><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">workLoopSync</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// Already timed out, so perform work without checking if we need to yield.</span></span><br><span class="line">    <span class="keyword">while</span> (workInProgress !== <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="title function_">performUnitOfWork</span>(workInProgress);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ­¤æ—¶çš„è°ƒç”¨æ ˆï¼š</p><img src="/2022/03/21/ReactSourceDebug/4.png" class="" title="è°ƒç”¨æ ˆ"><h3 id="Fiberéå†"><a href="#Fiberéå†" class="headerlink" title="Fiberéå†"></a>Fiberéå†</h3><ul><li><p><code>workLoopSync</code>å¯¹<strong>Fiberæ ‘çš„éå†ï¼ˆæ­¤æ—¶å…¶å®è¿˜åªæœ‰ä¸€ä¸ªrootFiberæ ¹ï¼‰</strong>ä¸»è¦è°ƒç”¨äº†ä¸¤ä¸ªå‡½æ•°</p><ul><li><code>beginWork</code></li><li><code>completeUnitOfWork</code></li></ul></li><li><p>è¿™ä¸¤ä¸ªå‡½æ•°éƒ½ä¼šæ ¹æ®FiberèŠ‚ç‚¹çš„ä¸åŒï¼Œè¿›è¡Œä¸åŒçš„å¤„ç†</p><ul><li><strong><code>beginWork</code>å‡½æ•°ä¼šå¯¹æ¯ä¸€ç§FiberèŠ‚ç‚¹è°ƒç”¨<code>reconcileChildren</code>å‡½æ•°ï¼Œé€šè¿‡ä¼ å…¥Fiberçš„childï¼ˆè¿™é‡Œçš„childæ˜¯é€šè¿‡JSXè§£æè·å–çš„ï¼Œè¿˜ä¸æ˜¯Fiberï¼‰åˆ›å»ºå¯¹åº”çš„Fiberå¹¶ä¸”è¿”å›è¿™ä¸ªFiber</strong></li><li><strong><code>completeUnitOfWork</code>å‡½æ•°åˆ™ä¼šæ ¹æ®Fiberçš„ç±»å‹çœŸæ­£åˆ›å»ºDOMèŠ‚ç‚¹ï¼Œå¹¶å¯¹å…¶åˆå§‹åŒ–</strong></li></ul></li><li><p>åŒæ—¶åœ¨<code>workLoopSync</code>å†…éƒ¨ä¼šæŒ‰ç…§ä¸‹é¢çš„é¡ºåºè¿›è¡Œéå†ï¼ˆ<strong>bä»£è¡¨<code>beginWork</code>ï¼Œb1ä»£è¡¨ç¬¬ä¸€æ­¥è°ƒç”¨<code>beginWork</code>å¤„ç†å¯¹åº”èŠ‚ç‚¹</strong>ï¼‰ï¼š<img src="/2022/03/21/ReactSourceDebug/5.png" class="" title="æ›´æ–°é¡ºåº"></p></li><li><p>å¯ä»¥çœ‹å‡ºï¼ŒFiberæ ‘éå†ä¹‹åï¼Œ<code>workLoopSync</code>ä¼šè¿”å›Fiberæ ‘çš„æ ¹èŠ‚ç‚¹ï¼Œä¹Ÿå°±æ˜¯<code>root</code>èŠ‚ç‚¹</p></li></ul><h3 id="commitRoot"><a href="#commitRoot" class="headerlink" title="commitRoot"></a>commitRoot</h3><ul><li><code>commitRoot</code>å‡½æ•°åˆ™ä¼šçœŸæ­£å°†Fiberæ ‘å¯¹åº”çš„çœŸå®DOMç»“æ„æ¸²æŸ“åˆ°é¡µé¢ä¸Š</li></ul><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// commitRootå‡½æ•°å†…éƒ¨è°ƒç”¨æ¸²æŸ“çœŸå®DOMçš„éƒ¨åˆ†ä»£ç </span></span><br><span class="line"><span class="keyword">do</span> &#123;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="title function_">invokeGuardedCallback</span>(<span class="literal">null</span>, commitMutationEffects, <span class="literal">null</span>, root, renderPriorityLevel);</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_">hasCaughtError</span>()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!(nextEffect !== <span class="literal">null</span>)) &#123;</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="title class_">Error</span>( <span class="string">&quot;Should be working on an effect.&quot;</span> );</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">var</span> _error = <span class="title function_">clearCaughtError</span>();</span><br><span class="line">            <span class="title function_">captureCommitPhaseError</span>(nextEffect, _error);</span><br><span class="line">            nextEffect = nextEffect.<span class="property">nextEffect</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">while</span> (nextEffect !== <span class="literal">null</span>);</span><br></pre></td></tr></table></figure><ul><li>ä»£ç ä¸­è¿˜æ‰§è¡Œäº†å¦å¤–ä¸¤æ¬¡ç›¸ä¼¼å‡½æ•°ï¼Œåˆ†åˆ«åœ¨ä¸Šè¿°ä»£ç å‰åæ‰§è¡Œ<ul><li><code>invokeGuardedCallback(null, commitBeforeMutationEffects, null);</code></li><li><code>invokeGuardedCallback(null, commitLayoutEffects, null, root, lanes);</code></li></ul></li></ul><p>æ­¤æ—¶çš„è°ƒç”¨æ ˆï¼š<img src="/2022/03/21/ReactSourceDebug/6.png" class="" title="è°ƒç”¨æ ˆ"></p><ul><li>åœ¨ä¸Šè¿°ä»£ç æ‰§è¡Œè¿‡åï¼Œé¡µé¢ä¸Šæ‰ä¼šçœŸæ­£æ¸²æŸ“å‡ºçœŸå®DOM</li></ul>]]></content>
      
      
      <categories>
          
          <category> React </category>
          
      </categories>
      
      
        <tags>
            
            <tag> React </tag>
            
            <tag> Javascript </tag>
            
            <tag> source </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>RustStudyBasic</title>
      <link href="/2022/02/22/RustStudyBasic/"/>
      <url>/2022/02/22/RustStudyBasic/</url>
      
        <content type="html"><![CDATA[<h2 id="RuståŸºç¡€å­¦ä¹ æ€»ç»“"><a href="#RuståŸºç¡€å­¦ä¹ æ€»ç»“" class="headerlink" title="RuståŸºç¡€å­¦ä¹ æ€»ç»“"></a>RuståŸºç¡€å­¦ä¹ æ€»ç»“</h2><h3 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h3><ul><li>ä¹‹å‰æµè§ˆå…¬ä¼—å·çš„æ—¶å€™çœ‹è§å‡ ç¯‡æ–‡ç« ï¼Œè°ˆåŠRustå¯¹å‰ç«¯åŸºç¡€å»ºè®¾å…·æœ‰å¯è§‚çš„æ½œåŠ›<del>ï¼ˆåŒæ—¶åœ¨å®¶é‡Œæœ‰ç‚¹æ— èŠï¼‰</del>ï¼Œè‡ªå·±ä¹Ÿå¯¹è¿™æ–¹é¢æ„Ÿå…´è¶£ï¼Œå°±ä» 2.9 å¼€å§‹å­¦ä¹ Rust<ul><li>å­¦ä¹ æ–¹å¼ï¼šé˜…è¯»<a href="https://kaisery.github.io/trpl-zh-cn/title-page.html">Rust ç¨‹åºè®¾è®¡è¯­è¨€</a> + æ‰‹åŠ¨ç»ƒä¹ è¯­æ³•</li></ul></li><li>2.22 é˜…è¯»å®Œå‰19ç« ï¼ˆé™¤äº†æœ€åçš„ç»ƒä¹ é¡¹ç›®ä»¥åŠé™„å½•ï¼‰ï¼Œä¸‹æ–‡åˆ™æ˜¯<strong>ç®€å•çš„å­¦ä¹ æ€»ç»“</strong><ul><li>ç”±äºä¹‹å‰ä¸€ç›´åœ¨å­¦ä¹ å’Œä½¿ç”¨**<code>JavaScript</code>**ï¼ˆä¸‹æ–‡å†™ä½œJSï¼‰ï¼Œæ‰€ä»¥ä¹Ÿä½¿ç”¨JSä¸­çš„è¯­æ³•åšæ¯”è¾ƒ</li></ul></li></ul><h2 id="hello-world"><a href="#hello-world" class="headerlink" title="hello_world"></a>hello_world</h2><h3 id="ç¼–ç¨‹ä¹ æƒ¯"><a href="#ç¼–ç¨‹ä¹ æƒ¯" class="headerlink" title="ç¼–ç¨‹ä¹ æƒ¯"></a>ç¼–ç¨‹ä¹ æƒ¯</h3><ul><li>Rustå¯¹å˜é‡ã€æ–‡ä»¶ã€å‡½æ•°ç­‰å‘½åè§„å®šä½¿ç”¨<code>_</code>åˆ†å‰²å•è¯ï¼Œä¾‹å¦‚ï¼š<code>hello_world.rs</code>ï¼ŒJSæ²¡æœ‰æ˜è¯´ï¼Œä½†å¤§éƒ¨åˆ†äººä½¿ç”¨é©¼å³°å‘½åï¼Œä¾‹å¦‚ï¼š<code>helloWorld.js</code></li></ul><h3 id="è¿è¡Œç¯å¢ƒ"><a href="#è¿è¡Œç¯å¢ƒ" class="headerlink" title="è¿è¡Œç¯å¢ƒ"></a>è¿è¡Œç¯å¢ƒ</h3><ul><li>JSä¸ç”¨å¤šè¯´ï¼Œæµè§ˆå™¨æ˜¯ä¸€åˆ‡çš„å¼€å§‹ï¼ˆå…·ä½“å¯ä»¥æ˜¯chromeçš„V8å¼•æ“ï¼‰ï¼ŒRustéœ€è¦ä»å®˜ç½‘å®‰è£…è¿è¡Œç¯å¢ƒï¼ŒåŒæ—¶è‡ªå¸¦å®˜æ–¹åŒ…ç®¡ç†å™¨ï¼ˆCargoï¼‰ï¼Œç±»æ¯”Nodeå’Œnpm</li></ul><h3 id="è¯­è¨€ç‰¹å¾"><a href="#è¯­è¨€ç‰¹å¾" class="headerlink" title="è¯­è¨€ç‰¹å¾"></a>è¯­è¨€ç‰¹å¾</h3><ul><li>Rustå’ŒåŸç”ŸJSç›¸åï¼ŒRustæ˜¯é™æ€è¯­è¨€ï¼Œéœ€è¦å…ˆç¼–è¯‘å†è¿è¡Œï¼ŒåŒæ—¶ä¹Ÿéœ€è¦æŒ‡æ˜ç±»å‹ä¾›ç¼–è¯‘å™¨æ£€æŸ¥</li></ul><h2 id="åŸºæœ¬æ¦‚å¿µ"><a href="#åŸºæœ¬æ¦‚å¿µ" class="headerlink" title="åŸºæœ¬æ¦‚å¿µ"></a>åŸºæœ¬æ¦‚å¿µ</h2><ul><li><p>å¤§å¤šæ•°ç¼–ç¨‹è¯­è¨€å…¬æœ‰çš„ç±»å‹ï¼ŒRustä¹Ÿä¸€æ ·ï¼Œè¿™äº›å¯ä»¥ç•¥è¿‡</p><ul><li>æ•°æ®ç±»å‹</li><li>å‡½æ•°</li><li>ç»“æ„ï¼ˆç±»æ¯”classï¼‰</li><li>æšä¸¾</li><li>æ§åˆ¶æµï¼ˆRustçš„æ§åˆ¶æµå¯ä»¥ç©å¾—æ¯”è¾ƒèŠ±ï¼‰</li><li>æ³›å‹ï¼ˆé™æ€è¯­è¨€ä¸€èˆ¬éƒ½æœ‰ï¼‰</li><li>è¿­ä»£å™¨</li><li>â€¦</li></ul></li><li><p>Rustæœ€ä¸ºç‹¬ç‰¹çš„ç‰¹æ€§æ— ç–‘æ˜¯**<code>ownership</code>**ï¼ˆæ‰€æœ‰æƒç³»ç»Ÿï¼‰</p></li></ul><h3 id="æ‰€æœ‰æƒ"><a href="#æ‰€æœ‰æƒ" class="headerlink" title="æ‰€æœ‰æƒ"></a>æ‰€æœ‰æƒ</h3><ul><li>Rustå¯¹æ¯”JSæ›´åå‘äºåº•å±‚ï¼ŒJSçš„åƒåœ¾å›æ”¶è‡ªåŠ¨æ‰§è¡Œï¼ŒRustä¹Ÿæ˜¯è‡ªåŠ¨æ‰§è¡Œï¼Œä½†æ˜¯æ˜¯åŸºäºæ‰€æœ‰æƒç³»ç»Ÿæ‰§è¡Œ</li><li>æ‰€æœ‰æƒç³»ç»Ÿä¹Ÿä¿è¯äº†Rustçš„å†…å­˜å®‰å…¨</li><li>å®˜æ–¹ç»™å‡ºçš„æ‰€æœ‰æƒè§„åˆ™</li></ul><blockquote><ul><li>Rust ä¸­çš„æ¯ä¸€ä¸ªå€¼éƒ½æœ‰ä¸€ä¸ªè¢«ç§°ä¸ºå…¶ <strong>æ‰€æœ‰è€…</strong>ï¼ˆ<em>owner</em>ï¼‰çš„å˜é‡ã€‚</li><li>å€¼åœ¨ä»»ä¸€æ—¶åˆ»æœ‰ä¸”åªæœ‰ä¸€ä¸ªæ‰€æœ‰è€…ã€‚</li><li>å½“æ‰€æœ‰è€…ï¼ˆå˜é‡ï¼‰ç¦»å¼€ä½œç”¨åŸŸï¼Œè¿™ä¸ªå€¼å°†è¢«ä¸¢å¼ƒã€‚</li></ul></blockquote><h3 id="å¼•ç”¨"><a href="#å¼•ç”¨" class="headerlink" title="å¼•ç”¨"></a>å¼•ç”¨</h3><ul><li>å­¦åˆ°è¿™é‡Œçš„ç¬¬ä¸€ååº”å°±æ˜¯C++ä¸­çš„å¼•ç”¨ï¼ˆkeywordéƒ½ä¸€æ ·<code>&amp;</code>ï¼‰</li><li>Rustçš„å¼•ç”¨å®é™…ä¸Šä¹Ÿæ˜¯åœ¨æ‰€æœ‰æƒç³»ç»Ÿä¹‹ä¸Šè¿è¡Œ</li><li>å®˜æ–¹ç»™å‡ºçš„å¼•ç”¨è§„åˆ™</li></ul><blockquote><ul><li>åœ¨ä»»æ„ç»™å®šæ—¶é—´ï¼Œ<strong>è¦ä¹ˆ</strong> åªèƒ½æœ‰ä¸€ä¸ªå¯å˜å¼•ç”¨ï¼Œ<strong>è¦ä¹ˆ</strong> åªèƒ½æœ‰å¤šä¸ªä¸å¯å˜å¼•ç”¨ã€‚</li><li>å¼•ç”¨å¿…é¡»æ€»æ˜¯æœ‰æ•ˆçš„ã€‚</li></ul></blockquote><ul><li>ç†è§£å¼•ç”¨ååˆ†é‡è¦ï¼Œåç»­Rustä»£ç ç¼–å†™è¿‡ç¨‹ä¸­ï¼Œä¼šå¤„å¤„ä½¿ç”¨åˆ°å¼•ç”¨ã€‚åœ¨æˆ‘å­¦ä¹ è¿‡ç¨‹ä¸­ï¼ŒåŸºæœ¬å¯ä»¥ç†è§£å¼•ç”¨ä¸ºæŒ‡é’ˆï¼ˆå®˜æ–¹ä¹Ÿè¿™ä¹ˆç±»æ¯”ï¼‰ï¼Œä¸€èˆ¬å¼•ç”¨å¯ä»¥æ˜¯Cè¯­è¨€ä¸­çš„**<code>* const ptr</code>**ï¼ˆå€¼ä¸å¯å˜ï¼‰</li></ul><h3 id="æ¨¡å—ç³»ç»Ÿ"><a href="#æ¨¡å—ç³»ç»Ÿ" class="headerlink" title="æ¨¡å—ç³»ç»Ÿ"></a>æ¨¡å—ç³»ç»Ÿ</h3><ul><li>Rustæœ‰å®˜æ–¹çš„åŒ…ç®¡ç†å™¨ï¼Œæ¨¡å—ç³»ç»Ÿä¹Ÿæœ‰è‡ªå·±çš„ä¸€å¥—ï¼Œä¸è¿‡æ¨¡å—ç³»ç»Ÿå®é™…è¦è§£å†³çš„é—®é¢˜å’Œå…¶ä»–è¯­è¨€ä¸€æ ·ï¼Œæ‰€ä»¥å®¹æ˜“ç†è§£ï¼Œåªæ˜¯å…³é”®å­—éœ€è¦æ›¿æ¢ä¸‹</li></ul><h2 id="traitå’Œlife-cycle"><a href="#traitå’Œlife-cycle" class="headerlink" title="traitå’Œlife_cycle"></a>traitå’Œlife_cycle</h2><h3 id="trait"><a href="#trait" class="headerlink" title="trait"></a>trait</h3><ul><li>å­¦ä¹ åˆ°è¿™é‡Œè®©æˆ‘æƒ³åˆ°äº†çº¢å®ä¹¦ï¼ˆJavaScriptï¼‰ä¸­è®²åˆ°<code>class</code>æåŠçš„ç»„åˆæ¨¡å¼ä»¥åŠè®¾è®¡æ¨¡å¼ä¸­ç»å…¸çš„é¸­å­ç±»å‹</li><li>ç®€è€Œè¨€ä¹‹ï¼Œå¯ä»¥ä¸º<code>struct</code>å®ç°<code>trait</code>ï¼Œé‚£ä¹ˆå°±å¯ä»¥è°ƒç”¨<code>trait</code>ä¸­çš„æ–¹æ³•ï¼ˆä¸ä¼šå…³å¿ƒæ˜¯ä»€ä¹ˆç±»å‹çš„<code>struct</code>ï¼‰</li><li>å­¦ä¹ å®ŒåŸºç¡€çš„<code>trait</code>ï¼Œå¯ä»¥å‘ç°Ruståˆ°å¤„éƒ½æ˜¯ç”¨åˆ°äº†<code>trait</code>ï¼Œæœ€å¸¸ç”¨åˆ°çš„æ‰“å°å®<code>println!</code>ï¼Œé‡Œé¢éœ€è¦æ ¼å¼åŒ–è¾“å‡ºæ—¶ï¼Œå¯ä»¥è¾“å‡ºçš„æ•°æ®ç±»å‹ï¼Œéƒ½åœ¨Rustå†…éƒ¨å®ç°äº†**<code>std::fmt::Display</code>**ï¼Œä¾‹å¦‚ï¼šStringã€i8-128ã€u8-128ã€Vecç­‰</li></ul><h3 id="life-cycle"><a href="#life-cycle" class="headerlink" title="life_cycle"></a>life_cycle</h3><ul><li>è¿˜æ˜¯ç”±äºæ‰€æœ‰æƒç³»ç»Ÿå¼•å‡ºçš„å¼•ç”¨æ‰€éœ€è¦çš„è¯­æ³•ï¼ŒRustç¡®ä¿ä¸ä¼šå‡ºç°ç©ºæŒ‡é’ˆï¼ˆNULLï¼‰ï¼ˆunsafeæƒ…å†µä¸‹å¯èƒ½å‡ºç°ï¼‰ï¼Œæ‰€ä»¥å‡½æ•°ä¼ å…¥å¼•ç”¨å‚æ•°ï¼Œè¿”å›å¼•ç”¨æ—¶Rustç¼–è¯‘å™¨æ£€æŸ¥ä¼šå‡ºé—®é¢˜ï¼Œå¯èƒ½ä¼šå‡ºç°æ‚¬å‚å¼•ç”¨ï¼ˆç±»æ¯”ç©ºæŒ‡é’ˆï¼‰ï¼ŒRustä¸ºäº†ä¸è®©è¿™ç§æƒ…å†µå‡ºç°ï¼Œéœ€è¦æˆ‘ä»¬æŒ‡æ˜å¼•ç”¨å…³ç³»ï¼ˆå£°æ˜å‘¨æœŸï¼‰</li><li>è¯»å®Œæ–‡æ¡£ä¹‹åï¼Œå¾ˆå¥½ç†è§£ï¼Œé™¤äº†è¯­æ³•å¾ˆæ€ªï¼ˆ<code>fn test&lt;&#39;a&gt;(str1:&amp;&#39;a str)-&gt;&amp;&#39;a str</code>ï¼‰</li></ul><h2 id="æ™ºèƒ½æŒ‡é’ˆ"><a href="#æ™ºèƒ½æŒ‡é’ˆ" class="headerlink" title="æ™ºèƒ½æŒ‡é’ˆ"></a>æ™ºèƒ½æŒ‡é’ˆ</h2><ul><li><p>å’ŒCè¯­è¨€çš„æŒ‡é’ˆåŸºæœ¬ä¸€è‡´ï¼Œå­¦ä¹ ä¸‹æ¥æ™ºèƒ½æœ€å¤§ä½“ç°åœ¨ä¸éœ€è¦æ‰‹åŠ¨é‡Šæ”¾ï¼ˆä¾‹å¦‚ï¼š<code>free(p);</code>ï¼‰</p></li><li><p>åŒæ—¶ä¹Ÿæ¶‰åŠåˆ°äº†è§£å¼•ç”¨ï¼ˆå’ŒCè¯­è¨€ä¸€æ ·çš„keywordï¼š<code>*</code>ï¼‰ï¼ŒRustå†…éƒ¨åˆ™æ˜¯ä½¿ç”¨**<code>trait</code><strong>å®ç°ï¼Œå®é™…ä¸ŠRustå¯ä»¥ä½¿ç”¨</strong><code>trait</code>**å®ç°è¿ç®—ç¬¦é‡è½½</p><ul><li>æ•ˆæœå’ŒCè¯­è¨€ä¸€è‡´ï¼Œè§£å¼•ç”¨å¯ä»¥è¯»å†™æŒ‡é’ˆæŒ‡å‘çš„å†…å­˜åœ°å€ä¸Šå­˜æ”¾çš„å€¼</li></ul></li><li><p>åç»­æ¶‰åŠåˆ°äº†å¼•ç”¨è®¡æ•°<code>RC&lt;&gt;</code>ï¼ˆå¾ˆåƒJSçš„è¿‡å»çš„åƒåœ¾å›æ”¶æœºåˆ¶ï¼Œä½†æ˜¯Rustæ˜¯ä¸ºäº†å®ç°å¤šä¸ªæ‰€æœ‰æƒçš„ç‰¹æ®Šæƒ…å†µï¼‰ï¼Œå†…éƒ¨ä¸å¯å˜æ€§<code>RefCell&lt;&gt;</code></p></li></ul><h2 id="å‡½æ•°å¼ç¼–ç¨‹"><a href="#å‡½æ•°å¼ç¼–ç¨‹" class="headerlink" title="å‡½æ•°å¼ç¼–ç¨‹"></a>å‡½æ•°å¼ç¼–ç¨‹</h2><ul><li>JSå¾ˆç†Ÿæ‚‰çš„ä¸€ä¸ªæ¦‚å¿µï¼Œæˆ‘çš„ç®€å•ç†è§£å°±æ˜¯ï¼š<strong>å‡½æ•°å¯ä»¥éšä¾¿ä¼ </strong>ï¼ˆä¾‹å¦‚ï¼šå‡½æ•°å½“åšå‚æ•°ä¼ é€’ç»™å‡½æ•°ï¼‰</li><li>Rustä¹Ÿä¸€æ ·ï¼Œå¯ä»¥åˆ©ç”¨æ³›å‹å’Œ<code>trait</code>é…åˆï¼ŒæŠŠå‡½æ•°å½“åšå‚æ•°ä¼ é€’ç»™å‡½æ•°ï¼Œå®ç°è®¸å¤šé«˜é˜¶åŠŸèƒ½</li><li>åŒæ—¶Rustè¿˜æœ‰é—­åŒ…ï¼ˆJSä¸­çš„é—­åŒ…æ›´åå‘äºå˜é‡æœºåˆ¶ï¼‰ï¼ŒRustä¸»è¦æ˜¯å¯ä»¥å®ç°å†…è”åŒ¿åå‡½æ•°ï¼Œå†™å‡ºè®¸å¤šçµæ´»çš„ä»£ç </li></ul>]]></content>
      
      
      <categories>
          
          <category> Rust </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Rust </tag>
            
            <tag> basic </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>vue2SourceDebug</title>
      <link href="/2021/11/15/vue2SourceDebug/"/>
      <url>/2021/11/15/vue2SourceDebug/</url>
      
        <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>ä¹‹å‰äº†è§£Vueæºç éƒ½æ˜¯é€šè¿‡ç½‘ä¸Šä¸€äº›æ–‡ç« è·å–ï¼Œä»æœªçœŸæ­£debugè¿‡Vueæºç ï¼Œæ‰€ä»¥å°±æœ‰äº†è¿™ç¯‡æ–‡ç« </p><p><strong>å†™å®Œä¹‹åå‘ç°å°±æ˜¯æºç çš„å †ç§¯ï¼Œç†è§£è¿˜æ˜¯ä¸å¤Ÿå•Š</strong></p><ul><li>Vueç‰ˆæœ¬ï¼š2.6.14</li><li>ç®€å•æ‰‹åŠ¨é…ç½®webpackåè¿›è¡Œdebug</li><li>å…¥å£æ–‡ä»¶ä»£ç å¦‚ä¸‹</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* index.js */</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Vue</span> <span class="keyword">from</span> <span class="string">&quot;vue&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Header</span> <span class="keyword">from</span> <span class="string">&quot;./components/Header/index.js&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">debugger</span>; <span class="comment">//æ­¤å¤„è¿›è¡Œdebugè°ƒè¯•</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">new</span> <span class="title class_">Vue</span>(&#123;</span><br><span class="line">  <span class="attr">el</span>: <span class="string">&quot;#app&quot;</span>,</span><br><span class="line">  <span class="title function_">data</span>(<span class="params"></span>) &#123; <span class="comment">// æµ‹è¯•data</span></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      <span class="attr">text</span>: <span class="string">&quot;123&quot;</span>,</span><br><span class="line">      <span class="attr">ifFlag</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">inputValue</span>: <span class="string">&quot;input something&quot;</span>,</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">methods</span>: &#123; <span class="comment">// æµ‹è¯•methods</span></span><br><span class="line">    <span class="title function_">hello</span>(<span class="params"></span>) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;==app hello&quot;</span>);</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">computed</span>: &#123; <span class="comment">// æµ‹è¯•computed</span></span><br><span class="line">    <span class="title function_">reversedText</span>(<span class="params"></span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">text</span>.<span class="title function_">split</span>(<span class="string">&quot;&quot;</span>).<span class="title function_">reverse</span>().<span class="title function_">join</span>(<span class="string">&quot;&quot;</span>);</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">// æµ‹è¯•lifeCycle</span></span><br><span class="line">  <span class="title function_">beforeCreate</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;==app before create&quot;</span>);</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="title function_">created</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;==app created&quot;</span>);</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="title function_">beforeMount</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;==app before mount&quot;</span>);</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="title function_">mounted</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;==app mounted&quot;</span>);</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="title function_">beforeUpdate</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;==app before update&quot;</span>);</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="title function_">updated</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;==app updated&quot;</span>);</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">// æµ‹è¯•component</span></span><br><span class="line">  <span class="attr">components</span>: &#123;</span><br><span class="line">    <span class="title class_">Header</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">// æµ‹è¯•template</span></span><br><span class="line">  <span class="attr">template</span>: <span class="string">`</span></span><br><span class="line"><span class="string">    &lt;div id=&quot;app&quot; @click=&quot;hello&quot;&gt;</span></span><br><span class="line"><span class="string">      &lt;div&gt;&#123;&#123;reversedText&#125;&#125;&lt;/div&gt;</span></span><br><span class="line"><span class="string">      &lt;div v-if=&quot;ifFlag&quot;&gt;ifFlag is true then I will show&lt;/div&gt;</span></span><br><span class="line"><span class="string">      &lt;input v-model=&quot;inputValue&quot; /&gt;</span></span><br><span class="line"><span class="string">      &lt;p&gt;what you input is:&#123;&#123;inputValue&#125;&#125;&lt;/p&gt;</span></span><br><span class="line"><span class="string">      &lt;Header :propValue=&quot;&#x27;from app&#x27;&quot; /&gt;</span></span><br><span class="line"><span class="string">    &lt;/div&gt;</span></span><br><span class="line"><span class="string">  `</span>,</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><ul><li>Headerç»„ä»¶</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Header.js */</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Vue</span> <span class="keyword">from</span> <span class="string">&quot;vue&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title class_">Vue</span>.<span class="title function_">component</span>(<span class="string">&quot;Header&quot;</span>, &#123;</span><br><span class="line">  <span class="attr">template</span>: <span class="string">`</span></span><br><span class="line"><span class="string">  &lt;div @click=&quot;showMsg&quot; class=&quot;header&quot;&gt;</span></span><br><span class="line"><span class="string">    text:&#123;&#123;text&#125;&#125;</span></span><br><span class="line"><span class="string">    propValue:&#123;&#123;propValue&#125;&#125;</span></span><br><span class="line"><span class="string">  &lt;/div&gt;</span></span><br><span class="line"><span class="string">  `</span>,</span><br><span class="line">  <span class="title function_">data</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      <span class="attr">text</span>: <span class="string">&quot;i am header&quot;</span>,</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">props</span>: [<span class="string">&quot;propValue&quot;</span>], <span class="comment">// propsæµ‹è¯•</span></span><br><span class="line">  <span class="attr">methods</span>: &#123;</span><br><span class="line">    <span class="title function_">showMsg</span>(<span class="params"></span>) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;==from header&quot;</span>);</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="title function_">created</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;==Header components created&quot;</span>);</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="title function_">mounted</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;==Header components mounted&quot;</span>);</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h2 id="Vue2æºç çš„ä¸€æ¬¡debug"><a href="#Vue2æºç çš„ä¸€æ¬¡debug" class="headerlink" title="Vue2æºç çš„ä¸€æ¬¡debug"></a>Vue2æºç çš„ä¸€æ¬¡debug</h2><p><strong>debugè¿‡ç¨‹ä¸­ï¼Œç›¸å…³æºç ä¼šè¿›è¡Œç®€åŒ–ï¼Œçœç•¥æ— å…³ä»£ç ï¼ˆä¾‹å¦‚æ‰€æœ‰ç¯å¢ƒåˆ†æ”¯å‡å·²åˆ é™¤ï¼Œä¿ç•™å¼€å‘ç¯å¢ƒï¼‰</strong></p><p>å•æ­¥è°ƒè¯•<code>export default new Vue(&#123;...&#125;)</code>ï¼Œå°±ä¼šè¿›å…¥Vueçš„æ„é€ å‡½æ•°å†…éƒ¨</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">Vue</span> (options) &#123;</span><br><span class="line">  <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span> &amp;&amp;</span><br><span class="line">    !(<span class="variable language_">this</span> <span class="keyword">instanceof</span> <span class="title class_">Vue</span>)</span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="title function_">warn</span>(<span class="string">&#x27;Vue is a constructor and should be called with the `new` keyword&#x27;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="title function_">_init</span>(options);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>å¯ä»¥çœ‹åˆ°Vueçš„æ„é€ å‡½æ•°å¾ˆç®€å•ï¼Œæ¥å—ä¼ å…¥çš„optionsï¼Œç›´æ¥è°ƒç”¨<code>_init</code>æ–¹æ³•åˆå§‹åŒ–</li></ul><h3 id="init"><a href="#init" class="headerlink" title="__init"></a>__init</h3><p>_initæ–¹æ³•åœ¨æºç ä¸­å·²è¢«mixinï¼ˆæ··å…¥ï¼‰Vueæ„é€ æ–¹æ³•</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Vue</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">_init</span> = <span class="keyword">function</span> (<span class="params">options</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> vm = <span class="variable language_">this</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// a flag to avoid this being observed</span></span><br><span class="line">    vm.<span class="property">_isVue</span> = <span class="literal">true</span>;</span><br><span class="line">    <span class="comment">// merge options</span></span><br><span class="line">    <span class="keyword">if</span> (options &amp;&amp; options.<span class="property">_isComponent</span>) &#123;</span><br><span class="line">        <span class="comment">// optimize internal component instantiation</span></span><br><span class="line">        <span class="comment">// since dynamic options merging is pretty slow, and none of the</span></span><br><span class="line">        <span class="comment">// internal component options needs special treatment.</span></span><br><span class="line">        <span class="title function_">initInternalComponent</span>(vm, options);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        vm.<span class="property">$options</span> = <span class="title function_">mergeOptions</span>(</span><br><span class="line">            <span class="title function_">resolveConstructorOptions</span>(vm.<span class="property">constructor</span>),</span><br><span class="line">            options || &#123;&#125;,</span><br><span class="line">            vm</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// expose real self</span></span><br><span class="line">    vm.<span class="property">_self</span> = vm;</span><br><span class="line">    <span class="title function_">initLifecycle</span>(vm);</span><br><span class="line">    <span class="title function_">initEvents</span>(vm);</span><br><span class="line">    <span class="title function_">initRender</span>(vm);</span><br><span class="line">    <span class="title function_">callHook</span>(vm, <span class="string">&#x27;beforeCreate&#x27;</span>);</span><br><span class="line">    <span class="title function_">initInjections</span>(vm); <span class="comment">// resolve injections before data/props</span></span><br><span class="line">    <span class="title function_">initState</span>(vm);</span><br><span class="line">    <span class="title function_">initProvide</span>(vm); <span class="comment">// resolve provide after data/props</span></span><br><span class="line">    <span class="title function_">callHook</span>(vm, <span class="string">&#x27;created&#x27;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (vm.<span class="property">$options</span>.<span class="property">el</span>) &#123;</span><br><span class="line">        vm.$mount(vm.<span class="property">$options</span>.<span class="property">el</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><ul><li>åˆå§‹åŒ–å˜é‡ vm &#x3D; å½“å‰å³å°†åˆ›å»ºçš„Vueå¯¹è±¡</li><li>æ ‡è®°å½“å‰å³å°†åˆ›å»ºçš„å¯¹è±¡æ˜¯Vue<code>_isVue = true</code></li><li><strong>å¯ä»¥å…³æ³¨ä¸‹ä¸¤ä¸ªå£°æ˜å‘¨æœŸå‡½æ•°çš„æ‰§è¡Œæ—¶é—´</strong></li><li><strong>æœ€åæŠŠVueæŒ‚è½½åˆ°DOMä¸Š</strong></li><li><strong>ä¸‹é¢æ˜¯æ¯ä¸ªæ­¥éª¤å‡½æ•°çš„ç®€å•è§£æ</strong></li></ul><h4 id="initInternalComponent"><a href="#initInternalComponent" class="headerlink" title="initInternalComponent"></a>initInternalComponent</h4><ul><li>Vnodeä¸­å­˜åœ¨è‡ªå®šä¹‰ç»„ä»¶æ—¶ï¼Œåœ¨åˆ›å»ºçœŸå®DOMå…ƒç´ çš„æ—¶å€™æ‰ä¼šè°ƒç”¨è¿™ä¸ªå‡½æ•°</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">initInternalComponent</span> (vm, options) &#123;</span><br><span class="line">    <span class="keyword">var</span> opts = vm.<span class="property">$options</span> = <span class="title class_">Object</span>.<span class="title function_">create</span>(vm.<span class="property">constructor</span>.<span class="property">options</span>);</span><br><span class="line">    <span class="comment">// doing this because it&#x27;s faster than dynamic enumeration.</span></span><br><span class="line">    <span class="keyword">var</span> parentVnode = options.<span class="property">_parentVnode</span>;</span><br><span class="line">    opts.<span class="property">parent</span> = options.<span class="property">parent</span>;</span><br><span class="line">    opts.<span class="property">_parentVnode</span> = parentVnode;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> vnodeComponentOptions = parentVnode.<span class="property">componentOptions</span>;</span><br><span class="line">    opts.<span class="property">propsData</span> = vnodeComponentOptions.<span class="property">propsData</span>;</span><br><span class="line">    opts.<span class="property">_parentListeners</span> = vnodeComponentOptions.<span class="property">listeners</span>;</span><br><span class="line">    opts.<span class="property">_renderChildren</span> = vnodeComponentOptions.<span class="property">children</span>;</span><br><span class="line">    opts.<span class="property">_componentTag</span> = vnodeComponentOptions.<span class="property">tag</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">render</span>) &#123;</span><br><span class="line">        opts.<span class="property">render</span> = options.<span class="property">render</span>;</span><br><span class="line">        opts.<span class="property">staticRenderFns</span> = options.<span class="property">staticRenderFns</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>æ³¨æ„ï¼š<code>options.__parentVnode</code>æŒ‡çš„æ˜¯ç»„ä»¶è‡ªèº«çš„VNodeï¼Œ<code>options.parentVnode</code>æŒ‡çš„æ˜¯çˆ¶ç»„ä»¶çš„Vueå®ä¾‹å¯¹è±¡</li></ul><h4 id="mergeOptoins"><a href="#mergeOptoins" class="headerlink" title="mergeOptoins"></a>mergeOptoins</h4><ul><li><p>åˆå¹¶optionï¼ˆé€‰é¡¹ï¼‰</p></li><li><p>resolveConstructorOptionså‡½æ•°è·å–äº†<code>Vue.constructor</code>ä¸Šçš„å±æ€§</p></li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">mergeOptions</span> (</span><br><span class="line">  parent, <span class="comment">// Vue.constructorä¸Šçš„å±æ€§</span></span><br><span class="line">  child, <span class="comment">// æˆ‘ä»¬ä¼ å…¥çš„option</span></span><br><span class="line">  vm <span class="comment">// å½“å‰Vueå¯¹è±¡</span></span><br><span class="line">) &#123;</span><br><span class="line">  <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span>) &#123;</span><br><span class="line">    <span class="title function_">checkComponents</span>(child);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">normalizeProps</span>(child, vm);</span><br><span class="line">  <span class="title function_">normalizeInject</span>(child, vm);</span><br><span class="line">  <span class="title function_">normalizeDirectives</span>(child);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Apply extends and mixins on the child options,</span></span><br><span class="line">  <span class="comment">// but only if it is a raw options object that isn&#x27;t</span></span><br><span class="line">  <span class="comment">// the result of another mergeOptions call.</span></span><br><span class="line">  <span class="comment">// Only merged options has the _base property.</span></span><br><span class="line">  <span class="keyword">if</span> (!child.<span class="property">_base</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (child.<span class="property">extends</span>) &#123;</span><br><span class="line">      parent = <span class="title function_">mergeOptions</span>(parent, child.<span class="property">extends</span>, vm);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (child.<span class="property">mixins</span>) &#123;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>, l = child.<span class="property">mixins</span>.<span class="property">length</span>; i &lt; l; i++) &#123;</span><br><span class="line">        parent = <span class="title function_">mergeOptions</span>(parent, child.<span class="property">mixins</span>[i], vm);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> options = &#123;&#125;;</span><br><span class="line">  <span class="keyword">var</span> key;</span><br><span class="line">  <span class="keyword">for</span> (key <span class="keyword">in</span> parent) &#123;</span><br><span class="line">    <span class="title function_">mergeField</span>(key);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">for</span> (key <span class="keyword">in</span> child) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="title function_">hasOwn</span>(parent, key)) &#123;</span><br><span class="line">      <span class="title function_">mergeField</span>(key);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">mergeField</span> (key) &#123;</span><br><span class="line">    <span class="keyword">var</span> strat = strats[key] || defaultStrat;</span><br><span class="line">    options[key] = <span class="title function_">strat</span>(parent[key], child[key], vm, key);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> options</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><code>checkComponents</code>å‡½æ•°æ£€æµ‹<strong>è‡ªå®šä¹‰ç»„ä»¶åæ˜¯å¦è§„èŒƒ</strong>ï¼ˆä¾‹å¦‚ï¼šä¸èƒ½è‡ªå®šä¹‰ä¸€ä¸ªdivç»„ä»¶ï¼Œhtmlå·²æœ‰divæ ‡ç­¾ï¼‰</li><li><code>normalizeProps</code>å‡½æ•°æ£€æµ‹**<code>props</code>æ˜¯å¦è§„èŒƒ**ï¼ˆä¾‹å¦‚ï¼šæ˜¯å¦æ˜¯arrayæˆ–è€…plainObjectï¼‰<ul><li>åŒæ—¶ä¹Ÿè¿›è¡Œäº†æ ¼å¼åŒ–ï¼Œè¿å­—ç¬¦æ ¼å¼è½¬ä¸ºé©¼å³°æ ¼å¼</li></ul></li><li>normalizeInjectã€normalizeDirectiveså‡½æ•°åŒä¸Š</li><li>åç»­é’ˆå¯¹extendså’Œmixinsæ–¹æ³•åˆ›å»ºçš„å­æ„é€ å™¨åˆå¹¶äº†é€‰é¡¹</li><li>æœ€ååˆå¹¶çˆ¶å­çš„optioné€‰é¡¹ï¼Œåˆå¹¶æ—¶çš„ä¼˜å…ˆçº§å¦‚ä¸‹ï¼šï¼ˆ<strong>ä¼˜å…ˆçº§é«˜çš„è¦†ç›–ä¼˜å…ˆçº§ä½çš„ï¼Œä¸ä¼šâˆªåœ¨ä¸€èµ·</strong>ï¼‰<ul><li>è‡ªå®šä¹‰option</li><li>å­option</li><li>çˆ¶option</li></ul></li></ul><h4 id="initProxy"><a href="#initProxy" class="headerlink" title="initProxy"></a>initProxy</h4><ul><li>ä»…ç”¨äºå¼€å‘ç¯å¢ƒï¼Œåˆ©ç”¨es6çš„proxyä»£ç†Vueå±æ€§çš„è®¿é—®ï¼Œå½“è®¿é—®ä¸å­˜åœ¨çš„å±æ€§æ—¶ï¼Œlogæé†’</li></ul><h4 id="initLifecycle"><a href="#initLifecycle" class="headerlink" title="initLifecycle"></a>initLifecycle</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">initLifecycle</span> (vm) &#123;</span><br><span class="line">  <span class="keyword">var</span> options = vm.<span class="property">$options</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// locate first non-abstract parent</span></span><br><span class="line">  <span class="keyword">var</span> parent = options.<span class="property">parent</span>;</span><br><span class="line">  <span class="keyword">if</span> (parent &amp;&amp; !options.<span class="property">abstract</span>) &#123;</span><br><span class="line">    <span class="keyword">while</span> (parent.<span class="property">$options</span>.<span class="property">abstract</span> &amp;&amp; parent.<span class="property">$parent</span>) &#123;</span><br><span class="line">      parent = parent.<span class="property">$parent</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    parent.<span class="property">$children</span>.<span class="title function_">push</span>(vm);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  vm.<span class="property">$parent</span> = parent;</span><br><span class="line">  vm.<span class="property">$root</span> = parent ? parent.<span class="property">$root</span> : vm; <span class="comment">// å½“å‰ç»„ä»¶æ ‘çš„æ ¹ Vue å®ä¾‹</span></span><br><span class="line"></span><br><span class="line">  vm.<span class="property">$children</span> = []; <span class="comment">// å½“å‰å®ä¾‹çš„ç›´æ¥å­ç»„ä»¶</span></span><br><span class="line">  vm.<span class="property">$refs</span> = &#123;&#125;;</span><br><span class="line"></span><br><span class="line">  vm.<span class="property">_watcher</span> = <span class="literal">null</span>;</span><br><span class="line">  <span class="comment">// lifeCycleçš„flag</span></span><br><span class="line">  vm.<span class="property">_inactive</span> = <span class="literal">null</span>;</span><br><span class="line">  vm.<span class="property">_directInactive</span> = <span class="literal">false</span>;</span><br><span class="line">  vm.<span class="property">_isMounted</span> = <span class="literal">false</span>;</span><br><span class="line">  vm.<span class="property">_isDestroyed</span> = <span class="literal">false</span>;</span><br><span class="line">  vm.<span class="property">_isBeingDestroyed</span> = <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>é¦–å…ˆæ‰¾åˆ°ç¬¬ä¸€ä¸ªéæŠ½è±¡çˆ¶ç»„ä»¶ï¼ˆkeep-aliveå°±æ˜¯æŠ½è±¡ç»„ä»¶ï¼‰</li><li>åˆå§‹åŒ–vmçš„ä¸€äº›å±æ€§</li></ul><h4 id="initEvents"><a href="#initEvents" class="headerlink" title="initEvents"></a>initEvents</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">initEvents</span> (vm) &#123;</span><br><span class="line">  vm.<span class="property">_events</span> = <span class="title class_">Object</span>.<span class="title function_">create</span>(<span class="literal">null</span>);</span><br><span class="line">  vm.<span class="property">_hasHookEvent</span> = <span class="literal">false</span>;</span><br><span class="line">  <span class="comment">// init parent attached events</span></span><br><span class="line">  <span class="keyword">var</span> listeners = vm.<span class="property">$options</span>.<span class="property">_parentListeners</span>;</span><br><span class="line">  <span class="keyword">if</span> (listeners) &#123;</span><br><span class="line">    <span class="title function_">updateComponentListeners</span>(vm, listeners);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>åˆå§‹åŒ–Vueå¯¹è±¡çš„eventsï¼ˆäº‹ä»¶ï¼‰åŠŸèƒ½ï¼ŒåŒ…æ‹¬ä½†ä¸é™äºï¼š<ul><li><strong>å¤„ç†çˆ¶ç»„ä»¶ä¼ é€’çš„äº‹ä»¶</strong></li><li><strong><code>this.$on</code>æ–¹æ³•æ³¨å†Œäº‹ä»¶</strong></li><li><strong><code>this.$emit</code>æ–¹æ³•è§¦å‘äº‹ä»¶</strong></li></ul></li></ul><h4 id="initRender"><a href="#initRender" class="headerlink" title="initRender"></a>initRender</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">initRender</span> (vm) &#123;</span><br><span class="line">  vm.<span class="property">_vnode</span> = <span class="literal">null</span>; <span class="comment">// the root of the child tree</span></span><br><span class="line">  vm.<span class="property">_staticTrees</span> = <span class="literal">null</span>; <span class="comment">// v-once cached trees</span></span><br><span class="line">  <span class="keyword">var</span> options = vm.<span class="property">$options</span>;</span><br><span class="line">  <span class="keyword">var</span> parentVnode = vm.<span class="property">$vnode</span> = options.<span class="property">_parentVnode</span>; <span class="comment">// the placeholder node in parent tree</span></span><br><span class="line">  <span class="keyword">var</span> renderContext = parentVnode &amp;&amp; parentVnode.<span class="property">context</span>;</span><br><span class="line">  vm.<span class="property">$slots</span> = <span class="title function_">resolveSlots</span>(options.<span class="property">_renderChildren</span>, renderContext);</span><br><span class="line">  vm.<span class="property">$scopedSlots</span> = emptyObject;</span><br><span class="line">  <span class="comment">// bind the createElement fn to this instance</span></span><br><span class="line">  <span class="comment">// so that we get proper render context inside it.</span></span><br><span class="line">  <span class="comment">// args order: tag, data, children, normalizationType, alwaysNormalize</span></span><br><span class="line">  <span class="comment">// internal version is used by render functions compiled from templates</span></span><br><span class="line">  vm.<span class="property">_c</span> = <span class="keyword">function</span> (<span class="params">a, b, c, d</span>) &#123; <span class="keyword">return</span> <span class="title function_">createElement</span>(vm, a, b, c, d, <span class="literal">false</span>); &#125;;</span><br><span class="line">  <span class="comment">// normalization is always applied for the public version, used in</span></span><br><span class="line">  <span class="comment">// user-written render functions.</span></span><br><span class="line">  vm.<span class="property">$createElement</span> = <span class="keyword">function</span> (<span class="params">a, b, c, d</span>) &#123; <span class="keyword">return</span> <span class="title function_">createElement</span>(vm, a, b, c, d, <span class="literal">true</span>); &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// $attrs &amp; $listeners are exposed for easier HOC creation.</span></span><br><span class="line">  <span class="comment">// they need to be reactive so that HOCs using them are always updated</span></span><br><span class="line">  <span class="keyword">var</span> parentData = parentVnode &amp;&amp; parentVnode.<span class="property">data</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* istanbul ignore else */</span></span><br><span class="line">  <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span>) &#123;</span><br><span class="line">    <span class="title function_">defineReactive$$1</span>(vm, <span class="string">&#x27;$attrs&#x27;</span>, parentData &amp;&amp; parentData.<span class="property">attrs</span> || emptyObject, <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">      !isUpdatingChildComponent &amp;&amp; <span class="title function_">warn</span>(<span class="string">&quot;$attrs is readonly.&quot;</span>, vm);</span><br><span class="line">    &#125;, <span class="literal">true</span>);</span><br><span class="line">    <span class="title function_">defineReactive$$1</span>(vm, <span class="string">&#x27;$listeners&#x27;</span>, options.<span class="property">_parentListeners</span> || emptyObject, <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">      !isUpdatingChildComponent &amp;&amp; <span class="title function_">warn</span>(<span class="string">&quot;$listeners is readonly.&quot;</span>, vm);</span><br><span class="line">    &#125;, <span class="literal">true</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="title function_">defineReactive$$1</span>(vm, <span class="string">&#x27;$attrs&#x27;</span>, parentData &amp;&amp; parentData.<span class="property">attrs</span> || emptyObject, <span class="literal">null</span>, <span class="literal">true</span>);</span><br><span class="line">    <span class="title function_">defineReactive$$1</span>(vm, <span class="string">&#x27;$listeners&#x27;</span>, options.<span class="property">_parentListeners</span> || emptyObject, <span class="literal">null</span>, <span class="literal">true</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><p>åˆå§‹åŒ–vmçš„ä¸€äº›å±æ€§</p><ul><li>_vnodeæŒ‡çš„æ˜¯Vueå¯¹è±¡æŒ‚è½½åˆ°DOMçš„VNode</li><li>$vnodeæŒ‡çš„æ˜¯Vueç»„ä»¶åœ¨parentä¸­templateä¸­çš„å ä½node</li></ul></li><li><p>resolveSlotså‡½æ•°è§£æç»„ä»¶ä¼ å…¥çš„slotï¼Œå¹¶èµ‹å€¼ç»™$slot</p><p>å‡½æ•°å®ç°å¦‚ä¸‹ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">resolveSlots</span> (</span><br><span class="line">  children,</span><br><span class="line">  context</span><br><span class="line">) &#123;</span><br><span class="line">  <span class="keyword">if</span> (!children || !children.<span class="property">length</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;&#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">var</span> slots = &#123;&#125;;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>, l = children.<span class="property">length</span>; i &lt; l; i++) &#123;</span><br><span class="line">    <span class="keyword">var</span> child = children[i];</span><br><span class="line">    <span class="keyword">var</span> data = child.<span class="property">data</span>;</span><br><span class="line">    <span class="comment">// remove slot attribute if the node is resolved as a Vue slot node</span></span><br><span class="line">    <span class="keyword">if</span> (data &amp;&amp; data.<span class="property">attrs</span> &amp;&amp; data.<span class="property">attrs</span>.<span class="property">slot</span>) &#123;</span><br><span class="line">      <span class="keyword">delete</span> data.<span class="property">attrs</span>.<span class="property">slot</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// named slots should only be respected if the vnode was rendered in the</span></span><br><span class="line">    <span class="comment">// same context.</span></span><br><span class="line">    <span class="keyword">if</span> ((child.<span class="property">context</span> === context || child.<span class="property">fnContext</span> === context) &amp;&amp;</span><br><span class="line">      data &amp;&amp; data.<span class="property">slot</span> != <span class="literal">null</span></span><br><span class="line">    ) &#123;</span><br><span class="line">      <span class="keyword">var</span> name = data.<span class="property">slot</span>;</span><br><span class="line">      <span class="keyword">var</span> slot = (slots[name] || (slots[name] = []));</span><br><span class="line">      <span class="keyword">if</span> (child.<span class="property">tag</span> === <span class="string">&#x27;template&#x27;</span>) &#123; <span class="comment">// è¿™é‡Œå¯¹templateè¿›è¡Œäº†ç‰¹æ®Šå¤„ç†</span></span><br><span class="line">        slot.<span class="property">push</span>.<span class="title function_">apply</span>(slot, child.<span class="property">children</span> || []);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        slot.<span class="title function_">push</span>(child);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      (slots.<span class="property">default</span> || (slots.<span class="property">default</span> = [])).<span class="title function_">push</span>(child);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// ignore slots that contains only whitespace</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> name$<span class="number">1</span> <span class="keyword">in</span> slots) &#123;</span><br><span class="line">    <span class="keyword">if</span> (slots[name$<span class="number">1</span>].<span class="title function_">every</span>(isWhitespace)) &#123;</span><br><span class="line">      <span class="keyword">delete</span> slots[name$<span class="number">1</span>];</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> slots</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>åŒæ—¶åˆ›å»ºäº†$createElementå‡½æ•°ï¼ˆ_cå‡½æ•°åŒç†ï¼‰ï¼Œç”¨äºVDOMç”Ÿæˆå®é™…DOM</p></li><li><p>æœ€åå¯¹<code>$attrs</code>å’Œ<code>$listeners</code>è¿›è¡Œäº†å“åº”å¼å¤„ç†</p></li></ul><h4 id="callHook-â€˜beforeCreatedâ€™"><a href="#callHook-â€˜beforeCreatedâ€™" class="headerlink" title="callHook(â€˜beforeCreatedâ€™)"></a>callHook(â€˜beforeCreatedâ€™)</h4><p>é¡¾åæ€ä¹‰ï¼Œæ­¤æ—¶è°ƒç”¨äº†<code>beforeCreated</code>ç”Ÿå‘½å‘¨æœŸå‡½æ•°</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">callHook</span> (vm, hook) &#123;</span><br><span class="line">  <span class="comment">// #7573 disable dep collection when invoking lifecycle hooks</span></span><br><span class="line">  <span class="title function_">pushTarget</span>();</span><br><span class="line">  <span class="keyword">var</span> handlers = vm.<span class="property">$options</span>[hook];</span><br><span class="line">  <span class="keyword">var</span> info = hook + <span class="string">&quot; hook&quot;</span>;</span><br><span class="line">  <span class="keyword">if</span> (handlers) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>, j = handlers.<span class="property">length</span>; i &lt; j; i++) &#123;</span><br><span class="line">      <span class="title function_">invokeWithErrorHandling</span>(handlers[i], vm, <span class="literal">null</span>, vm, info);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (vm.<span class="property">_hasHookEvent</span>) &#123;</span><br><span class="line">    vm.$emit(<span class="string">&#x27;hook:&#x27;</span> + hook);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">popTarget</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>å‡½æ•°å¤´å°¾ç¦æ­¢äº†Depçš„ä¾èµ–æ”¶é›†</li><li><code>handlers</code>æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œæ‰€ä»¥ç”Ÿå‘½å‘¨æœŸå‡½æ•°å¯ä»¥æ˜¯å¤šä¸ª</li><li><strong>invokeWithErrorHandlingå‡½æ•°çœŸæ­£æ‰§è¡Œç”Ÿå‘½å‘¨æœŸå‡½æ•°</strong></li></ul><h4 id="initInjections"><a href="#initInjections" class="headerlink" title="initInjections"></a>initInjections</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">initInjections</span> (vm) &#123;</span><br><span class="line">  <span class="keyword">var</span> result = <span class="title function_">resolveInject</span>(vm.<span class="property">$options</span>.<span class="property">inject</span>, vm);</span><br><span class="line">  <span class="keyword">if</span> (result) &#123;</span><br><span class="line">    <span class="title function_">toggleObserving</span>(<span class="literal">false</span>);</span><br><span class="line">    <span class="title class_">Object</span>.<span class="title function_">keys</span>(result).<span class="title function_">forEach</span>(<span class="keyword">function</span> (<span class="params">key</span>) &#123;</span><br><span class="line">      <span class="comment">/* istanbul ignore else */</span></span><br><span class="line">      <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span>) &#123;</span><br><span class="line">        <span class="title function_">defineReactive$$1</span>(vm, key, result[key], <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">          <span class="title function_">warn</span>(</span><br><span class="line">            <span class="string">&quot;Avoid mutating an injected value directly since the changes will be &quot;</span> +</span><br><span class="line">            <span class="string">&quot;overwritten whenever the provided component re-renders. &quot;</span> +</span><br><span class="line">            <span class="string">&quot;injection being mutated: \&quot;&quot;</span> + key + <span class="string">&quot;\&quot;&quot;</span>,</span><br><span class="line">            vm</span><br><span class="line">          );</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="title function_">defineReactive$$1</span>(vm, key, result[key]);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="title function_">toggleObserving</span>(<span class="literal">true</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><p>é¦–å…ˆæ‰¾åˆ°æ˜¯è°provideçš„å±æ€§</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">resolveInject</span> (inject, vm) &#123;</span><br><span class="line">  <span class="keyword">if</span> (inject) &#123;</span><br><span class="line">    <span class="comment">// inject is :any because flow is not smart enough to figure out cached</span></span><br><span class="line">    <span class="keyword">var</span> result = <span class="title class_">Object</span>.<span class="title function_">create</span>(<span class="literal">null</span>);</span><br><span class="line">    <span class="keyword">var</span> keys = hasSymbol</span><br><span class="line">      ? <span class="title class_">Reflect</span>.<span class="title function_">ownKeys</span>(inject)</span><br><span class="line">      : <span class="title class_">Object</span>.<span class="title function_">keys</span>(inject);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; keys.<span class="property">length</span>; i++) &#123;</span><br><span class="line">      <span class="keyword">var</span> key = keys[i];</span><br><span class="line">      <span class="comment">// #6574 in case the inject object is observed...</span></span><br><span class="line">      <span class="keyword">if</span> (key === <span class="string">&#x27;__ob__&#x27;</span>) &#123; <span class="keyword">continue</span> &#125;</span><br><span class="line">      <span class="keyword">var</span> provideKey = inject[key].<span class="property">from</span>;</span><br><span class="line">      <span class="keyword">var</span> source = vm;</span><br><span class="line">      <span class="keyword">while</span> (source) &#123;</span><br><span class="line">        <span class="keyword">if</span> (source.<span class="property">_provided</span> &amp;&amp; <span class="title function_">hasOwn</span>(source.<span class="property">_provided</span>, provideKey)) &#123;</span><br><span class="line">          result[key] = source.<span class="property">_provided</span>[provideKey];</span><br><span class="line">          <span class="keyword">break</span></span><br><span class="line">        &#125;</span><br><span class="line">        source = source.<span class="property">$parent</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (!source) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="string">&#x27;default&#x27;</span> <span class="keyword">in</span> inject[key]) &#123;</span><br><span class="line">          <span class="keyword">var</span> provideDefault = inject[key].<span class="property">default</span>;</span><br><span class="line">          result[key] = <span class="keyword">typeof</span> provideDefault === <span class="string">&#x27;function&#x27;</span></span><br><span class="line">            ? provideDefault.<span class="title function_">call</span>(vm)</span><br><span class="line">            : provideDefault;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span>) &#123;</span><br><span class="line">          <span class="title function_">warn</span>((<span class="string">&quot;Injection \&quot;&quot;</span> + key + <span class="string">&quot;\&quot; not found&quot;</span>), vm);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>æ‰¾åˆ°æ‰€æœ‰injectçš„keyå€¼ï¼Œç„¶åéå†çˆ¶ç»„ä»¶æ‰¾åˆ°å¯¹åº”çš„provideï¼Œè·å–è¡¨è¾¾å¼ï¼ˆå€¼ï¼‰</li></ul></li><li><p><strong>ç„¶åå¯¹è·å–çš„injectå€¼è¿›è¡Œå“åº”å¼å¤„ç†ï¼ˆdefineReactive$$1ï¼‰</strong></p></li></ul><h4 id="initState"><a href="#initState" class="headerlink" title="initState"></a>initState</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">initState</span> (vm) &#123;</span><br><span class="line">  vm.<span class="property">_watchers</span> = [];</span><br><span class="line">  <span class="keyword">var</span> opts = vm.<span class="property">$options</span>;</span><br><span class="line">  <span class="keyword">if</span> (opts.<span class="property">props</span>) &#123; <span class="title function_">initProps</span>(vm, opts.<span class="property">props</span>); &#125;</span><br><span class="line">  <span class="keyword">if</span> (opts.<span class="property">methods</span>) &#123; <span class="title function_">initMethods</span>(vm, opts.<span class="property">methods</span>); &#125;</span><br><span class="line">  <span class="keyword">if</span> (opts.<span class="property">data</span>) &#123;</span><br><span class="line">    <span class="title function_">initData</span>(vm);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="title function_">observe</span>(vm.<span class="property">_data</span> = &#123;&#125;, <span class="literal">true</span> <span class="comment">/* asRootData */</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (opts.<span class="property">computed</span>) &#123; <span class="title function_">initComputed</span>(vm, opts.<span class="property">computed</span>); &#125;</span><br><span class="line">  <span class="keyword">if</span> (opts.<span class="property">watch</span> &amp;&amp; opts.<span class="property">watch</span> !== nativeWatch) &#123;</span><br><span class="line">    <span class="title function_">initWatch</span>(vm, opts.<span class="property">watch</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>initStateå‡½æ•°ä¸­åˆå§‹åŒ–äº†æˆ‘ä»¬åœ¨optionä¸­å¸¸ç”¨çš„åŠŸèƒ½<ul><li>çˆ¶ç»„ä»¶ä¼ å€¼ï¼šprops</li><li>æ–¹æ³•ï¼šmethods</li><li>æ•°æ®ï¼šdata</li><li>è®¡ç®—å±æ€§ï¼šcomputed</li><li>ä¾¦å¬å™¨ï¼šwatch</li></ul></li></ul><h5 id="initProps"><a href="#initProps" class="headerlink" title="initProps"></a>initProps</h5><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">initProps</span> (vm, propsOptions) &#123;</span><br><span class="line">  <span class="keyword">var</span> propsData = vm.<span class="property">$options</span>.<span class="property">propsData</span> || &#123;&#125;;</span><br><span class="line">  <span class="keyword">var</span> props = vm.<span class="property">_props</span> = &#123;&#125;;</span><br><span class="line">  <span class="comment">// cache prop keys so that future props updates can iterate using Array</span></span><br><span class="line">  <span class="comment">// instead of dynamic object key enumeration.</span></span><br><span class="line">  <span class="keyword">var</span> keys = vm.<span class="property">$options</span>.<span class="property">_propKeys</span> = [];</span><br><span class="line">  <span class="keyword">var</span> isRoot = !vm.<span class="property">$parent</span>;</span><br><span class="line">  <span class="comment">// root instance props should be converted</span></span><br><span class="line">  <span class="keyword">if</span> (!isRoot) &#123;</span><br><span class="line">    <span class="title function_">toggleObserving</span>(<span class="literal">false</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">var</span> loop = <span class="keyword">function</span> (<span class="params"> key </span>) &#123;</span><br><span class="line">    keys.<span class="title function_">push</span>(key);</span><br><span class="line">    <span class="keyword">var</span> value = <span class="title function_">validateProp</span>(key, propsOptions, propsData, vm);</span><br><span class="line">    <span class="comment">/* istanbul ignore else */</span></span><br><span class="line">    <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span>) &#123;</span><br><span class="line">      <span class="keyword">var</span> hyphenatedKey = <span class="title function_">hyphenate</span>(key);</span><br><span class="line">      <span class="keyword">if</span> (<span class="title function_">isReservedAttribute</span>(hyphenatedKey) ||</span><br><span class="line">          config.<span class="title function_">isReservedAttr</span>(hyphenatedKey)) &#123;</span><br><span class="line">        <span class="title function_">warn</span>(</span><br><span class="line">          (<span class="string">&quot;\&quot;&quot;</span> + hyphenatedKey + <span class="string">&quot;\&quot; is a reserved attribute and cannot be used as component prop.&quot;</span>),</span><br><span class="line">          vm</span><br><span class="line">        );</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="title function_">defineReactive$$1</span>(props, key, value, <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!isRoot &amp;&amp; !isUpdatingChildComponent) &#123;</span><br><span class="line">          <span class="title function_">warn</span>(</span><br><span class="line">            <span class="string">&quot;Avoid mutating a prop directly since the value will be &quot;</span> +</span><br><span class="line">            <span class="string">&quot;overwritten whenever the parent component re-renders. &quot;</span> +</span><br><span class="line">            <span class="string">&quot;Instead, use a data or computed property based on the prop&#x27;s &quot;</span> +</span><br><span class="line">            <span class="string">&quot;value. Prop being mutated: \&quot;&quot;</span> + key + <span class="string">&quot;\&quot;&quot;</span>,</span><br><span class="line">            vm</span><br><span class="line">          );</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="title function_">defineReactive$$1</span>(props, key, value);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// static props are already proxied on the component&#x27;s prototype</span></span><br><span class="line">    <span class="comment">// during Vue.extend(). We only need to proxy props defined at</span></span><br><span class="line">    <span class="comment">// instantiation here.</span></span><br><span class="line">    <span class="keyword">if</span> (!(key <span class="keyword">in</span> vm)) &#123;</span><br><span class="line">      <span class="title function_">proxy</span>(vm, <span class="string">&quot;_props&quot;</span>, key);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> key <span class="keyword">in</span> propsOptions) <span class="title function_">loop</span>( key );</span><br><span class="line">  <span class="title function_">toggleObserving</span>(<span class="literal">true</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><p>å¾ªç¯éå†propsçš„å€¼</p></li><li><p>validatePropå‡½æ•°æ£€æµ‹propså±æ€§çš„å€¼å¹¶åšå¤„ç†</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">validateProp</span> (</span><br><span class="line">  key,</span><br><span class="line">  propOptions,</span><br><span class="line">  propsData,</span><br><span class="line">  vm</span><br><span class="line">) &#123;</span><br><span class="line">  <span class="keyword">var</span> prop = propOptions[key];</span><br><span class="line">  <span class="keyword">var</span> absent = !<span class="title function_">hasOwn</span>(propsData, key);</span><br><span class="line">  <span class="keyword">var</span> value = propsData[key];</span><br><span class="line">  <span class="comment">// boolean casting</span></span><br><span class="line">  <span class="keyword">var</span> booleanIndex = <span class="title function_">getTypeIndex</span>(<span class="title class_">Boolean</span>, prop.<span class="property">type</span>);</span><br><span class="line">  <span class="keyword">if</span> (booleanIndex &gt; -<span class="number">1</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (absent &amp;&amp; !<span class="title function_">hasOwn</span>(prop, <span class="string">&#x27;default&#x27;</span>)) &#123;</span><br><span class="line">      value = <span class="literal">false</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (value === <span class="string">&#x27;&#x27;</span> || value === <span class="title function_">hyphenate</span>(key)) &#123;</span><br><span class="line">      <span class="comment">// only cast empty string / same name to boolean if</span></span><br><span class="line">      <span class="comment">// boolean has higher priority</span></span><br><span class="line">      <span class="keyword">var</span> stringIndex = <span class="title function_">getTypeIndex</span>(<span class="title class_">String</span>, prop.<span class="property">type</span>);</span><br><span class="line">      <span class="keyword">if</span> (stringIndex &lt; <span class="number">0</span> || booleanIndex &lt; stringIndex) &#123;</span><br><span class="line">        value = <span class="literal">true</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// check default value</span></span><br><span class="line">  <span class="keyword">if</span> (value === <span class="literal">undefined</span>) &#123;</span><br><span class="line">    value = <span class="title function_">getPropDefaultValue</span>(vm, prop, key);</span><br><span class="line">    <span class="comment">// since the default value is a fresh copy,</span></span><br><span class="line">    <span class="comment">// make sure to observe it.</span></span><br><span class="line">    <span class="keyword">var</span> prevShouldObserve = shouldObserve;</span><br><span class="line">    <span class="title function_">toggleObserving</span>(<span class="literal">true</span>);</span><br><span class="line">    <span class="title function_">observe</span>(value);</span><br><span class="line">    <span class="title function_">toggleObserving</span>(prevShouldObserve);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (</span><br><span class="line">    process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span> &amp;&amp;</span><br><span class="line">    <span class="comment">// skip validation for weex recycle-list child component props</span></span><br><span class="line">    !(<span class="literal">false</span>)</span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="title function_">assertProp</span>(prop, key, value, vm, absent);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> value</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><strong>æ ¹æ®propsçš„typeå¤„ç†é»˜è®¤å€¼</strong></li><li><strong>ç¡®ä¿propsçš„å“åº”å¼</strong></li><li><strong>éªŒè¯ä¼ å…¥çš„props</strong></li></ul></li><li><p>æœ€åè¿›è¡Œä¸€æ¬¡å“åº”å¼å¤„ç†</p></li></ul><h5 id="initMethods"><a href="#initMethods" class="headerlink" title="initMethods"></a>initMethods</h5><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">initMethods</span> (vm, methods) &#123;</span><br><span class="line">  <span class="keyword">var</span> props = vm.<span class="property">$options</span>.<span class="property">props</span>;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> key <span class="keyword">in</span> methods) &#123;</span><br><span class="line">    <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">typeof</span> methods[key] !== <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">        <span class="title function_">warn</span>(</span><br><span class="line">          <span class="string">&quot;Method \&quot;&quot;</span> + key + <span class="string">&quot;\&quot; has type \&quot;&quot;</span> + (<span class="keyword">typeof</span> methods[key]) + <span class="string">&quot;\&quot; in the component definition. &quot;</span> +</span><br><span class="line">          <span class="string">&quot;Did you reference the function correctly?&quot;</span>,</span><br><span class="line">          vm</span><br><span class="line">        );</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (props &amp;&amp; <span class="title function_">hasOwn</span>(props, key)) &#123;</span><br><span class="line">        <span class="title function_">warn</span>(</span><br><span class="line">          (<span class="string">&quot;Method \&quot;&quot;</span> + key + <span class="string">&quot;\&quot; has already been defined as a prop.&quot;</span>),</span><br><span class="line">          vm</span><br><span class="line">        );</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> ((key <span class="keyword">in</span> vm) &amp;&amp; <span class="title function_">isReserved</span>(key)) &#123;</span><br><span class="line">        <span class="title function_">warn</span>(</span><br><span class="line">          <span class="string">&quot;Method \&quot;&quot;</span> + key + <span class="string">&quot;\&quot; conflicts with an existing Vue instance method. &quot;</span> +</span><br><span class="line">          <span class="string">&quot;Avoid defining component methods that start with _ or $.&quot;</span></span><br><span class="line">        );</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    vm[key] = <span class="keyword">typeof</span> methods[key] !== <span class="string">&#x27;function&#x27;</span> ? noop : <span class="title function_">bind</span>(methods[key], vm);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>åšäº†å†™ç®€å•çš„éªŒè¯ï¼Œä¹‹åé€šè¿‡bindå‡½æ•°ç»‘å®šthisï¼Œç„¶åæŒ‚è½½åˆ°vmï¼ˆVueå®ä¾‹ï¼‰ä¸Š</li></ul><h5 id="initData"><a href="#initData" class="headerlink" title="initData"></a>initData</h5><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">initData</span> (vm) &#123;</span><br><span class="line">  <span class="keyword">var</span> data = vm.<span class="property">$options</span>.<span class="property">data</span>;</span><br><span class="line">  data = vm.<span class="property">_data</span> = <span class="keyword">typeof</span> data === <span class="string">&#x27;function&#x27;</span></span><br><span class="line">    ? <span class="title function_">getData</span>(data, vm)</span><br><span class="line">    : data || &#123;&#125;;</span><br><span class="line">  <span class="keyword">if</span> (!<span class="title function_">isPlainObject</span>(data)) &#123;</span><br><span class="line">    data = &#123;&#125;;</span><br><span class="line">    process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span> &amp;&amp; <span class="title function_">warn</span>(</span><br><span class="line">      <span class="string">&#x27;data functions should return an object:\n&#x27;</span> +</span><br><span class="line">      <span class="string">&#x27;https://vuejs.org/v2/guide/components.html#data-Must-Be-a-Function&#x27;</span>,</span><br><span class="line">      vm</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// proxy data on instance</span></span><br><span class="line">  <span class="keyword">var</span> keys = <span class="title class_">Object</span>.<span class="title function_">keys</span>(data);</span><br><span class="line">  <span class="keyword">var</span> props = vm.<span class="property">$options</span>.<span class="property">props</span>;</span><br><span class="line">  <span class="keyword">var</span> methods = vm.<span class="property">$options</span>.<span class="property">methods</span>;</span><br><span class="line">  <span class="keyword">var</span> i = keys.<span class="property">length</span>;</span><br><span class="line">  <span class="keyword">while</span> (i--) &#123;</span><br><span class="line">    <span class="keyword">var</span> key = keys[i];</span><br><span class="line">    <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (methods &amp;&amp; <span class="title function_">hasOwn</span>(methods, key)) &#123;</span><br><span class="line">        <span class="title function_">warn</span>(</span><br><span class="line">          (<span class="string">&quot;Method \&quot;&quot;</span> + key + <span class="string">&quot;\&quot; has already been defined as a data property.&quot;</span>),</span><br><span class="line">          vm</span><br><span class="line">        );</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (props &amp;&amp; <span class="title function_">hasOwn</span>(props, key)) &#123;</span><br><span class="line">      process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span> &amp;&amp; <span class="title function_">warn</span>(</span><br><span class="line">        <span class="string">&quot;The data property \&quot;&quot;</span> + key + <span class="string">&quot;\&quot; is already declared as a prop. &quot;</span> +</span><br><span class="line">        <span class="string">&quot;Use prop default value instead.&quot;</span>,</span><br><span class="line">        vm</span><br><span class="line">      );</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!<span class="title function_">isReserved</span>(key)) &#123;</span><br><span class="line">      <span class="title function_">proxy</span>(vm, <span class="string">&quot;_data&quot;</span>, key);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// observe data</span></span><br><span class="line">  <span class="title function_">observe</span>(data, <span class="literal">true</span> <span class="comment">/* asRootData */</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>è·å–dataæ•°æ®ï¼Œå¦‚æœæ˜¯å‡½æ•°ï¼Œé€šè¿‡getDataå‡½æ•°è·å–é‡Œé¢çš„å€¼</li><li>è¿›è¡Œä¸€äº›ç®€å•çš„éªŒè¯<ul><li>æ–¹æ³•é‡åã€propsé‡åã€dataå‡½æ•°æ²¡æœ‰è¿”å›plainObje</li></ul></li><li>proxyä»£ç†<code>_data</code>å±æ€§</li><li><strong>å“åº”å¼å¤„ç†data</strong></li></ul><h5 id="initComputed"><a href="#initComputed" class="headerlink" title="initComputed"></a>initComputed</h5><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">initComputed</span> (vm, computed) &#123;</span><br><span class="line">  <span class="comment">// $flow-disable-line</span></span><br><span class="line">  <span class="keyword">var</span> watchers = vm.<span class="property">_computedWatchers</span> = <span class="title class_">Object</span>.<span class="title function_">create</span>(<span class="literal">null</span>);</span><br><span class="line">  <span class="comment">// computed properties are just getters during SSR</span></span><br><span class="line">  <span class="keyword">var</span> isSSR = <span class="title function_">isServerRendering</span>();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> key <span class="keyword">in</span> computed) &#123;</span><br><span class="line">    <span class="keyword">var</span> userDef = computed[key];</span><br><span class="line">    <span class="keyword">var</span> getter = <span class="keyword">typeof</span> userDef === <span class="string">&#x27;function&#x27;</span> ? userDef : userDef.<span class="property">get</span>;</span><br><span class="line">    <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span> &amp;&amp; getter == <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="title function_">warn</span>(</span><br><span class="line">        (<span class="string">&quot;Getter is missing for computed property \&quot;&quot;</span> + key + <span class="string">&quot;\&quot;.&quot;</span>),</span><br><span class="line">        vm</span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!isSSR) &#123;</span><br><span class="line">      <span class="comment">// create internal watcher for the computed property.</span></span><br><span class="line">      watchers[key] = <span class="keyword">new</span> <span class="title class_">Watcher</span>(</span><br><span class="line">        vm,</span><br><span class="line">        getter || noop,</span><br><span class="line">        noop,</span><br><span class="line">        computedWatcherOptions</span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// component-defined computed properties are already defined on the</span></span><br><span class="line">    <span class="comment">// component prototype. We only need to define computed properties defined</span></span><br><span class="line">    <span class="comment">// at instantiation here.</span></span><br><span class="line">    <span class="keyword">if</span> (!(key <span class="keyword">in</span> vm)) &#123;</span><br><span class="line">      <span class="title function_">defineComputed</span>(vm, key, userDef);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (key <span class="keyword">in</span> vm.<span class="property">$data</span>) &#123;</span><br><span class="line">        <span class="title function_">warn</span>((<span class="string">&quot;The computed property \&quot;&quot;</span> + key + <span class="string">&quot;\&quot; is already defined in data.&quot;</span>), vm);</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (vm.<span class="property">$options</span>.<span class="property">props</span> &amp;&amp; key <span class="keyword">in</span> vm.<span class="property">$options</span>.<span class="property">props</span>) &#123;</span><br><span class="line">        <span class="title function_">warn</span>((<span class="string">&quot;The computed property \&quot;&quot;</span> + key + <span class="string">&quot;\&quot; is already defined as a prop.&quot;</span>), vm);</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (vm.<span class="property">$options</span>.<span class="property">methods</span> &amp;&amp; key <span class="keyword">in</span> vm.<span class="property">$options</span>.<span class="property">methods</span>) &#123;</span><br><span class="line">        <span class="title function_">warn</span>((<span class="string">&quot;The computed property \&quot;&quot;</span> + key + <span class="string">&quot;\&quot; is already defined as a method.&quot;</span>), vm);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>é¦–å…ˆåˆ›å»ºäº†ä¸€ä¸ªcomputedä¸“ç”¨çš„watcheræ•°ç»„</li><li>éå†æ¯ä¸€ä¸ªcomputedï¼ŒåŒæ—¶ä¸ºä»–ä»¬æ¯ä¸€ä¸ªåˆ›å»ºä¸€ä¸ªwatcher</li><li>æœ€ådefineComputedå‡½æ•°åˆ™æŠŠcomputedæŒ‚è½½åˆ°vmä¸Šï¼Œå†…éƒ¨å®é™…ä½¿ç”¨çš„æ˜¯watcherçš„æ–¹æ³•</li></ul><h5 id="initWatch"><a href="#initWatch" class="headerlink" title="initWatch"></a>initWatch</h5><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">initWatch</span> (vm, watch) &#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> key <span class="keyword">in</span> watch) &#123;</span><br><span class="line">    <span class="keyword">var</span> handler = watch[key];</span><br><span class="line">    <span class="keyword">if</span> (<span class="title class_">Array</span>.<span class="title function_">isArray</span>(handler)) &#123;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; handler.<span class="property">length</span>; i++) &#123;</span><br><span class="line">        <span class="title function_">createWatcher</span>(vm, key, handler[i]);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="title function_">createWatcher</span>(vm, key, handler);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>éå†ç”¨æˆ·çš„watcheråˆ›å»ºï¼Œå†…éƒ¨ä½¿ç”¨<code>Vue.$watch</code>æ–¹æ³•</li><li><code>Vue.$watch</code>æ–¹æ³•åˆ™æ˜¯ä½¿ç”¨watcherï¼ˆè§‚å¯Ÿè€…å®ç°ï¼‰</li></ul><h4 id="initProvide"><a href="#initProvide" class="headerlink" title="initProvide"></a>initProvide</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">initProvide</span> (vm) &#123;</span><br><span class="line">  <span class="keyword">var</span> provide = vm.<span class="property">$options</span>.<span class="property">provide</span>;</span><br><span class="line">  <span class="keyword">if</span> (provide) &#123;</span><br><span class="line">    vm.<span class="property">_provided</span> = <span class="keyword">typeof</span> provide === <span class="string">&#x27;function&#x27;</span></span><br><span class="line">      ? provide.<span class="title function_">call</span>(vm)</span><br><span class="line">      : provide;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>å­˜åœ¨provideå°±æŒ‚è½½åˆ°vmä¸Š</li></ul><h4 id="callHook-â€˜createdâ€™"><a href="#callHook-â€˜createdâ€™" class="headerlink" title="callHook(â€˜createdâ€™)"></a>callHook(â€˜createdâ€™)</h4><ul><li>å’Œä¹‹å‰çš„ç”Ÿå‘½å‘¨æœŸå‡½æ•°ç›¸åŒï¼Œæ­¤æ—¶è°ƒç”¨<code>created</code>ç”Ÿå‘½å‘¨æœŸå‡½æ•°</li></ul><h3 id="mount"><a href="#mount" class="headerlink" title="$mount"></a>$mount</h3><ul><li><code>_init</code>å‡½æ•°çš„æœ€åä¸€æ­¥ï¼ˆå¦‚æœå­˜åœ¨elå±æ€§ï¼‰</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Vue</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">$mount</span> = <span class="keyword">function</span> (<span class="params"></span></span><br><span class="line"><span class="params">  el,</span></span><br><span class="line"><span class="params">  hydrating</span></span><br><span class="line"><span class="params"></span>) &#123;</span><br><span class="line">  el = el &amp;&amp; <span class="title function_">query</span>(el);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* istanbul ignore if */</span></span><br><span class="line">  <span class="keyword">if</span> (el === <span class="variable language_">document</span>.<span class="property">body</span> || el === <span class="variable language_">document</span>.<span class="property">documentElement</span>) &#123;</span><br><span class="line">    process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span> &amp;&amp; <span class="title function_">warn</span>(</span><br><span class="line">      <span class="string">&quot;Do not mount Vue to &lt;html&gt; or &lt;body&gt; - mount to normal elements instead.&quot;</span></span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> options = <span class="variable language_">this</span>.<span class="property">$options</span>;</span><br><span class="line">  <span class="comment">// resolve template/el and convert to render function</span></span><br><span class="line">  <span class="keyword">if</span> (!options.<span class="property">render</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> template = options.<span class="property">template</span>;</span><br><span class="line">    <span class="keyword">if</span> (template) &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">typeof</span> template === <span class="string">&#x27;string&#x27;</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (template.<span class="title function_">charAt</span>(<span class="number">0</span>) === <span class="string">&#x27;#&#x27;</span>) &#123;</span><br><span class="line">          template = <span class="title function_">idToTemplate</span>(template);</span><br><span class="line">          <span class="comment">/* istanbul ignore if */</span></span><br><span class="line">          <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span> &amp;&amp; !template) &#123;</span><br><span class="line">            <span class="title function_">warn</span>(</span><br><span class="line">              (<span class="string">&quot;Template element not found or is empty: &quot;</span> + (options.<span class="property">template</span>)),</span><br><span class="line">              <span class="variable language_">this</span></span><br><span class="line">            );</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (template.<span class="property">nodeType</span>) &#123;</span><br><span class="line">        template = template.<span class="property">innerHTML</span>;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span>) &#123;</span><br><span class="line">          <span class="title function_">warn</span>(<span class="string">&#x27;invalid template option:&#x27;</span> + template, <span class="variable language_">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">this</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (el) &#123;</span><br><span class="line">      template = <span class="title function_">getOuterHTML</span>(el);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (template) &#123;</span><br><span class="line">      <span class="comment">/* istanbul ignore if */</span></span><br><span class="line">      <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span> &amp;&amp; config.<span class="property">performance</span> &amp;&amp; mark) &#123;</span><br><span class="line">        <span class="title function_">mark</span>(<span class="string">&#x27;compile&#x27;</span>);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">var</span> ref = <span class="title function_">compileToFunctions</span>(template, &#123;</span><br><span class="line">        <span class="attr">outputSourceRange</span>: process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span>,</span><br><span class="line">        <span class="attr">shouldDecodeNewlines</span>: shouldDecodeNewlines,</span><br><span class="line">        <span class="attr">shouldDecodeNewlinesForHref</span>: shouldDecodeNewlinesForHref,</span><br><span class="line">        <span class="attr">delimiters</span>: options.<span class="property">delimiters</span>,</span><br><span class="line">        <span class="attr">comments</span>: options.<span class="property">comments</span></span><br><span class="line">      &#125;, <span class="variable language_">this</span>);</span><br><span class="line">      <span class="keyword">var</span> render = ref.<span class="property">render</span>;</span><br><span class="line">      <span class="keyword">var</span> staticRenderFns = ref.<span class="property">staticRenderFns</span>;</span><br><span class="line">      options.<span class="property">render</span> = render;</span><br><span class="line">      options.<span class="property">staticRenderFns</span> = staticRenderFns;</span><br><span class="line"></span><br><span class="line">      <span class="comment">/* istanbul ignore if */</span></span><br><span class="line">      <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span> &amp;&amp; config.<span class="property">performance</span> &amp;&amp; mark) &#123;</span><br><span class="line">        <span class="title function_">mark</span>(<span class="string">&#x27;compile end&#x27;</span>);</span><br><span class="line">        <span class="title function_">measure</span>((<span class="string">&quot;vue &quot;</span> + (<span class="variable language_">this</span>.<span class="property">_name</span>) + <span class="string">&quot; compile&quot;</span>), <span class="string">&#x27;compile&#x27;</span>, <span class="string">&#x27;compile end&#x27;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> mount.<span class="title function_">call</span>(<span class="variable language_">this</span>, el, hydrating)</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><ul><li><p>é¦–å…ˆä½¿ç”¨<code>query</code>å‡½æ•°æŸ¥è¯¢<code>el</code>æŒ‡å®šçš„DOMèŠ‚ç‚¹</p></li><li><p><strong>ç„¶åæ£€æŸ¥<code>template</code>å¹¶å°†æ¨¡æ¿ç¼–è¯‘ä¸ºæ¸²æŸ“å‡½æ•°ï¼ˆrenderï¼‰</strong></p><ul><li><strong>æ¨¡æ¿ç¼–è¯‘å‡½æ•°ï¼šcompileToFunctions</strong><ul><li><strong>å†…éƒ¨ä¼šå°†templateå¤„ç†ä¸ºastï¼Œç„¶åè½¬æ¢ä¸º<code>$createElement</code>å‡½æ•°å¯ä»¥å¤„ç†çš„VDOMï¼Œ<code>$createElement</code>å¤„ç†ä¹‹åå°±ä¼šç”ŸæˆVNode</strong></li></ul></li><li><strong>è¿™ä¹Ÿæ˜¯Vueå¯ä»¥æ”¯æŒJSXå†™æ³•çš„åŸå› </strong></li></ul></li><li><p>æœ€åè°ƒç”¨mountå‡½æ•°</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// public mount method</span></span><br><span class="line"><span class="title class_">Vue</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">$mount</span> = <span class="keyword">function</span> (<span class="params"></span></span><br><span class="line"><span class="params">  el,</span></span><br><span class="line"><span class="params">  hydrating</span></span><br><span class="line"><span class="params"></span>) &#123;</span><br><span class="line">  el = el &amp;&amp; inBrowser ? <span class="title function_">query</span>(el) : <span class="literal">undefined</span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">mountComponent</span>(<span class="variable language_">this</span>, el, hydrating)</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><ul><li>æ³¨æ„è¿™ä¸ªmountå’Œä¹‹å‰çš„$mountå‡½æ•°ä¸åŒ</li></ul></li></ul><h3 id="mountComponent"><a href="#mountComponent" class="headerlink" title="mountComponent"></a>mountComponent</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">mountComponent</span> (</span><br><span class="line">  vm,</span><br><span class="line">  el,</span><br><span class="line">  hydrating</span><br><span class="line">) &#123;</span><br><span class="line">  vm.<span class="property">$el</span> = el;</span><br><span class="line">  <span class="keyword">if</span> (!vm.<span class="property">$options</span>.<span class="property">render</span>) &#123;</span><br><span class="line">    vm.<span class="property">$options</span>.<span class="property">render</span> = createEmptyVNode;</span><br><span class="line">    <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span>) &#123;</span><br><span class="line">      <span class="comment">/* istanbul ignore if */</span></span><br><span class="line">      <span class="keyword">if</span> ((vm.<span class="property">$options</span>.<span class="property">template</span> &amp;&amp; vm.<span class="property">$options</span>.<span class="property">template</span>.<span class="title function_">charAt</span>(<span class="number">0</span>) !== <span class="string">&#x27;#&#x27;</span>) ||</span><br><span class="line">        vm.<span class="property">$options</span>.<span class="property">el</span> || el) &#123;</span><br><span class="line">        <span class="title function_">warn</span>(</span><br><span class="line">          <span class="string">&#x27;You are using the runtime-only build of Vue where the template &#x27;</span> +</span><br><span class="line">          <span class="string">&#x27;compiler is not available. Either pre-compile the templates into &#x27;</span> +</span><br><span class="line">          <span class="string">&#x27;render functions, or use the compiler-included build.&#x27;</span>,</span><br><span class="line">          vm</span><br><span class="line">        );</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="title function_">warn</span>(</span><br><span class="line">          <span class="string">&#x27;Failed to mount component: template or render function not defined.&#x27;</span>,</span><br><span class="line">          vm</span><br><span class="line">        );</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">callHook</span>(vm, <span class="string">&#x27;beforeMount&#x27;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> updateComponent;</span><br><span class="line">  <span class="comment">/* istanbul ignore if */</span></span><br><span class="line">  <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span> &amp;&amp; config.<span class="property">performance</span> &amp;&amp; mark) &#123;</span><br><span class="line">    updateComponent = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">      <span class="keyword">var</span> name = vm.<span class="property">_name</span>;</span><br><span class="line">      <span class="keyword">var</span> id = vm.<span class="property">_uid</span>;</span><br><span class="line">      <span class="keyword">var</span> startTag = <span class="string">&quot;vue-perf-start:&quot;</span> + id;</span><br><span class="line">      <span class="keyword">var</span> endTag = <span class="string">&quot;vue-perf-end:&quot;</span> + id;</span><br><span class="line"></span><br><span class="line">      <span class="title function_">mark</span>(startTag);</span><br><span class="line">      <span class="keyword">var</span> vnode = vm.<span class="title function_">_render</span>();</span><br><span class="line">      <span class="title function_">mark</span>(endTag);</span><br><span class="line">      <span class="title function_">measure</span>((<span class="string">&quot;vue &quot;</span> + name + <span class="string">&quot; render&quot;</span>), startTag, endTag);</span><br><span class="line"></span><br><span class="line">      <span class="title function_">mark</span>(startTag);</span><br><span class="line">      vm.<span class="title function_">_update</span>(vnode, hydrating);</span><br><span class="line">      <span class="title function_">mark</span>(endTag);</span><br><span class="line">      <span class="title function_">measure</span>((<span class="string">&quot;vue &quot;</span> + name + <span class="string">&quot; patch&quot;</span>), startTag, endTag);</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    updateComponent = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">      vm.<span class="title function_">_update</span>(vm.<span class="title function_">_render</span>(), hydrating);</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// we set this to vm._watcher inside the watcher&#x27;s constructor</span></span><br><span class="line">  <span class="comment">// since the watcher&#x27;s initial patch may call $forceUpdate (e.g. inside child</span></span><br><span class="line">  <span class="comment">// component&#x27;s mounted hook), which relies on vm._watcher being already defined</span></span><br><span class="line">  <span class="keyword">new</span> <span class="title class_">Watcher</span>(vm, updateComponent, noop, &#123;</span><br><span class="line">    <span class="attr">before</span>: <span class="keyword">function</span> <span class="title function_">before</span> () &#123;</span><br><span class="line">      <span class="keyword">if</span> (vm.<span class="property">_isMounted</span> &amp;&amp; !vm.<span class="property">_isDestroyed</span>) &#123;</span><br><span class="line">        <span class="title function_">callHook</span>(vm, <span class="string">&#x27;beforeUpdate&#x27;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;, <span class="literal">true</span> <span class="comment">/* isRenderWatcher */</span>);</span><br><span class="line">  hydrating = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// manually mounted instance, call mounted on self</span></span><br><span class="line">  <span class="comment">// mounted is called for render-created child components in its inserted hook</span></span><br><span class="line">  <span class="keyword">if</span> (vm.<span class="property">$vnode</span> == <span class="literal">null</span>) &#123;</span><br><span class="line">    vm.<span class="property">_isMounted</span> = <span class="literal">true</span>;</span><br><span class="line">    <span class="title function_">callHook</span>(vm, <span class="string">&#x27;mounted&#x27;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> vm</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>é¦–å…ˆä¼šæ£€æµ‹optionçš„renderå‡½æ•°æ˜¯å¦å­˜åœ¨ï¼ˆtemplateç¼–è¯‘çš„æˆ–è€…JSXï¼‰</li><li><strong>æ¥ç€æ‰§è¡Œ<code>beforeMounted</code>ç”Ÿå‘½å‘¨æœŸå‡½æ•°</strong></li><li><strong>åˆ›å»º<code>updateComponent</code>å‡½æ•°ï¼Œå†…éƒ¨ä½¿ç”¨<code>vm._udpate(vm._render)</code></strong></li><li>ä»¥<code>updateComponent</code>å‡½æ•°ä¸º<code>exprOrFn</code>åˆ›å»ºwatcher</li><li>æœ€åæ‰§è¡Œæœ¬ç»„ä»¶çš„<code>mounted</code>ç”Ÿå‘½å‘¨æœŸå‡½æ•°</li></ul><h4 id="Watcher"><a href="#Watcher" class="headerlink" title="Watcher"></a>Watcher</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> <span class="title class_">Watcher</span> = <span class="keyword">function</span> <span class="title function_">Watcher</span> (</span><br><span class="line">  vm,</span><br><span class="line">  expOrFn,</span><br><span class="line">  cb,</span><br><span class="line">  options,</span><br><span class="line">  isRenderWatcher</span><br><span class="line">) &#123;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">vm</span> = vm;</span><br><span class="line">  <span class="keyword">if</span> (isRenderWatcher) &#123;</span><br><span class="line">    vm.<span class="property">_watcher</span> = <span class="variable language_">this</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  vm.<span class="property">_watchers</span>.<span class="title function_">push</span>(<span class="variable language_">this</span>);</span><br><span class="line">  <span class="comment">// options</span></span><br><span class="line">  <span class="keyword">if</span> (options) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">deep</span> = !!options.<span class="property">deep</span>;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">user</span> = !!options.<span class="property">user</span>;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">lazy</span> = !!options.<span class="property">lazy</span>;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">sync</span> = !!options.<span class="property">sync</span>;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">before</span> = options.<span class="property">before</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">deep</span> = <span class="variable language_">this</span>.<span class="property">user</span> = <span class="variable language_">this</span>.<span class="property">lazy</span> = <span class="variable language_">this</span>.<span class="property">sync</span> = <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">cb</span> = cb;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">id</span> = ++uid$<span class="number">2</span>; <span class="comment">// uid for batching</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">active</span> = <span class="literal">true</span>;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">dirty</span> = <span class="variable language_">this</span>.<span class="property">lazy</span>; <span class="comment">// for lazy watchers</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">deps</span> = [];</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">newDeps</span> = [];</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">depIds</span> = <span class="keyword">new</span> <span class="title function_">_Set</span>();</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">newDepIds</span> = <span class="keyword">new</span> <span class="title function_">_Set</span>();</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">expression</span> = process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span></span><br><span class="line">    ? expOrFn.<span class="title function_">toString</span>()</span><br><span class="line">    : <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">  <span class="comment">// parse expression for getter</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> expOrFn === <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">getter</span> = expOrFn;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">getter</span> = <span class="title function_">parsePath</span>(expOrFn);</span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">getter</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">getter</span> = noop;</span><br><span class="line">      process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span> &amp;&amp; <span class="title function_">warn</span>(</span><br><span class="line">        <span class="string">&quot;Failed watching path: \&quot;&quot;</span> + expOrFn + <span class="string">&quot;\&quot; &quot;</span> +</span><br><span class="line">        <span class="string">&#x27;Watcher only accepts simple dot-delimited paths. &#x27;</span> +</span><br><span class="line">        <span class="string">&#x27;For full control, use a function instead.&#x27;</span>,</span><br><span class="line">        vm</span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">value</span> = <span class="variable language_">this</span>.<span class="property">lazy</span></span><br><span class="line">    ? <span class="literal">undefined</span></span><br><span class="line">    : <span class="variable language_">this</span>.<span class="title function_">get</span>();</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><ul><li><p>Watcheråˆå§‹åŒ–æœ€åä¼šé€šè¿‡<code>get</code>å‡½æ•°è·å–åˆå§‹å€¼</p></li><li><p><strong><code>get</code>å‡½æ•°åˆ™æ˜¯é€šè¿‡è°ƒç”¨Watcheråˆå§‹åŒ–çš„getterè·å–å€¼</strong></p><ul><li><p>é‚£ä¹ˆæœ€åå°±æ˜¯è°ƒç”¨<code>mountComponent</code>å‡½æ•°ä¸­å£°æ˜çš„<code>updateComponent</code>å‡½æ•°</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">updateComponent = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    vm.<span class="title function_">_update</span>(vm.<span class="title function_">_render</span>(), hydrating);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></li></ul></li></ul><h4 id="render"><a href="#render" class="headerlink" title="_render"></a>_render</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Vue</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">_render</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> vm = <span class="variable language_">this</span>;</span><br><span class="line">    <span class="keyword">var</span> ref = vm.<span class="property">$options</span>;</span><br><span class="line">    <span class="keyword">var</span> render = ref.<span class="property">render</span>;</span><br><span class="line">    <span class="keyword">var</span> _parentVnode = ref.<span class="property">_parentVnode</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (_parentVnode) &#123;</span><br><span class="line">        vm.<span class="property">$scopedSlots</span> = <span class="title function_">normalizeScopedSlots</span>(</span><br><span class="line">            _parentVnode.<span class="property">data</span>.<span class="property">scopedSlots</span>,</span><br><span class="line">            vm.<span class="property">$slots</span>,</span><br><span class="line">            vm.<span class="property">$scopedSlots</span></span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// set parent vnode. this allows render functions to have access</span></span><br><span class="line">    <span class="comment">// to the data on the placeholder node.</span></span><br><span class="line">    vm.<span class="property">$vnode</span> = _parentVnode;</span><br><span class="line">    <span class="comment">// render self</span></span><br><span class="line">    <span class="keyword">var</span> vnode;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// There&#x27;s no need to maintain a stack because all render fns are called</span></span><br><span class="line">        <span class="comment">// separately from one another. Nested component&#x27;s render fns are called</span></span><br><span class="line">        <span class="comment">// when parent component is patched.</span></span><br><span class="line">        currentRenderingInstance = vm;</span><br><span class="line">        vnode = render.<span class="title function_">call</span>(vm.<span class="property">_renderProxy</span>, vm.<span class="property">$createElement</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">        <span class="title function_">handleError</span>(e, vm, <span class="string">&quot;render&quot;</span>);</span><br><span class="line">        <span class="comment">// return error render result,</span></span><br><span class="line">        <span class="comment">// or previous vnode to prevent render error causing blank component</span></span><br><span class="line">        <span class="comment">/* istanbul ignore else */</span></span><br><span class="line">        <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span> &amp;&amp; vm.<span class="property">$options</span>.<span class="property">renderError</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                vnode = vm.<span class="property">$options</span>.<span class="property">renderError</span>.<span class="title function_">call</span>(vm.<span class="property">_renderProxy</span>, vm.<span class="property">$createElement</span>, e);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">                <span class="title function_">handleError</span>(e, vm, <span class="string">&quot;renderError&quot;</span>);</span><br><span class="line">                vnode = vm.<span class="property">_vnode</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            vnode = vm.<span class="property">_vnode</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        currentRenderingInstance = <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// if the returned array contains only a single node, allow it</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="title class_">Array</span>.<span class="title function_">isArray</span>(vnode) &amp;&amp; vnode.<span class="property">length</span> === <span class="number">1</span>) &#123;</span><br><span class="line">        vnode = vnode[<span class="number">0</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// return empty vnode in case the render function errored out</span></span><br><span class="line">    <span class="keyword">if</span> (!(vnode <span class="keyword">instanceof</span> <span class="title class_">VNode</span>)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span> &amp;&amp; <span class="title class_">Array</span>.<span class="title function_">isArray</span>(vnode)) &#123;</span><br><span class="line">            <span class="title function_">warn</span>(</span><br><span class="line">                <span class="string">&#x27;Multiple root nodes returned from render function. Render function &#x27;</span> +</span><br><span class="line">                <span class="string">&#x27;should return a single root node.&#x27;</span>,</span><br><span class="line">                vm</span><br><span class="line">            );</span><br><span class="line">        &#125;</span><br><span class="line">        vnode = <span class="title function_">createEmptyVNode</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// set parent</span></span><br><span class="line">    vnode.<span class="property">parent</span> = _parentVnode;</span><br><span class="line">    <span class="keyword">return</span> vnode</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><ul><li><strong><code>_render</code>å‡½æ•°ä¸»è¦é€šè¿‡ä¼ å…¥<code>$createElement</code>å‡½æ•°ç”ŸæˆVNodeï¼Œå¹¶è¿”å›</strong></li></ul><h4 id="update"><a href="#update" class="headerlink" title="_update"></a>_update</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Vue</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">_update</span> = <span class="keyword">function</span> (<span class="params">vnode, hydrating</span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> vm = <span class="variable language_">this</span>;</span><br><span class="line">  <span class="keyword">var</span> prevEl = vm.<span class="property">$el</span>;</span><br><span class="line">  <span class="keyword">var</span> prevVnode = vm.<span class="property">_vnode</span>;</span><br><span class="line">  <span class="keyword">var</span> restoreActiveInstance = <span class="title function_">setActiveInstance</span>(vm);</span><br><span class="line">  vm.<span class="property">_vnode</span> = vnode;</span><br><span class="line">  <span class="comment">// Vue.prototype.__patch__ is injected in entry points</span></span><br><span class="line">  <span class="comment">// based on the rendering backend used.</span></span><br><span class="line">  <span class="keyword">if</span> (!prevVnode) &#123;</span><br><span class="line">    <span class="comment">// initial render</span></span><br><span class="line">    vm.<span class="property">$el</span> = vm.<span class="title function_">__patch__</span>(vm.<span class="property">$el</span>, vnode, hydrating, <span class="literal">false</span> <span class="comment">/* removeOnly */</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// updates</span></span><br><span class="line">    vm.<span class="property">$el</span> = vm.<span class="title function_">__patch__</span>(prevVnode, vnode);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">restoreActiveInstance</span>();</span><br><span class="line">  <span class="comment">// update __vue__ reference</span></span><br><span class="line">  <span class="keyword">if</span> (prevEl) &#123;</span><br><span class="line">    prevEl.<span class="property">__vue__</span> = <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (vm.<span class="property">$el</span>) &#123;</span><br><span class="line">    vm.<span class="property">$el</span>.<span class="property">__vue__</span> = vm;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// if parent is an HOC, update its $el as well</span></span><br><span class="line">  <span class="keyword">if</span> (vm.<span class="property">$vnode</span> &amp;&amp; vm.<span class="property">$parent</span> &amp;&amp; vm.<span class="property">$vnode</span> === vm.<span class="property">$parent</span>.<span class="property">_vnode</span>) &#123;</span><br><span class="line">    vm.<span class="property">$parent</span>.<span class="property">$el</span> = vm.<span class="property">$el</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// updated hook is called by the scheduler to ensure that children are</span></span><br><span class="line">  <span class="comment">// updated in a parent&#x27;s updated hook.</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><ul><li><strong><code>_update</code>å‡½æ•°ä¸»è¦é€šè¿‡patchå‡½æ•°å°†VNodeè½¬åŒ–ä¸ºå®é™…DOM</strong></li></ul><h4 id="patch"><a href="#patch" class="headerlink" title="patch"></a>patch</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">patch</span> (oldVnode, vnode, hydrating, removeOnly) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_">isUndef</span>(vnode)) &#123;</span><br><span class="line">        <span class="comment">// æ— æ–°VNodeï¼Œå­˜åœ¨æ—§VNodeï¼Œåˆ é™¤æ—§VNodeå³å¯</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_">isDef</span>(oldVnode)) &#123; <span class="title function_">invokeDestroyHook</span>(oldVnode); &#125;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> isInitialPatch = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">var</span> insertedVnodeQueue = [];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_">isUndef</span>(oldVnode)) &#123;</span><br><span class="line">        <span class="comment">// ä¸å­˜åœ¨æ—§èŠ‚ç‚¹ï¼Œç›´æ¥æ ¹æ®æ–°VNodeåˆ›å»ºæ–°èŠ‚ç‚¹å³å¯</span></span><br><span class="line">        <span class="comment">// empty mount (likely as component), create new root element</span></span><br><span class="line">        isInitialPatch = <span class="literal">true</span>;</span><br><span class="line">        <span class="title function_">createElm</span>(vnode, insertedVnodeQueue);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">var</span> isRealElement = <span class="title function_">isDef</span>(oldVnode.<span class="property">nodeType</span>);</span><br><span class="line">        <span class="keyword">if</span> (!isRealElement &amp;&amp; <span class="title function_">sameVnode</span>(oldVnode, vnode)) &#123;</span><br><span class="line">            <span class="comment">// patch existing root node</span></span><br><span class="line">            <span class="title function_">patchVnode</span>(oldVnode, vnode, insertedVnodeQueue, <span class="literal">null</span>, <span class="literal">null</span>, removeOnly);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (isRealElement) &#123;</span><br><span class="line">                <span class="comment">// mounting to a real element</span></span><br><span class="line">                <span class="comment">// check if this is server-rendered content and if we can perform</span></span><br><span class="line">                <span class="comment">// a successful hydration.</span></span><br><span class="line">                <span class="keyword">if</span> (oldVnode.<span class="property">nodeType</span> === <span class="number">1</span> &amp;&amp; oldVnode.<span class="title function_">hasAttribute</span>(<span class="variable constant_">SSR_ATTR</span>)) &#123;</span><br><span class="line">                    oldVnode.<span class="title function_">removeAttribute</span>(<span class="variable constant_">SSR_ATTR</span>);</span><br><span class="line">                    hydrating = <span class="literal">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (<span class="title function_">isTrue</span>(hydrating)) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (<span class="title function_">hydrate</span>(oldVnode, vnode, insertedVnodeQueue)) &#123;</span><br><span class="line">                        <span class="title function_">invokeInsertHook</span>(vnode, insertedVnodeQueue, <span class="literal">true</span>);</span><br><span class="line">                        <span class="keyword">return</span> oldVnode</span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span>) &#123;</span><br><span class="line">                        <span class="title function_">warn</span>(</span><br><span class="line">                            <span class="string">&#x27;The client-side rendered virtual DOM tree is not matching &#x27;</span> +</span><br><span class="line">                            <span class="string">&#x27;server-rendered content. This is likely caused by incorrect &#x27;</span> +</span><br><span class="line">                            <span class="string">&#x27;HTML markup, for example nesting block-level elements inside &#x27;</span> +</span><br><span class="line">                            <span class="string">&#x27;&lt;p&gt;, or missing &lt;tbody&gt;. Bailing hydration and performing &#x27;</span> +</span><br><span class="line">                            <span class="string">&#x27;full client-side render.&#x27;</span></span><br><span class="line">                        );</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// either not server-rendered, or hydration failed.</span></span><br><span class="line">                <span class="comment">// create an empty node and replace it</span></span><br><span class="line">                oldVnode = <span class="title function_">emptyNodeAt</span>(oldVnode);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// replacing existing element</span></span><br><span class="line">            <span class="keyword">var</span> oldElm = oldVnode.<span class="property">elm</span>;</span><br><span class="line">            <span class="keyword">var</span> parentElm = nodeOps.<span class="title function_">parentNode</span>(oldElm);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// create new node</span></span><br><span class="line">            <span class="title function_">createElm</span>(</span><br><span class="line">                vnode,</span><br><span class="line">                insertedVnodeQueue,</span><br><span class="line">                <span class="comment">// extremely rare edge case: do not insert if old element is in a</span></span><br><span class="line">                <span class="comment">// leaving transition. Only happens when combining transition +</span></span><br><span class="line">                <span class="comment">// keep-alive + HOCs. (#4590)</span></span><br><span class="line">                oldElm.<span class="property">_leaveCb</span> ? <span class="literal">null</span> : parentElm,</span><br><span class="line">                nodeOps.<span class="title function_">nextSibling</span>(oldElm)</span><br><span class="line">            );</span><br><span class="line"></span><br><span class="line">            <span class="comment">// update parent placeholder node element, recursively</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="title function_">isDef</span>(vnode.<span class="property">parent</span>)) &#123;</span><br><span class="line">                <span class="keyword">var</span> ancestor = vnode.<span class="property">parent</span>;</span><br><span class="line">                <span class="keyword">var</span> patchable = <span class="title function_">isPatchable</span>(vnode);</span><br><span class="line">                <span class="keyword">while</span> (ancestor) &#123;</span><br><span class="line">                    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; cbs.<span class="property">destroy</span>.<span class="property">length</span>; ++i) &#123;</span><br><span class="line">                        cbs.<span class="property">destroy</span>[i](ancestor);</span><br><span class="line">                    &#125;</span><br><span class="line">                    ancestor.<span class="property">elm</span> = vnode.<span class="property">elm</span>;</span><br><span class="line">                    <span class="keyword">if</span> (patchable) &#123;</span><br><span class="line">                        <span class="keyword">for</span> (<span class="keyword">var</span> i$<span class="number">1</span> = <span class="number">0</span>; i$<span class="number">1</span> &lt; cbs.<span class="property">create</span>.<span class="property">length</span>; ++i$<span class="number">1</span>) &#123;</span><br><span class="line">                            cbs.<span class="property">create</span>[i$<span class="number">1</span>](emptyNode, ancestor);</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="comment">// #6513</span></span><br><span class="line">                        <span class="comment">// invoke insert hooks that may have been merged by create hooks.</span></span><br><span class="line">                        <span class="comment">// e.g. for directives that uses the &quot;inserted&quot; hook.</span></span><br><span class="line">                        <span class="keyword">var</span> insert = ancestor.<span class="property">data</span>.<span class="property">hook</span>.<span class="property">insert</span>;</span><br><span class="line">                        <span class="keyword">if</span> (insert.<span class="property">merged</span>) &#123;</span><br><span class="line">                            <span class="comment">// start at index 1 to avoid re-invoking component mounted hook</span></span><br><span class="line">                            <span class="keyword">for</span> (<span class="keyword">var</span> i$<span class="number">2</span> = <span class="number">1</span>; i$<span class="number">2</span> &lt; insert.<span class="property">fns</span>.<span class="property">length</span>; i$<span class="number">2</span>++) &#123;</span><br><span class="line">                                insert.<span class="property">fns</span>[i$<span class="number">2</span>]();</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="title function_">registerRef</span>(ancestor);</span><br><span class="line">                    &#125;</span><br><span class="line">                    ancestor = ancestor.<span class="property">parent</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// destroy old node</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="title function_">isDef</span>(parentElm)) &#123;</span><br><span class="line">                <span class="title function_">removeVnodes</span>([oldVnode], <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="title function_">isDef</span>(oldVnode.<span class="property">tag</span>)) &#123;</span><br><span class="line">                <span class="title function_">invokeDestroyHook</span>(oldVnode);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">invokeInsertHook</span>(vnode, insertedVnodeQueue, isInitialPatch);</span><br><span class="line">    <span class="keyword">return</span> vnode.<span class="property">elm</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><p><strong><code>patch</code>å‡½æ•°æ˜¯çœŸæ­£æ›´æ–°DOMçš„é‡è¦å‡½æ•°ï¼Œæ ¹æ®æƒ…å†µä¸åŒï¼Œæ›´æ–°æ–¹å¼ä¹Ÿä¸åŒ</strong></p><ul><li><strong><code>patchVnode</code>å‡½æ•°ç”¨äºæ›´æ–°å·²å­˜åœ¨çš„DOMï¼Œè‘—åçš„DIFFç®—æ³•å°±åœ¨å…¶ä¸­</strong></li></ul></li><li><p><strong><code>createElm</code>å‡½æ•°æ ¹æ®VNodeåˆ›å»ºçœŸå®DOMèŠ‚ç‚¹ï¼Œéšåæ’å…¥çœŸå®DOMæ ‘</strong></p><ul><li><strong>å‰é¢è¿›è¡Œä¸€äº›åˆ¤æ–­ç®€åŒ–æ“ä½œï¼Œæœ€åå»é™¤oldDOMèŠ‚ç‚¹</strong></li></ul></li></ul><h4 id="createElm"><a href="#createElm" class="headerlink" title="createElm"></a>createElm</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">createElm</span> (</span><br><span class="line">vnode,</span><br><span class="line"> insertedVnodeQueue,</span><br><span class="line"> parentElm,</span><br><span class="line"> refElm,</span><br><span class="line"> nested,</span><br><span class="line"> ownerArray,</span><br><span class="line"> index</span><br><span class="line">) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_">isDef</span>(vnode.<span class="property">elm</span>) &amp;&amp; <span class="title function_">isDef</span>(ownerArray)) &#123;</span><br><span class="line">        <span class="comment">// This vnode was used in a previous render!</span></span><br><span class="line">        <span class="comment">// now it&#x27;s used as a new node, overwriting its elm would cause</span></span><br><span class="line">        <span class="comment">// potential patch errors down the road when it&#x27;s used as an insertion</span></span><br><span class="line">        <span class="comment">// reference node. Instead, we clone the node on-demand before creating</span></span><br><span class="line">        <span class="comment">// associated DOM element for it.</span></span><br><span class="line">        vnode = ownerArray[index] = <span class="title function_">cloneVNode</span>(vnode);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    vnode.<span class="property">isRootInsert</span> = !nested; <span class="comment">// for transition enter check</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_">createComponent</span>(vnode, insertedVnodeQueue, parentElm, refElm)) &#123;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> data = vnode.<span class="property">data</span>;</span><br><span class="line">    <span class="keyword">var</span> children = vnode.<span class="property">children</span>;</span><br><span class="line">    <span class="keyword">var</span> tag = vnode.<span class="property">tag</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_">isDef</span>(tag)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (data &amp;&amp; data.<span class="property">pre</span>) &#123;</span><br><span class="line">                creatingElmInVPre++;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (<span class="title function_">isUnknownElement$$1</span>(vnode, creatingElmInVPre)) &#123;</span><br><span class="line">                <span class="title function_">warn</span>(</span><br><span class="line">                    <span class="string">&#x27;Unknown custom element: &lt;&#x27;</span> + tag + <span class="string">&#x27;&gt; - did you &#x27;</span> +</span><br><span class="line">                    <span class="string">&#x27;register the component correctly? For recursive components, &#x27;</span> +</span><br><span class="line">                    <span class="string">&#x27;make sure to provide the &quot;name&quot; option.&#x27;</span>,</span><br><span class="line">                    vnode.<span class="property">context</span></span><br><span class="line">                );</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        vnode.<span class="property">elm</span> = vnode.<span class="property">ns</span></span><br><span class="line">            ? nodeOps.<span class="title function_">createElementNS</span>(vnode.<span class="property">ns</span>, tag)</span><br><span class="line">        : nodeOps.<span class="title function_">createElement</span>(tag, vnode);</span><br><span class="line">        <span class="title function_">setScope</span>(vnode);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* istanbul ignore if */</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="title function_">createChildren</span>(vnode, children, insertedVnodeQueue);</span><br><span class="line">            <span class="keyword">if</span> (<span class="title function_">isDef</span>(data)) &#123;</span><br><span class="line">                <span class="title function_">invokeCreateHooks</span>(vnode, insertedVnodeQueue);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="title function_">insert</span>(parentElm, vnode.<span class="property">elm</span>, refElm);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span> &amp;&amp; data &amp;&amp; data.<span class="property">pre</span>) &#123;</span><br><span class="line">            creatingElmInVPre--;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="title function_">isTrue</span>(vnode.<span class="property">isComment</span>)) &#123;</span><br><span class="line">        vnode.<span class="property">elm</span> = nodeOps.<span class="title function_">createComment</span>(vnode.<span class="property">text</span>);</span><br><span class="line">        <span class="title function_">insert</span>(parentElm, vnode.<span class="property">elm</span>, refElm);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        vnode.<span class="property">elm</span> = nodeOps.<span class="title function_">createTextNode</span>(vnode.<span class="property">text</span>);</span><br><span class="line">        <span class="title function_">insert</span>(parentElm, vnode.<span class="property">elm</span>, refElm);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><p><strong>å¦‚æœæ˜¯ç»„ä»¶ä¼šå»ä½¿ç”¨<code>createComponent</code>å‡½æ•°åˆ›å»ºç»„ä»¶</strong></p></li><li><p><strong>å¦‚æœæ˜¯å·²çŸ¥çš„HTMLæ ‡ç­¾ï¼Œä¼šç›´æ¥ä½¿ç”¨<code>nodeOps.createElement</code>å‡½æ•°åˆ›å»º</strong></p><ul><li><p><strong><code>nodeOps.createElement</code>å‡½æ•°å†…éƒ¨ä½¿ç”¨åŸç”ŸDOMæ“ä½œ</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">createElement$1</span> (tagName, vnode) &#123;</span><br><span class="line">  <span class="keyword">var</span> elm = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(tagName);</span><br><span class="line">  <span class="keyword">if</span> (tagName !== <span class="string">&#x27;select&#x27;</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> elm</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// false or null will remove the attribute but undefined will not</span></span><br><span class="line">  <span class="keyword">if</span> (vnode.<span class="property">data</span> &amp;&amp; vnode.<span class="property">data</span>.<span class="property">attrs</span> &amp;&amp; vnode.<span class="property">data</span>.<span class="property">attrs</span>.<span class="property">multiple</span> !== <span class="literal">undefined</span>) &#123;</span><br><span class="line">    elm.<span class="title function_">setAttribute</span>(<span class="string">&#x27;multiple&#x27;</span>, <span class="string">&#x27;multiple&#x27;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> elm</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul></li><li><p><strong>å¦‚æœå­˜åœ¨å­èŠ‚ç‚¹ï¼Œåˆ™ä¼šè°ƒç”¨<code>createChildren</code>å‡½æ•°åˆ›å»ºå­èŠ‚ç‚¹</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">createChildren</span> (vnode, children, insertedVnodeQueue) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title class_">Array</span>.<span class="title function_">isArray</span>(children)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span>) &#123;</span><br><span class="line">            <span class="title function_">checkDuplicateKeys</span>(children);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; children.<span class="property">length</span>; ++i) &#123;</span><br><span class="line">            <span class="title function_">createElm</span>(children[i], insertedVnodeQueue, vnode.<span class="property">elm</span>, <span class="literal">null</span>, <span class="literal">true</span>, children, i);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="title function_">isPrimitive</span>(vnode.<span class="property">text</span>)) &#123;</span><br><span class="line">        nodeOps.<span class="title function_">appendChild</span>(vnode.<span class="property">elm</span>, nodeOps.<span class="title function_">createTextNode</span>(<span class="title class_">String</span>(vnode.<span class="property">text</span>)));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><strong>é€’å½’è°ƒç”¨<code>createElm</code>å‡½æ•°åˆ›å»ºå­èŠ‚ç‚¹çš„çœŸå®DOM</strong></li></ul></li><li><p><strong>å¦‚æœæ˜¯æ–‡æœ¬èŠ‚ç‚¹æˆ–æ³¨é‡ŠèŠ‚ç‚¹ï¼Œåˆ™åˆ†åˆ«ä½¿ç”¨å¯¹åº”çš„åŸç”ŸDOMæ“ä½œå»åˆ›å»º</strong></p></li><li><p><strong>åˆ›å»ºå®Œæˆä¹‹åè°ƒç”¨<code>insert</code>å‡½æ•°æ’å…¥çˆ¶èŠ‚ç‚¹</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">insert</span> (parent, elm, ref$$1) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_">isDef</span>(parent)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_">isDef</span>(ref$$1)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (nodeOps.<span class="title function_">parentNode</span>(ref$$1) === parent) &#123;</span><br><span class="line">                nodeOps.<span class="title function_">insertBefore</span>(parent, elm, ref$$1);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            nodeOps.<span class="title function_">appendChild</span>(parent, elm);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><strong>æ³¨æ„æ­¤æ—¶çˆ¶èŠ‚ç‚¹å¯èƒ½æ²¡æœ‰æŒ‚è½½åˆ°è§†å›¾ä¸Šï¼ˆä¾‹å¦‚ï¼šæ ¹Vueï¼‰ï¼Œæ‰€ä»¥æ²¡æœ‰åœ¨è§†å›¾ä¸Šå±•ç¤º</strong></li></ul></li></ul><h4 id="createComponent"><a href="#createComponent" class="headerlink" title="createComponent"></a>createComponent</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">createComponent</span> (vnode, insertedVnodeQueue, parentElm, refElm) &#123;</span><br><span class="line">    <span class="keyword">var</span> i = vnode.<span class="property">data</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_">isDef</span>(i)) &#123;</span><br><span class="line">        <span class="keyword">var</span> isReactivated = <span class="title function_">isDef</span>(vnode.<span class="property">componentInstance</span>) &amp;&amp; i.<span class="property">keepAlive</span>;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_">isDef</span>(i = i.<span class="property">hook</span>) &amp;&amp; <span class="title function_">isDef</span>(i = i.<span class="property">init</span>)) &#123;</span><br><span class="line">            <span class="title function_">i</span>(vnode, <span class="literal">false</span> <span class="comment">/* hydrating */</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// after calling the init hook, if the vnode is a child component</span></span><br><span class="line">        <span class="comment">// it should&#x27;ve created a child instance and mounted it. the child</span></span><br><span class="line">        <span class="comment">// component also has set the placeholder vnode&#x27;s elm.</span></span><br><span class="line">        <span class="comment">// in that case we can just return the element and be done.</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_">isDef</span>(vnode.<span class="property">componentInstance</span>)) &#123;</span><br><span class="line">            <span class="title function_">initComponent</span>(vnode, insertedVnodeQueue);</span><br><span class="line">            <span class="title function_">insert</span>(parentElm, vnode.<span class="property">elm</span>, refElm);</span><br><span class="line">            <span class="keyword">if</span> (<span class="title function_">isTrue</span>(isReactivated)) &#123;</span><br><span class="line">                <span class="title function_">reactivateComponent</span>(vnode, insertedVnodeQueue, parentElm, refElm);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><p>ç»„ä»¶çš„VNodeçš„dataå­˜æœ‰hookå‡½æ•°ï¼Œæ˜¯ç”±<code>render</code>å‡½æ•°æ³¨å…¥çš„ï¼ŸcomponentOptionså±æ€§å­˜æœ‰ç»„ä»¶çš„<code>propsã€tagã€listenersã€Ctor</code>ï¼ˆCtoræ˜¯VueComponentå‡½æ•°ï¼Œtagæ˜¯æˆ‘ä»¬å®šä¹‰çš„ç»„ä»¶åï¼‰</p></li><li><p><code>init</code>hookå‡½æ•°å¦‚ä¸‹ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">init</span> (vnode, hydrating) &#123;</span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">        vnode.<span class="property">componentInstance</span> &amp;&amp;</span><br><span class="line">        !vnode.<span class="property">componentInstance</span>.<span class="property">_isDestroyed</span> &amp;&amp;</span><br><span class="line">        vnode.<span class="property">data</span>.<span class="property">keepAlive</span></span><br><span class="line">    ) &#123;</span><br><span class="line">        <span class="comment">// kept-alive components, treat as a patch</span></span><br><span class="line">        <span class="keyword">var</span> mountedNode = vnode; <span class="comment">// work around flow</span></span><br><span class="line">        componentVNodeHooks.<span class="title function_">prepatch</span>(mountedNode, mountedNode);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">var</span> child = vnode.<span class="property">componentInstance</span> = <span class="title function_">createComponentInstanceForVnode</span>(</span><br><span class="line">            vnode,</span><br><span class="line">            activeInstance</span><br><span class="line">        );</span><br><span class="line">        child.$mount(hydrating ? vnode.<span class="property">elm</span> : <span class="literal">undefined</span>, hydrating);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure><ul><li><strong><code>createComponentInstanceForVnode</code>å‡½æ•°ä¼šè°ƒç”¨VueComponentçš„æ„é€ å‡½æ•°ï¼Œæœ€åè°ƒç”¨Vue.__initå‡½æ•°</strong></li><li><strong>ç”±äºæ²¡æœ‰<code>el</code>å±æ€§ï¼Œå­ç»„ä»¶<code>init</code>ä¹‹åå°±ä¼šè¿”å›<code>VueComponent</code>å¯¹è±¡ï¼ˆä¸ä¼šè‡ªåŠ¨è°ƒç”¨<code>init</code>çš„$mountå‡½æ•°è¿›è¡ŒæŒ‚è½½ï¼‰</strong><ul><li>éšå<code>init</code>å‡½æ•°è¿›è¡Œæ‰‹åŠ¨æŒ‚è½½</li></ul></li></ul></li></ul><h4 id="invokeInsertHook"><a href="#invokeInsertHook" class="headerlink" title="invokeInsertHook"></a>invokeInsertHook</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">invokeInsertHook</span> (vnode, queue, initial) &#123;</span><br><span class="line">    <span class="comment">// delay insert hooks for component root nodes, invoke them after the</span></span><br><span class="line">    <span class="comment">// element is really inserted</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_">isTrue</span>(initial) &amp;&amp; <span class="title function_">isDef</span>(vnode.<span class="property">parent</span>)) &#123;</span><br><span class="line">        vnode.<span class="property">parent</span>.<span class="property">data</span>.<span class="property">pendingInsert</span> = queue;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; queue.<span class="property">length</span>; ++i) &#123;</span><br><span class="line">            queue[i].<span class="property">data</span>.<span class="property">hook</span>.<span class="title function_">insert</span>(queue[i]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><strong>å­ç»„ä»¶çš„<code>insert</code>hookéƒ½ä¼šä¿ç•™åˆ°çˆ¶ç»„ä»¶<code>patch</code>å‡½æ•°ç»“å°¾æ‰§è¡Œ</strong><ul><li><strong><code>mounted</code>å£°æ˜å‘¨æœŸå‡½æ•°åœ¨æ­¤å¤„æ‰§è¡Œ</strong></li><li><strong><code>v-model</code>æŒ‡ä»¤åœ¨æ­¤å¤„ä¼šåœ¨DOMèŠ‚ç‚¹ä¸Šç»‘å®šç›¸å…³äº‹ä»¶ï¼Œå®ç°åŒå‘ç»‘å®š</strong></li></ul></li></ul>]]></content>
      
      
      <categories>
          
          <category> Vue </category>
          
      </categories>
      
      
        <tags>
            
            <tag> source </tag>
            
            <tag> Vue </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Vueå“åº”å¼åŸç†çš„ç®€å•æ¢ç´¢</title>
      <link href="/2021/06/04/vueReactive/"/>
      <url>/2021/06/04/vueReactive/</url>
      
        <content type="html"><![CDATA[<h2 id="å¼•å…¥"><a href="#å¼•å…¥" class="headerlink" title="å¼•å…¥"></a>å¼•å…¥</h2><p>_Vue.js çš„æ ¸å¿ƒæ˜¯ä¸€ä¸ªå…è®¸é‡‡ç”¨ç®€æ´çš„æ¨¡æ¿è¯­æ³•æ¥å£°æ˜å¼åœ°å°†æ•°æ®æ¸²æŸ“è¿› DOM çš„ç³»ç»Ÿ_â€”â€”Vueå®˜æ–¹æ–‡æ¡£</p><ul><li><p>ç¬¬ä¸€ä¸ªä¾‹å­ï¼ˆåªä¿ç•™æ ¸å¿ƒä»£ç ï¼‰</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;app&quot;</span>&gt;</span></span><br><span class="line">  &#123;&#123; message &#125;&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">var</span> app = <span class="keyword">new</span> <span class="title class_">Vue</span>(&#123;</span></span><br><span class="line"><span class="language-javascript">  <span class="attr">el</span>: <span class="string">&#x27;#app&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">  <span class="attr">data</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">message</span>: <span class="string">&#x27;Hello Vue!&#x27;</span></span></span><br><span class="line"><span class="language-javascript">  &#125;</span></span><br><span class="line"><span class="language-javascript">&#125;)</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><ul><li>ä¹‹ååœ¨é¡µé¢ä¸Šä¼šçœ‹è§<code>Hello Vue!</code>ï¼Œè€Œä¸”<strong>æ•°æ®æ˜¯å…·æœ‰å“åº”å¼çš„</strong>ï¼Œä¹Ÿå°±æ˜¯è¯´ä¿®æ”¹<code>app.message</code>ï¼Œé¡µé¢ä¸Šçš„å€¼ä¹Ÿä¼šå‘ç”Ÿå˜åŒ–</li><li>ä¸‹é¢æ¥åˆ†æå¦‚ä½•ç®€å•å®ç°<code>Vue</code>çš„å“åº”å¼</li></ul></li></ul><h2 id="åˆ†æ"><a href="#åˆ†æ" class="headerlink" title="åˆ†æ"></a>åˆ†æ</h2><h3 id="æ•°æ®æ¸²æŸ“"><a href="#æ•°æ®æ¸²æŸ“" class="headerlink" title="æ•°æ®æ¸²æŸ“"></a>æ•°æ®æ¸²æŸ“</h3><ul><li><p>å…ˆæ€è€ƒæ€ä¹ˆæŠŠæ•°æ®æ¸²æŸ“åˆ°è§†å›¾ä¸Šï¼Œä¸€èˆ¬æˆ‘ä»¬çš„æ–¹æ³•éƒ½æ˜¯é€šè¿‡JavaScriptæ“ä½œDOMï¼Œä¾‹å¦‚</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> msg = <span class="string">&#x27;123&#x27;</span>;</span><br><span class="line"><span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&#x27;#app&#x27;</span>).<span class="property">innerHTML</span> = msg;</span><br></pre></td></tr></table></figure><p>æ•ˆæœå¦‚ä¸‹ï¼š</p><img src="/2021/06/04/vueReactive/1.png" class="" title="æ•ˆæœå›¾"></li><li><p>ä¹‹åä¿®æ”¹å˜é‡æ—¶ï¼Œæƒ³è¦ä¿®æ”¹è§†å›¾ï¼Œæ˜æ˜¾éœ€è¦ç»§ç»­åˆ©ç”¨JavaScriptæ“ä½œDOMï¼Œ<strong>é‡å¤çš„æ“ä½œæ˜æ˜¾å¯ä»¥ä½¿ç”¨å‡½æ•°å°è£…</strong>ï¼Œå¯ä»¥å…ˆæŠŠJavaScriptä¿®æ”¹DOMçš„æ“ä½œå°è£…ä¸ºä¸€ä¸ªå‡½æ•°ï¼Œç„¶ååœ¨é€‚å½“åœ°æ—¶å€™è°ƒç”¨å³å¯ï¼Œä¾‹å¦‚</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> msg = <span class="string">&#x27;123&#x27;</span>;</span><br><span class="line"><span class="title function_">update</span>();</span><br><span class="line"><span class="comment">//å¼‚æ­¥æ“ä½œæ•ˆæœæ›´æ¸…æ™°</span></span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    msg = <span class="string">&#x27;456&#x27;</span>;</span><br><span class="line">    <span class="title function_">update</span>();</span><br><span class="line">&#125;, <span class="number">1000</span>);</span><br><span class="line"><span class="comment">//updateå‡½æ•°</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">update</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&#x27;#app&#x27;</span>).<span class="property">innerHTML</span> = msg;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><p>æ•ˆæœå¦‚ä¸‹ï¼ˆ1ç§’åæ•°æ®å˜åŒ–ï¼ŒDOMä¹Ÿå˜åŒ–ï¼‰ï¼š</p><img src="/2021/06/04/vueReactive/2.gif" class="" title="æ•ˆæœå›¾"><h3 id="æ•°æ®åŠ«æŒ"><a href="#æ•°æ®åŠ«æŒ" class="headerlink" title="æ•°æ®åŠ«æŒ"></a>æ•°æ®åŠ«æŒ</h3><ul><li>é‚£æˆ‘ä»¬æƒ³åšåˆ°å˜é‡<code>msg</code>å˜åŒ–ï¼Œè§†å›¾å°±å˜åŒ–ï¼ˆVueæ‰€åšåˆ°çš„ï¼‰ï¼Œè¯¥æ€ä¹ˆåŠå‘¢ï¼Ÿç­”æ¡ˆå¾ˆæ¸…æ™°ä½¿ç”¨æŸç§åŠæ³•ï¼Œ<strong>åœ¨<code>msg</code>å˜åŒ–ä¹‹åç«‹å³è°ƒç”¨<code>update</code>å‡½æ•°ï¼Œé‚£ä¹ˆè¿™é‡Œå°±è¦ä½¿ç”¨æ•°æ®åŠ«æŒ</strong></li></ul><h4 id="getterå’Œsetter"><a href="#getterå’Œsetter" class="headerlink" title="getterå’Œsetter"></a>getterå’Œsetter</h4><ul><li><p>åœ¨JavaScriptçš„å±æ€§æè¿°ç¬¦ä¸­æœ‰è¿™ä¸¤ç§ç‰¹æ®Šçš„æè¿°ç¬¦<code>setter</code>å’Œ<code>getter</code>ï¼Œå®ƒä»¬çš„ä½œç”¨å¦‚ä¸‹</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> obj = &#123;</span><br><span class="line">    <span class="attr">_a</span>: <span class="number">1</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="title class_">Object</span>.<span class="title function_">defineProperty</span>(obj, <span class="string">&#x27;a&#x27;</span>, &#123;</span><br><span class="line">    <span class="title function_">get</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">_a</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="title function_">set</span>(<span class="params">val</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">_a</span> = val</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>æ•ˆæœå¦‚ä¸‹ï¼š</p><img src="/2021/06/04/vueReactive/3.gif" class="" title="æ•ˆæœå›¾"><ul><li>å¯ä»¥çœ‹åˆ°<code>setter</code>å’Œ<code>getter</code>ä»£ç†äº†<code>obj._a</code>ï¼ˆ<strong>ES6æå‡ºäº†<code>Proxy</code>æ¥è§„èŒƒä»£ç†åŒæ—¶ä¹Ÿæ˜¯Vue3æ•°æ®åŠ«æŒæ‰€é‡‡ç”¨çš„æ–¹æ¡ˆ</strong>ï¼‰</li></ul></li></ul><h3 id="å®ç°åŒæ­¥æ›´æ–°"><a href="#å®ç°åŒæ­¥æ›´æ–°" class="headerlink" title="å®ç°åŒæ­¥æ›´æ–°"></a>å®ç°åŒæ­¥æ›´æ–°</h3><ul><li><p>åˆ©ç”¨å±æ€§æè¿°ç¬¦ï¼Œæˆ‘ä»¬å°±å¯ä»¥åšåˆ°æ•°æ®å’Œè§†å›¾åŒæ­¥æ›´æ–°</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//dataæ•°æ®</span></span><br><span class="line"><span class="keyword">let</span> data = &#123;</span><br><span class="line">    <span class="attr">_msg</span>: <span class="string">&#x27;&#x27;</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">//æ•°æ®åŠ«æŒ</span></span><br><span class="line"><span class="title class_">Object</span>.<span class="title function_">defineProperty</span>(data, <span class="string">&#x27;msg&#x27;</span>, &#123;</span><br><span class="line">    <span class="title function_">set</span>(<span class="params">val</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">_msg</span> = val;</span><br><span class="line">        <span class="comment">//æ•°æ®æ›´æ–°å®Œæˆåæ›´æ–°è§†å›¾</span></span><br><span class="line">        <span class="title function_">update</span>();</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="title function_">get</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">_msg</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">update</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&#x27;#app&#x27;</span>).<span class="property">innerHTML</span> = data.<span class="property">msg</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//æµ‹è¯•ä»£ç </span></span><br><span class="line">data.<span class="property">msg</span> = <span class="string">&#x27;123&#x27;</span>;</span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    data.<span class="property">msg</span> = <span class="string">&#x27;456&#x27;</span></span><br><span class="line">&#125;, <span class="number">1000</span>);</span><br></pre></td></tr></table></figure><p>æ•ˆæœå¦‚ä¸‹ï¼š</p><img src="/2021/06/04/vueReactive/4.gif" class="" title="æ•ˆæœå›¾"><ul><li>è‡³æ­¤æœ€åŸºç¡€ç®€å•çš„å“åº”å¼å°±å®Œæˆäº†</li></ul></li></ul><h3 id="ä¾èµ–æ”¶é›†"><a href="#ä¾èµ–æ”¶é›†" class="headerlink" title="ä¾èµ–æ”¶é›†"></a>ä¾èµ–æ”¶é›†</h3><ul><li><p>ç”±äºæ•°æ®å¯èƒ½ä¼šå’Œå…¶ä»–æ•°æ®äº§ç”Ÿäº’åŠ¨ï¼Œå¯èƒ½æ¸²æŸ“åˆ°å¤šä¸ªç»„ä»¶ä¸­ï¼Œç¡®ä¿å®ƒçš„æ­£ç¡®æ¸²æŸ“Vueé‡‡ç”¨äº†è§‚å¯Ÿè€…æ¨¡å¼è®¾è®¡äº†ä¾èµ–æ”¶é›†æœºåˆ¶</p></li><li><p>è®¢é˜…è€…ï¼ˆç®€åŒ–ç‰ˆï¼‰</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Dep</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">subs</span> = [];<span class="comment">//è®¢é˜…æ•°ç»„</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">addSub</span>(<span class="params">watcher</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">subs</span>.<span class="title function_">push</span>(watcher)<span class="comment">//æ·»åŠ ä¸€ä¸ªwatcher</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">notify</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">subs</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">watcher</span>) =&gt;</span> &#123;</span><br><span class="line">            watcher.<span class="title function_">update</span>()<span class="comment">//æ‰§è¡Œæ‰€æœ‰watcherçš„update</span></span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>è®¢é˜…è€…æ”¶é›†æ‰€æœ‰watcherï¼Œå¹¶åœ¨åˆé€‚çš„æ—¶å€™é€šçŸ¥æ‰€æœ‰watcheræ›´æ–°è§†å›¾</li></ul></li><li><p>è§‚å¯Ÿè€…ï¼ˆç®€åŒ–ç‰ˆï¼‰</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Watcher</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">obj, key, cb</span>) &#123;</span><br><span class="line">        <span class="title class_">Dep</span>.<span class="property">target</span> = <span class="variable language_">this</span>;<span class="comment">//ç¡®ä¿Depçš„å¯¹è±¡æ˜¯è¿™ä¸ªwatcher</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">val</span> = obj[key];<span class="comment">//è·å–å€¼ï¼Œä¸»è¦ä¸ºäº†è§¦å‘getter</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">obj</span> = obj;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">key</span> = key;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">cb</span> = cb;<span class="comment">//æ›´æ–°é€»è¾‘</span></span><br><span class="line">        <span class="title class_">Dep</span>.<span class="property">target</span> = <span class="literal">null</span><span class="comment">//é˜²æ­¢watcheré‡å¤</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">update</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">val</span> = <span class="variable language_">this</span>.<span class="property">obj</span>[<span class="variable language_">this</span>.<span class="property">key</span>];<span class="comment">//è·å–æœ€æ–°çš„å€¼</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">cb</span>(<span class="variable language_">this</span>.<span class="property">val</span>)<span class="comment">//æ ¹æ®å›è°ƒå‡½æ•°çš„é€»è¾‘æ›´æ–°è§†å›¾</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>æ³¨æ„æ¯ä¸ªwatcherçš„æ„é€ å‡½æ•°å®ä¾‹åŒ–è°ƒç”¨ä¸€æ¬¡ï¼Œè§¦å‘ä¸€æ¬¡getterï¼Œåˆ™æ¯ä¸ªwatcheréƒ½å¯ä»¥è´Ÿè´£ä¸€ä¸ªå€¼çš„è§†å›¾æ›´æ–°é€»è¾‘</li></ul></li><li><p>æ•°æ®åŠ«æŒï¼ˆç®€åŒ–ç‰ˆï¼‰</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> dep = <span class="keyword">new</span> <span class="title class_">Dep</span>();</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> data) &#123;<span class="comment">//éå†dataï¼ŒåŠ«æŒæ¯ä¸€ä¸ªå±æ€§</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="title class_">Object</span>.<span class="property">hasOwnProperty</span>.<span class="title function_">call</span>(data, key)) &#123;<span class="comment">//ç¡®ä¿åœ¨dataä¸Š</span></span><br><span class="line">        <span class="keyword">let</span> value = data[key];<span class="comment">//è·å–åŸå€¼</span></span><br><span class="line">        <span class="title class_">Object</span>.<span class="title function_">defineProperty</span>(data, key, &#123;</span><br><span class="line">            <span class="title function_">get</span>(<span class="params"></span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="title class_">Dep</span>.<span class="property">target</span>) &#123;<span class="comment">//é…åˆwatcherçš„æ„é€ å‡½æ•°</span></span><br><span class="line">                    dep.<span class="title function_">addSub</span>(<span class="title class_">Dep</span>.<span class="property">target</span>)</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> value</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="title function_">set</span>(<span class="params">val</span>) &#123;</span><br><span class="line">                value = val;</span><br><span class="line">                dep.<span class="title function_">notify</span>();<span class="comment">//å€¼å‘ç”Ÿäº†å˜åŒ–ï¼Œé€šçŸ¥æ‰€æœ‰watcherè¿›è¡Œæ›´æ–°</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//ç”Ÿæˆè§‚å¯Ÿè€…</span></span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Watcher</span>(data, <span class="string">&#x27;pri1&#x27;</span>, <span class="function">(<span class="params">val</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">//pri1çš„æ›´æ–°é€»è¾‘</span></span><br><span class="line">    <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&#x27;.pri1&#x27;</span>).<span class="property">innerHTML</span> = <span class="string">&#x27;pri1:&#x27;</span> + val;</span><br><span class="line">    <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&#x27;.total&#x27;</span>).<span class="property">innerHTML</span> = <span class="string">&#x27;total:&#x27;</span> + (val + data.<span class="property">pri2</span>);</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Watcher</span>(data, <span class="string">&#x27;pri2&#x27;</span>, <span class="function">(<span class="params">val</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">//pri2çš„æ›´æ–°é€»è¾‘</span></span><br><span class="line">    <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&#x27;.pri2&#x27;</span>).<span class="property">innerHTML</span> = <span class="string">&#x27;pri2:&#x27;</span> + val;</span><br><span class="line">    <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&#x27;.total&#x27;</span>).<span class="property">innerHTML</span> = <span class="string">&#x27;total:&#x27;</span> + (val + data.<span class="property">pri1</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><ul><li>å®é™…Vueå½“ä¸­ä¸ä¼šä¸€ä¸ªä¸€ä¸ªæ‰‹åŠ¨ç”Ÿæˆwatcherï¼Œä¼šæ ¹æ®è¡¨è¾¾å¼æ¨æ–­è§†å›¾æ›´æ–°é€»è¾‘</li></ul><p>æ•ˆæœå¦‚ä¸‹ï¼š</p><img src="/2021/06/04/vueReactive/5.gif" class="" title="æ•ˆæœå›¾"></li><li><p>è‡³æ­¤Vueå“åº”å¼æœ€åŸºç¡€çš„åŸç†å°±å·®ä¸å¤šäº†ï¼Œä½†Vueå¯¹æ­¤åšäº†å¾ˆå¤šä¼˜åŒ–ä»¥åŒ¹é…å¾ˆå¤šæœºåˆ¶</p></li></ul>]]></content>
      
      
      <categories>
          
          <category> Vue </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Vue </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æ‰‹åŠ¨å®ç°ä¸€ä¸ªç®€å•çš„async</title>
      <link href="/2021/05/31/wirteMyAsync/"/>
      <url>/2021/05/31/wirteMyAsync/</url>
      
        <content type="html"><![CDATA[<h2 id="åŸºæœ¬æ¦‚å¿µ"><a href="#åŸºæœ¬æ¦‚å¿µ" class="headerlink" title="åŸºæœ¬æ¦‚å¿µ"></a>åŸºæœ¬æ¦‚å¿µ</h2><ul><li><p><strong>asyncå‡½æ•°åªæ˜¯promise+generatorå‡½æ•°çš„è¯­æ³•ç³–</strong></p><ul><li>å…·ä½“å¯è§ã€Šä½ ä¸æ‡‚çš„JavaScriptã€‹ä¸­å·</li></ul></li><li><p>promise+generatorå‡½æ•°å¯ä»¥ä½¿ç”¨åŒæ­¥è®¡åˆ’ä¹¦å†™å¼‚æ­¥é€»è¾‘ï¼Œæ›´ç¬¦åˆäººç±»ä¹ æƒ¯å»ä¹¦å†™å¼‚æ­¥ä»£ç </p><ul><li><strong>asyncå‡½æ•°è¿›ä¸€æ­¥ç®€åŒ–äº†ä¸Šè¿°ä»£ç </strong></li></ul></li></ul><h2 id="æ‰‹å†™æºç è¿æ¥"><a href="#æ‰‹å†™æºç è¿æ¥" class="headerlink" title="æ‰‹å†™æºç è¿æ¥"></a>æ‰‹å†™æºç è¿æ¥</h2><p><a href="https://juejin.cn/post/6844904102053281806">æ¥è‡ªæ™¨æ›¦æ—¶æ¢¦è§å…®å¤§ä½¬</a></p><h2 id="ä½¿ç”¨ç¤ºä¾‹"><a href="#ä½¿ç”¨ç¤ºä¾‹" class="headerlink" title="ä½¿ç”¨ç¤ºä¾‹"></a>ä½¿ç”¨ç¤ºä¾‹</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">getData</span> = (<span class="params"></span>) =&gt; <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> <span class="title function_">resolve</span>(<span class="string">&quot;data&quot;</span>), <span class="number">1000</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">test</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> data = <span class="keyword">await</span> <span class="title function_">getData</span>()</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;data: &#x27;</span>, data);</span><br><span class="line">  <span class="keyword">const</span> data2 = <span class="keyword">await</span> <span class="title function_">getData</span>()</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;data2: &#x27;</span>, data2);</span><br><span class="line">  <span class="keyword">return</span> <span class="string">&#x27;success&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è¿™æ ·çš„ä¸€ä¸ªå‡½æ•° åº”è¯¥å†1ç§’åæ‰“å°data å†è¿‡ä¸€ç§’æ‰“å°data2 æœ€åæ‰“å°success</span></span><br><span class="line"><span class="title function_">test</span>().<span class="title function_">then</span>(<span class="function"><span class="params">res</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(res))</span><br></pre></td></tr></table></figure><p>ä»£ç æ•ˆæœ</p><img src="/2021/05/31/wirteMyAsync/1.gif" class="" title="æ•ˆæœå›¾"><ul><li>å¯ä»¥çœ‹åˆ°ä½¿ç”¨asyncå‡½æ•°ï¼Œawaitæ ‡è¯†å‡ºå¼‚æ­¥ä»£ç ï¼Œjsæ‰§è¡Œæ—¶å°±ä¼šåœ¨è¿›è¡Œå¼‚æ­¥é˜»å¡ï¼Œæ•´ä¸ªasyncå‡½æ•°ä¼šåœæ­¢ä¸‹æ¥<ul><li>å…³äºasyncå‡½æ•°å…·ä½“ä½¿ç”¨è§<a href="https://es6.ruanyifeng.com/#docs/async">é˜®ä¸€å³°å¤§ä½¬çš„æ•™å­¦</a></li></ul></li></ul><h2 id="å®ç°æ€è·¯"><a href="#å®ç°æ€è·¯" class="headerlink" title="å®ç°æ€è·¯"></a>å®ç°æ€è·¯</h2><h3 id="generatorå‡½æ•°å½¢å¼"><a href="#generatorå‡½æ•°å½¢å¼" class="headerlink" title="generatorå‡½æ•°å½¢å¼"></a>generatorå‡½æ•°å½¢å¼</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">getData</span> = (<span class="params"></span>) =&gt;</span><br><span class="line">  <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="title function_">resolve</span>(<span class="string">&quot;haha&quot;</span>);</span><br><span class="line">    &#125;, <span class="number">1000</span>);</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span>* <span class="title function_">testG</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> data = <span class="keyword">yield</span> <span class="title function_">getData</span>();</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;data:&quot;</span>, data);</span><br><span class="line">  <span class="keyword">const</span> data2 = <span class="keyword">yield</span> <span class="title function_">getData</span>();</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;data2:&quot;</span>, data2);</span><br><span class="line">  <span class="keyword">return</span> <span class="string">&quot;success&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>getDataå‡½æ•°ä¸å˜</li><li><strong>testå‡½æ•°asyncä½¿ç”¨generatorå‡½æ•°æ ‡è¯†ç¬¦*ä»£æ›¿ï¼Œæ‰€æœ‰awaitä½¿ç”¨yieldä»£æ›¿</strong></li></ul><h3 id="æ‰‹åŠ¨å®ç°"><a href="#æ‰‹åŠ¨å®ç°" class="headerlink" title="æ‰‹åŠ¨å®ç°"></a>æ‰‹åŠ¨å®ç°</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> gen = <span class="title function_">testG</span>()<span class="comment">//è·å–è¿­ä»£å™¨å®ä¾‹</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> dataPromise = gen.<span class="title function_">next</span>()<span class="comment">//è·å–ç¬¬ä¸€ä¸ªpromise</span></span><br><span class="line"></span><br><span class="line">dataPromise.<span class="title function_">then</span>(<span class="function">(<span class="params">value1</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// data1çš„valueè¢«æ‹¿åˆ°äº† ç»§ç»­è°ƒç”¨nextå¹¶ä¸”ä¼ é€’ç»™data å¹¶è·å–ç¬¬äºŒä¸ªpromise</span></span><br><span class="line">    <span class="keyword">var</span> data2Promise = gen.<span class="title function_">next</span>(value1)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// console.log(&#x27;data: &#x27;, data);</span></span><br><span class="line">    <span class="comment">// æ­¤æ—¶å°±ä¼šæ‰“å°å‡ºdata</span></span><br><span class="line">    </span><br><span class="line">    data2Promise.<span class="property">value</span>.<span class="title function_">then</span>(<span class="function">(<span class="params">value2</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// data2çš„valueæ‹¿åˆ°äº† ç»§ç»­è°ƒç”¨nextå¹¶ä¸”ä¼ é€’value2</span></span><br><span class="line">         gen.<span class="title function_">next</span>(value2)</span><br><span class="line">         </span><br><span class="line">        <span class="comment">// console.log(&#x27;data2: &#x27;, data2);</span></span><br><span class="line">        <span class="comment">// æ­¤æ—¶å°±ä¼šæ‰“å°å‡ºdata2</span></span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><ul><li>æ‰‹åŠ¨è°ƒç”¨generatorå‡½æ•°ï¼Œå®ç°å¼‚æ­¥æ“ä½œ</li></ul><h3 id="åˆ©ç”¨é«˜é˜¶å‡½æ•°å®ç°è‡ªåŠ¨æ‰§è¡Œ"><a href="#åˆ©ç”¨é«˜é˜¶å‡½æ•°å®ç°è‡ªåŠ¨æ‰§è¡Œ" class="headerlink" title="åˆ©ç”¨é«˜é˜¶å‡½æ•°å®ç°è‡ªåŠ¨æ‰§è¡Œ"></a>åˆ©ç”¨é«˜é˜¶å‡½æ•°å®ç°è‡ªåŠ¨æ‰§è¡Œ</h3><ul><li><p>æœŸæœ›çš„ç»ˆæå½¢æ€</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">asyncToGenerator</span>(testG).<span class="title function_">then</span>(<span class="function">(<span class="params">res</span>) =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(res));</span><br><span class="line"><span class="comment">//ä¼ å…¥ä¸€ä¸ªç”Ÿæˆå™¨å‡½æ•°ï¼ŒasyncToGeneratorå‡½æ•°ä¼šè‡ªåŠ¨æ‰§è¡Œå®Œï¼Œå¹¶è¿”å›ä¸€ä¸ªpromise</span></span><br></pre></td></tr></table></figure><ul><li>é‚£ä¹ˆasyncToGeneratorå‡½æ•°æœ€ååº”è¯¥è¿”å›ä¸€ä¸ªpromise</li></ul></li><li><p><strong>è¿ç»­çš„promiseè°ƒç”¨</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span>* <span class="title function_">testG</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> data = <span class="keyword">yield</span> <span class="title function_">getData</span>();</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;data:&quot;</span>, data);</span><br><span class="line">  <span class="keyword">const</span> data2 = <span class="keyword">yield</span> <span class="title function_">getData</span>();</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;data2:&quot;</span>, data2);</span><br><span class="line">  <span class="keyword">return</span> <span class="string">&quot;success&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><p>generatorå‡½æ•°å¯èƒ½å­˜åœ¨å¤šä¸ªpromiseï¼Œéœ€è¦ä¸€æ­¥ä¸€æ­¥è‡ªå·±è°ƒç”¨è§£åŒ…</p></li><li><p>æ€ä¹ˆé‡å¤è°ƒç”¨æ˜¯é‡ç‚¹ï¼Œè€Œè§£å†³æ€è·¯æ˜¯æ‰¾åˆ°é“¾å¼è°ƒç”¨çš„èŠ‚ç‚¹</p></li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//retPromiseå°±æ˜¯generatorå‡½æ•°è¿”å›çš„promise</span></span><br><span class="line">retPromise.<span class="title function_">then</span>(<span class="function">(<span class="params">res</span>)=&gt;</span>&#123;</span><br><span class="line">    <span class="comment">//itå°±æ˜¯è¿­ä»£å™¨ å³åœ¨ä¸€ä¸ªpromiseçŠ¶æ€ç¡®å®šåï¼Œæ ¹æ®çŠ¶æ€è¿›è¡Œä¸‹ä¸€æ­¥ã€‚ä¾‹å¦‚resolveä¸‹ï¼Œåº”è¯¥å°†å€¼è¿”å›å»ï¼Œæ¥å—ä¸‹ä¸€ä¸ªpromise</span></span><br><span class="line">    it.<span class="title function_">next</span>(res);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><ul><li>å°†è¿™é‡Œçš„é€»è¾‘æŠ½ç¦»å‡ºæ¥å½¢æˆå‡½æ•°ï¼Œç„¶ååœ¨åˆé€‚çš„æ—¶é—´è°ƒç”¨å³å¯</li></ul></li><li><p>æœ€ç»ˆå®ç°çš„ä»£ç </p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">asyncToGenerator</span>(<span class="params">generatorFunc</span>) &#123;</span><br><span class="line">  <span class="comment">//è·å–generatorå‡½æ•°çš„è¿­ä»£å™¨</span></span><br><span class="line">  <span class="keyword">let</span> it = <span class="title function_">generatorFunc</span>();</span><br><span class="line">  <span class="comment">//è¿”å›ä¸€ä¸ªæ–°çš„promise</span></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">//stepå‡½æ•°ç”¨äºè°ƒç”¨ä¸‹ä¸€ä¸ªpromise</span></span><br><span class="line">    <span class="comment">//keyä¸ºè¿­ä»£å™¨è¿è¡Œæ–¹å¼ï¼Œvalä¸ºè¿­ä»£å™¨è¦ä¼ é€’è¿›å»çš„å‚æ•°</span></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">step</span>(<span class="params">key, val</span>) &#123;</span><br><span class="line">      <span class="comment">//generatorå‡½æ•°è¿”å›çš„valueï¼Œç”±äºtryå±äºç‰¹æ®Šçš„ä¸Šä¸‹æ–‡ï¼Œå˜é‡éœ€è¦å®šä¹‰åœ¨å¤–éƒ¨</span></span><br><span class="line">      <span class="keyword">let</span> retPromise;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        retPromise = it[key](val); <span class="comment">//è¿­ä»£å™¨è¿è¡Œ</span></span><br><span class="line">      &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">reject</span>(e); <span class="comment">//å‡ºé”™ç›´æ¥ç”±å¤–éƒ¨æ•è·</span></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> &#123; value, done &#125; = retPromise; <span class="comment">//ä»generatorå‡½æ•°è¿”å›çš„å€¼</span></span><br><span class="line">      <span class="comment">//valueå³æ˜¯promise,doneç”¨äºç¡®å®šè¿­ä»£å™¨æ˜¯å¦è¿­ä»£å®Œæ¯•</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (done) &#123;</span><br><span class="line">        <span class="comment">//å¦‚æœè¿­ä»£å®Œæ¯•äº†ï¼Œç›´æ¥å‘å¤–éƒ¨æŠ›å‡ºæœ€åçš„å€¼</span></span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">resolve</span>(value);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//å¦‚æœæ²¡æœ‰ï¼Œè°ƒç”¨generatorå‡½æ•°è¿”å›çš„promiseï¼Œæ³¨å†Œthenäº‹ä»¶</span></span><br><span class="line">        <span class="keyword">return</span> value.<span class="title function_">then</span>(</span><br><span class="line">          <span class="function">(<span class="params">val</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="comment">//generatorå‡½æ•°è¿”å›çš„promiseå˜ä¸ºresolveæ—¶ï¼ŒæŠŠè·å–çš„å€¼ä¼ å…¥stepå‡½æ•°ï¼Œå¹¶æŒ‡ç¤ºè¿­ä»£å™¨è¿›è¡Œä¸‹ä¸€æ­¥</span></span><br><span class="line">            <span class="title function_">step</span>(<span class="string">&quot;next&quot;</span>, val);</span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="comment">//é€»è¾‘åŒä¸Š</span></span><br><span class="line">            <span class="title function_">step</span>(<span class="string">&quot;throw&quot;</span>, err);</span><br><span class="line">          &#125;</span><br><span class="line">        );</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//å¼€å§‹è¿­ä»£ï¼Œç¬¬ä¸€ä¸ªä¸éœ€è¦å‚æ•°ï¼Œç›´æ¥ä¸‹ä¸€æ­¥å³å¯</span></span><br><span class="line">    <span class="title function_">step</span>(<span class="string">&quot;next&quot;</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>æœ€ç»ˆæ•ˆæœ</p><img src="/2021/05/31/wirteMyAsync/2.gif" class="" title="æ•ˆæœå›¾"></li></ul><p>â€“</p>]]></content>
      
      
      <categories>
          
          <category> javascript </category>
          
      </categories>
      
      
        <tags>
            
            <tag> javascript </tag>
            
            <tag> async </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ä¸€æ¬¡å¯¹webpackè¾“å‡ºæ–‡ä»¶çš„åˆ†æ</title>
      <link href="/2021/05/25/webpackOutFileAnalyes/"/>
      <url>/2021/05/25/webpackOutFileAnalyes/</url>
      
        <content type="html"><![CDATA[<h2 id="webpack-5-37-0-çš„è¾“å‡ºæ–‡ä»¶åˆ†æ"><a href="#webpack-5-37-0-çš„è¾“å‡ºæ–‡ä»¶åˆ†æ" class="headerlink" title="webpack 5.37.0 çš„è¾“å‡ºæ–‡ä»¶åˆ†æ"></a>webpack 5.37.0 çš„è¾“å‡ºæ–‡ä»¶åˆ†æ</h2><ul><li><p>å…¥å£æ–‡ä»¶</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//main.js</span></span><br><span class="line"><span class="keyword">import</span> show <span class="keyword">from</span> <span class="string">&quot;./tmp2&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="title function_">show</span>(<span class="number">123</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;1111&quot;</span>);</span><br></pre></td></tr></table></figure></li><li><p>ä¾èµ–æ–‡ä»¶</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//tmp2.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">show</span>(<span class="params">arg</span>) &#123;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;show me!&quot;</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`arg is <span class="subst">$&#123;arg&#125;</span>`</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>webpack.config.js</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span>=&#123;</span><br><span class="line">    <span class="comment">//å…¶ä½™é…ç½®çœç•¥</span></span><br><span class="line">    <span class="attr">devtool</span>:<span class="string">&quot;sourcce-map&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>è¾“å‡ºæ–‡ä»¶</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/******/</span> (<span class="function">() =&gt;</span> &#123; <span class="comment">// webpackBootstrap</span></span><br><span class="line"><span class="comment">/******/</span> <span class="string">&quot;use strict&quot;</span>;</span><br><span class="line"><span class="comment">/******/</span> <span class="keyword">var</span> __webpack_modules__ = (&#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">/***/</span> <span class="string">&quot;./mySrc/js/tmp2.js&quot;</span>:</span><br><span class="line"><span class="comment">/*!**************************!*\</span></span><br><span class="line"><span class="comment">  !*** ./mySrc/js/tmp2.js ***!</span></span><br><span class="line"><span class="comment">  \**************************/</span></span><br><span class="line"><span class="comment">/***/</span> (<span class="function">(<span class="params">__unused_webpack_module, __webpack_exports__, __webpack_require__</span>) =&gt;</span> &#123;</span><br><span class="line"></span><br><span class="line">__webpack_require__.<span class="title function_">r</span>(__webpack_exports__);</span><br><span class="line"><span class="comment">/* harmony export */</span> __webpack_require__.<span class="title function_">d</span>(__webpack_exports__, &#123;</span><br><span class="line"><span class="comment">/* harmony export */</span>   <span class="string">&quot;default&quot;</span>: <span class="function">() =&gt;</span> (<span class="comment">/* binding */</span> show)</span><br><span class="line"><span class="comment">/* harmony export */</span> &#125;);</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">show</span>(<span class="params">arg</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;show me!&quot;</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`arg is <span class="subst">$&#123;arg&#125;</span>`</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/***/</span> &#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">/******/</span> &#125;);</span><br><span class="line"><span class="comment">/************************************************************************/</span></span><br><span class="line"><span class="comment">/******/</span> <span class="comment">// The module cache</span></span><br><span class="line"><span class="comment">/******/</span> <span class="keyword">var</span> __webpack_module_cache__ = &#123;&#125;;</span><br><span class="line"><span class="comment">/******/</span> </span><br><span class="line"><span class="comment">/******/</span> <span class="comment">// The require function</span></span><br><span class="line"><span class="comment">/******/</span> <span class="keyword">function</span> <span class="title function_">__webpack_require__</span>(<span class="params">moduleId</span>) &#123;</span><br><span class="line"><span class="comment">/******/</span> <span class="comment">// Check if module is in cache</span></span><br><span class="line"><span class="comment">/******/</span> <span class="keyword">var</span> cachedModule = __webpack_module_cache__[moduleId];</span><br><span class="line"><span class="comment">/******/</span> <span class="keyword">if</span> (cachedModule !== <span class="literal">undefined</span>) &#123;</span><br><span class="line"><span class="comment">/******/</span> <span class="keyword">return</span> cachedModule.<span class="property">exports</span>;</span><br><span class="line"><span class="comment">/******/</span> &#125;</span><br><span class="line"><span class="comment">/******/</span> <span class="comment">// Create a new module (and put it into the cache)</span></span><br><span class="line"><span class="comment">/******/</span> <span class="keyword">var</span> <span class="variable language_">module</span> = __webpack_module_cache__[moduleId] = &#123;</span><br><span class="line"><span class="comment">/******/</span> <span class="comment">// no module.id needed</span></span><br><span class="line"><span class="comment">/******/</span> <span class="comment">// no module.loaded needed</span></span><br><span class="line"><span class="comment">/******/</span> <span class="attr">exports</span>: &#123;&#125;</span><br><span class="line"><span class="comment">/******/</span> &#125;;</span><br><span class="line"><span class="comment">/******/</span> </span><br><span class="line"><span class="comment">/******/</span> <span class="comment">// Execute the module function</span></span><br><span class="line"><span class="comment">/******/</span> __webpack_modules__[moduleId](<span class="variable language_">module</span>, <span class="variable language_">module</span>.<span class="property">exports</span>, __webpack_require__);</span><br><span class="line"><span class="comment">/******/</span> </span><br><span class="line"><span class="comment">/******/</span> <span class="comment">// Return the exports of the module</span></span><br><span class="line"><span class="comment">/******/</span> <span class="keyword">return</span> <span class="variable language_">module</span>.<span class="property">exports</span>;</span><br><span class="line"><span class="comment">/******/</span> &#125;</span><br><span class="line"><span class="comment">/******/</span> </span><br><span class="line"><span class="comment">/************************************************************************/</span></span><br><span class="line"><span class="comment">/******/</span> <span class="comment">/* webpack/runtime/define property getters */</span></span><br><span class="line"><span class="comment">/******/</span> (<span class="function">() =&gt;</span> &#123;</span><br><span class="line"><span class="comment">/******/</span> <span class="comment">// define getter functions for harmony exports</span></span><br><span class="line"><span class="comment">/******/</span> __webpack_require__.<span class="property">d</span> = <span class="function">(<span class="params"><span class="built_in">exports</span>, definition</span>) =&gt;</span> &#123;</span><br><span class="line"><span class="comment">/******/</span> <span class="keyword">for</span>(<span class="keyword">var</span> key <span class="keyword">in</span> definition) &#123;</span><br><span class="line"><span class="comment">/******/</span> <span class="keyword">if</span>(__webpack_require__.<span class="title function_">o</span>(definition, key) &amp;&amp; !__webpack_require__.<span class="title function_">o</span>(<span class="built_in">exports</span>, key)) &#123;</span><br><span class="line"><span class="comment">/******/</span> <span class="title class_">Object</span>.<span class="title function_">defineProperty</span>(<span class="built_in">exports</span>, key, &#123; <span class="attr">enumerable</span>: <span class="literal">true</span>, <span class="attr">get</span>: definition[key] &#125;);</span><br><span class="line"><span class="comment">/******/</span> &#125;</span><br><span class="line"><span class="comment">/******/</span> &#125;</span><br><span class="line"><span class="comment">/******/</span> &#125;;</span><br><span class="line"><span class="comment">/******/</span> &#125;)();</span><br><span class="line"><span class="comment">/******/</span> </span><br><span class="line"><span class="comment">/******/</span> <span class="comment">/* webpack/runtime/hasOwnProperty shorthand */</span></span><br><span class="line"><span class="comment">/******/</span> (<span class="function">() =&gt;</span> &#123;</span><br><span class="line"><span class="comment">/******/</span> __webpack_require__.<span class="property">o</span> = <span class="function">(<span class="params">obj, prop</span>) =&gt;</span> (<span class="title class_">Object</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">hasOwnProperty</span>.<span class="title function_">call</span>(obj, prop))</span><br><span class="line"><span class="comment">/******/</span> &#125;)();</span><br><span class="line"><span class="comment">/******/</span> </span><br><span class="line"><span class="comment">/******/</span> <span class="comment">/* webpack/runtime/make namespace object */</span></span><br><span class="line"><span class="comment">/******/</span> (<span class="function">() =&gt;</span> &#123;</span><br><span class="line"><span class="comment">/******/</span> <span class="comment">// define __esModule on exports</span></span><br><span class="line"><span class="comment">/******/</span> __webpack_require__.<span class="property">r</span> = <span class="function">(<span class="params"><span class="built_in">exports</span></span>) =&gt;</span> &#123;</span><br><span class="line"><span class="comment">/******/</span> <span class="keyword">if</span>(<span class="keyword">typeof</span> <span class="title class_">Symbol</span> !== <span class="string">&#x27;undefined&#x27;</span> &amp;&amp; <span class="title class_">Symbol</span>.<span class="property">toStringTag</span>) &#123;</span><br><span class="line"><span class="comment">/******/</span> <span class="title class_">Object</span>.<span class="title function_">defineProperty</span>(<span class="built_in">exports</span>, <span class="title class_">Symbol</span>.<span class="property">toStringTag</span>, &#123; <span class="attr">value</span>: <span class="string">&#x27;Module&#x27;</span> &#125;);</span><br><span class="line"><span class="comment">/******/</span> &#125;</span><br><span class="line"><span class="comment">/******/</span> <span class="title class_">Object</span>.<span class="title function_">defineProperty</span>(<span class="built_in">exports</span>, <span class="string">&#x27;__esModule&#x27;</span>, &#123; <span class="attr">value</span>: <span class="literal">true</span> &#125;);</span><br><span class="line"><span class="comment">/******/</span> &#125;;</span><br><span class="line"><span class="comment">/******/</span> &#125;)();</span><br><span class="line"><span class="comment">/******/</span> </span><br><span class="line"><span class="comment">/************************************************************************/</span></span><br><span class="line"><span class="keyword">var</span> __webpack_exports__ = &#123;&#125;;</span><br><span class="line"><span class="comment">// This entry need to be wrapped in an IIFE because it need to be isolated against other modules in the chunk.</span></span><br><span class="line">(<span class="function">() =&gt;</span> &#123;</span><br><span class="line"><span class="comment">/*!**************************!*\</span></span><br><span class="line"><span class="comment">  !*** ./mySrc/js/main.js ***!</span></span><br><span class="line"><span class="comment">  \**************************/</span></span><br><span class="line">__webpack_require__.<span class="title function_">r</span>(__webpack_exports__);</span><br><span class="line"><span class="comment">/* harmony import */</span> <span class="keyword">var</span> _tmp2__WEBPACK_IMPORTED_MODULE_0__ = <span class="title function_">__webpack_require__</span>(<span class="comment">/*! ./tmp2 */</span> <span class="string">&quot;./mySrc/js/tmp2.js&quot;</span>);</span><br><span class="line"></span><br><span class="line">(<span class="number">0</span>,_tmp2__WEBPACK_IMPORTED_MODULE_0__.<span class="property">default</span>)(<span class="number">123</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;1111&quot;</span>);</span><br><span class="line"></span><br><span class="line">&#125;)();</span><br><span class="line"></span><br><span class="line"><span class="comment">/******/</span> &#125;)()</span><br><span class="line">;</span><br><span class="line"><span class="comment">//# sourceMappingURL=build.js.map</span></span><br></pre></td></tr></table></figure><ul><li>çœ‹ä¸æ‡‚ä¸è¦ç´§ï¼Œçœ‹å®Œä¸‹é¢çš„åˆ†å—åˆ†æï¼Œå†çœ‹çœ‹æ•´ä½“ä»£ç </li></ul></li></ul><h3 id="å…³é”®åˆ†æ"><a href="#å…³é”®åˆ†æ" class="headerlink" title="å…³é”®åˆ†æ"></a>å…³é”®åˆ†æ</h3><ul><li>æ•´ä½“æ˜¯ä¸€ä¸ªç«‹å³æ‰§è¡Œå‡½æ•°ï¼ˆé˜²æ­¢å˜é‡æ±¡æŸ“ä½œç”¨åŸŸï¼‰</li><li>å†…éƒ¨å…ˆåˆ†æå®šä¹‰çš„ä¸€äº›å‡½æ•°</li><li>å†åˆ†ææ¨¡å—æ•°ç»„</li><li>æœ€ååˆ†æå…¥å£æ¨¡å—çš„æ‰§è¡Œ</li></ul><h3 id="webpack-require-å‡½æ•°"><a href="#webpack-require-å‡½æ•°" class="headerlink" title="__webpack_require__å‡½æ•°"></a>__webpack_require__å‡½æ•°</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/******/</span> <span class="comment">// The module cache</span></span><br><span class="line"><span class="comment">/******/</span> <span class="keyword">var</span> __webpack_module_cache__ = &#123;&#125;;</span><br><span class="line"><span class="comment">/******/</span> </span><br><span class="line"><span class="comment">/******/</span> <span class="comment">// The require function</span></span><br><span class="line"><span class="comment">/******/</span> <span class="keyword">function</span> <span class="title function_">__webpack_require__</span>(<span class="params">moduleId</span>) &#123;</span><br><span class="line"><span class="comment">/******/</span> <span class="comment">// Check if module is in cache</span></span><br><span class="line"><span class="comment">/******/</span> <span class="keyword">var</span> cachedModule = __webpack_module_cache__[moduleId];</span><br><span class="line"><span class="comment">/******/</span> <span class="keyword">if</span> (cachedModule !== <span class="literal">undefined</span>) &#123;</span><br><span class="line"><span class="comment">/******/</span> <span class="keyword">return</span> cachedModule.<span class="property">exports</span>;</span><br><span class="line"><span class="comment">/******/</span> &#125;</span><br><span class="line"><span class="comment">/******/</span> <span class="comment">// Create a new module (and put it into the cache)</span></span><br><span class="line"><span class="comment">/******/</span> <span class="keyword">var</span> <span class="variable language_">module</span> = __webpack_module_cache__[moduleId] = &#123;</span><br><span class="line"><span class="comment">/******/</span> <span class="comment">// no module.id needed</span></span><br><span class="line"><span class="comment">/******/</span> <span class="comment">// no module.loaded needed</span></span><br><span class="line"><span class="comment">/******/</span> <span class="attr">exports</span>: &#123;&#125;</span><br><span class="line"><span class="comment">/******/</span> &#125;;</span><br><span class="line"><span class="comment">/******/</span> </span><br><span class="line"><span class="comment">/******/</span> <span class="comment">// Execute the module function</span></span><br><span class="line"><span class="comment">/******/</span> __webpack_modules__[moduleId](<span class="variable language_">module</span>, <span class="variable language_">module</span>.<span class="property">exports</span>, __webpack_require__);</span><br><span class="line"><span class="comment">/******/</span> </span><br><span class="line"><span class="comment">/******/</span> <span class="comment">// Return the exports of the module</span></span><br><span class="line"><span class="comment">/******/</span> <span class="keyword">return</span> <span class="variable language_">module</span>.<span class="property">exports</span>;</span><br><span class="line"><span class="comment">/******/</span> &#125;</span><br></pre></td></tr></table></figure><ul><li><p>ç¼“å­˜ä¼˜åŒ–</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> __webpack_module_cache__ = &#123;&#125;; <span class="comment">//ç¼“å­˜æ•°ç»„</span></span><br><span class="line"><span class="comment">//...</span></span><br><span class="line"><span class="keyword">var</span> cachedModule = __webpack_module_cache__[moduleId]; <span class="comment">//ä»ç¼“å­˜ä¸­æ‰¾å‡ºæ¨¡å—</span></span><br><span class="line"><span class="keyword">if</span> (cachedModule !== <span class="literal">undefined</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> cachedModule.<span class="property">exports</span>;<span class="comment">//å¦‚æœæ‰¾åˆ°äº†å°±ç›´æ¥è¿”å›</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>é€»è¾‘å¾ˆç®€å•çš„ä¼˜åŒ–æœºåˆ¶</li></ul></li><li><p>require æ¨¡ä»¿</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">__webpack_require__</span>(<span class="params">moduleId</span>) &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="comment">// åˆ›å»ºä¸€ä¸ªæ¨¡å—</span></span><br><span class="line">    <span class="keyword">var</span> <span class="variable language_">module</span> = (__webpack_module_cache__[moduleId] = &#123;</span><br><span class="line">        <span class="comment">//åŒæ—¶åˆ›å»ºäº†ç¼“å­˜</span></span><br><span class="line">        <span class="attr">exports</span>: &#123;&#125;,</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ‰§è¡Œæ¨¡å—ä»£ç </span></span><br><span class="line">    __webpack_modules__[moduleId](<span class="variable language_">module</span>, <span class="variable language_">module</span>.<span class="property">exports</span>, __webpack_require__);<span class="comment">//æ¨¡å—æ•°ç»„ä¸­æ¯ä¸€ä¸ªæ¨¡å—éƒ½æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œä¸‹é¢ä¼šçœ‹åˆ°æ¨¡å—å†…éƒ¨æ€ä¹ˆå¯¹ä¼ å…¥çš„moduleè¿›è¡Œç»„è£…</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¿”å›æ¨¡å—æŠ›å‡ºçš„å†…å®¹</span></span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">module</span>.<span class="property">exports</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>ç”¨äºåœ¨æµè§ˆå™¨ä¸­æ¨¡ä»¿commonjsæˆ–è€…ES6 module</li></ul></li></ul><h3 id="webpack-require-å·¥å…·å‡½æ•°"><a href="#webpack-require-å·¥å…·å‡½æ•°" class="headerlink" title="__webpack_require__å·¥å…·å‡½æ•°"></a>__webpack_require__å·¥å…·å‡½æ•°</h3><ul><li><p>hasOwnProperty å°è£… __webpack_require__.o</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    __webpack_require__.<span class="property">o</span> = <span class="function">(<span class="params">obj, prop</span>) =&gt;</span></span><br><span class="line">    <span class="title class_">Object</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">hasOwnProperty</span>.<span class="title function_">call</span>(obj, prop);</span><br><span class="line">&#125;)();</span><br></pre></td></tr></table></figure><ul><li>åªæ˜¯ä¸ªç®€å•çš„å°è£…ï¼ŒåŠŸèƒ½åŸºæœ¬ä¸å˜</li></ul></li><li><p><strong>å®šä¹‰å‡½æ•° __webpack_require__.d</strong></p><ul><li>æ ¸å¿ƒåŠŸèƒ½å‡½æ•°ï¼ŒæˆåŠŸæ¨¡ä»¿Commonjsè§„èŒƒï¼ŒæŠ›å‡ºäº†æ¨¡å—</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// å³å°†æŠ›å‡ºçš„exportsä¸Šå®šä¹‰ä»£ç </span></span><br><span class="line">    __webpack_require__.<span class="property">d</span> = <span class="function">(<span class="params"><span class="built_in">exports</span>, definition</span>) =&gt;</span> &#123;<span class="comment">//ä¼ å…¥exportså’Œå®šä¹‰</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> key <span class="keyword">in</span> definition) &#123;</span><br><span class="line">            <span class="keyword">if</span> (</span><br><span class="line">                __webpack_require__.<span class="title function_">o</span>(definition, key) &amp;&amp;</span><br><span class="line">                !__webpack_require__.<span class="title function_">o</span>(<span class="built_in">exports</span>, key)</span><br><span class="line">            ) <span class="comment">//ä¸Šé¢æåˆ°çš„å°è£…å‡½æ•°ï¼Œåˆ¤å®šå±æ€§æ˜¯å¦å­˜åœ¨ä»¥åŠæ˜¯å¦å‘ç”Ÿè¦†ç›–</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="title class_">Object</span>.<span class="title function_">defineProperty</span>(<span class="built_in">exports</span>, key, &#123;</span><br><span class="line">                    <span class="attr">enumerable</span>: <span class="literal">true</span>,</span><br><span class="line">                    <span class="attr">get</span>: definition[key],</span><br><span class="line">                &#125;);<span class="comment">//exportsä¸Šå®šä¹‰getterï¼Œä¹Ÿå°±æ˜¯module.exportsè®¿é—®æ—¶ï¼Œåˆ©ç”¨getå®šä½åˆ°æ¨¡å—ä¸­æŠ›å‡ºçš„åŒåå±æ€§</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;)();</span><br></pre></td></tr></table></figure><ul><li>ç»“åˆä¸‹é¢çš„æ¨¡å—è§£æä¼šæ›´æ¸…æ™°</li></ul></li><li><p>æ ‡è®°å‡½æ•° __webpack_require__.r</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// æ ‡è®°è¿™æ˜¯ä¸ªæ¨¡å—</span></span><br><span class="line">    __webpack_require__.<span class="property">r</span> = <span class="function">(<span class="params"><span class="built_in">exports</span></span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">typeof</span> <span class="title class_">Symbol</span> !== <span class="string">&quot;undefined&quot;</span> &amp;&amp; <span class="title class_">Symbol</span>.<span class="property">toStringTag</span>) &#123;<span class="comment">//Symbol.toStringTagå¯ä»¥ä¿®æ”¹typeofçš„è¿”å›å€¼</span></span><br><span class="line">            <span class="title class_">Object</span>.<span class="title function_">defineProperty</span>(<span class="built_in">exports</span>, <span class="title class_">Symbol</span>.<span class="property">toStringTag</span>, &#123; <span class="attr">value</span>: <span class="string">&quot;Module&quot;</span> &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="title class_">Object</span>.<span class="title function_">defineProperty</span>(<span class="built_in">exports</span>, <span class="string">&quot;__esModule&quot;</span>, &#123; <span class="attr">value</span>: <span class="literal">true</span> &#125;);<span class="comment">//ä¸æ”¯æŒSymbolçš„æ›¿ä»£å“</span></span><br><span class="line">    &#125;;</span><br><span class="line">&#125;)();</span><br></pre></td></tr></table></figure></li></ul><h3 id="æ¨¡å—æ•°ç»„"><a href="#æ¨¡å—æ•°ç»„" class="headerlink" title="æ¨¡å—æ•°ç»„"></a>æ¨¡å—æ•°ç»„</h3><ul><li><p>æ­¤å¤„åªæœ‰ä¸€ä¸ªä¾èµ–æ¨¡å—ï¼ˆmain.jsä½œä¸ºå…¥å£æ¨¡å—ï¼Œwebpack5ä¸å½’ç±»ä¸ºæ¨¡å—æ•°ç»„ï¼‰</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> __webpack_modules__ = &#123;</span><br><span class="line">    <span class="comment">/***/</span> <span class="string">&quot;./mySrc/js/tmp2.js&quot;</span>:<span class="comment">//æœ¬èº«æ˜¯ä¸ªé”®å€¼å¯¹,é”®å°±æ˜¯å¼•ç”¨è·¯å¾„,å€¼æ˜¯ä¸€ä¸ªå‡½æ•°</span></span><br><span class="line">    <span class="comment">/*!**************************!*\</span></span><br><span class="line"><span class="comment">  !*** ./mySrc/js/tmp2.js ***!</span></span><br><span class="line"><span class="comment">  \**************************/</span></span><br><span class="line">    <span class="comment">/***/</span> <span class="function">(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">        __unused_webpack_module,</span></span></span><br><span class="line"><span class="params"><span class="function">        __webpack_exports__,</span></span></span><br><span class="line"><span class="params"><span class="function">        __webpack_require__</span></span></span><br><span class="line"><span class="params"><span class="function">    </span>) =&gt;</span> &#123;</span><br><span class="line">        __webpack_require__.<span class="title function_">r</span>(__webpack_exports__);<span class="comment">//é¦–å…ˆæ ‡è®°æ¨¡å—</span></span><br><span class="line">        <span class="comment">/* harmony export */</span> __webpack_require__.<span class="title function_">d</span>(__webpack_exports__, &#123;</span><br><span class="line">            <span class="comment">/* harmony export */</span> <span class="attr">default</span>: <span class="function">() =&gt;</span> <span class="comment">/* binding */</span> show,</span><br><span class="line">            <span class="comment">/* harmony export */</span></span><br><span class="line">        &#125;);<span class="comment">//è¿™ä¸€æ­¥åˆ©ç”¨å®šä¹‰å‡½æ•°ï¼Œå°†æœ¬æ¨¡å—æŠ›å‡ºçš„å±æ€§å®šä¹‰åœ¨module.exportsä¸Šï¼Œä»è€Œä½¿å¤–éƒ¨èƒ½å¤Ÿæ­£å¸¸è®¿é—®</span></span><br><span class="line">        <span class="comment">//ä¸‹é¢å°±æ˜¯æºä»£ç </span></span><br><span class="line">        <span class="keyword">function</span> <span class="title function_">show</span>(<span class="params">arg</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;show me!&quot;</span>);</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`arg is <span class="subst">$&#123;arg&#125;</span>`</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/***/</span></span><br><span class="line">    &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></li></ul><h3 id="å…¥å£æ¨¡å—"><a href="#å…¥å£æ¨¡å—" class="headerlink" title="å…¥å£æ¨¡å—"></a>å…¥å£æ¨¡å—</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">/*!**************************!*\</span></span><br><span class="line"><span class="comment">  !*** ./mySrc/js/main.js ***!</span></span><br><span class="line"><span class="comment">  \**************************/</span></span><br><span class="line">    <span class="comment">/* harmony import */</span> <span class="keyword">var</span> _tmp2__WEBPACK_IMPORTED_MODULE_0__ = <span class="title function_">__webpack_require__</span>(</span><br><span class="line">        <span class="comment">/*! ./tmp2 */</span> <span class="string">&quot;./mySrc/js/tmp2.js&quot;</span></span><br><span class="line">    );<span class="comment">//åˆ©ç”¨__webpack_require__å‡½æ•°æ¨¡ä»¿requireè¯»å–äº†tmp2æ¨¡å—</span></span><br><span class="line"></span><br><span class="line">    (<span class="number">0</span>, _tmp2__WEBPACK_IMPORTED_MODULE_0__.<span class="property">default</span>)(<span class="number">123</span>);<span class="comment">//è°ƒç”¨tmp2æŠ›å‡ºçš„showå‡½æ•°</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;1111&quot;</span>);<span class="comment">//å…¥å£æºä»£ç </span></span><br><span class="line">&#125;)();</span><br></pre></td></tr></table></figure><ul><li>å…³é”®æ˜¯ __webpack_require__ å‡½æ•°æˆåŠŸè¿”å›äº†æ¨¡å—æŠ›å‡ºçš„å±æ€§ï¼Œè¿™ä¸€ç‚¹å¿…é¡»ç†è§£ï¼Œä¹‹åçš„å†…å®¹å°±å¾ˆç®€å•äº†</li></ul>]]></content>
      
      
      <categories>
          
          <category> javascript </category>
          
      </categories>
      
      
        <tags>
            
            <tag> webpack </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æ‰‹åŠ¨å®ç°ä¸€ä¸ªç®€å•çš„Promise</title>
      <link href="/2021/05/19/wirteMyPromise/"/>
      <url>/2021/05/19/wirteMyPromise/</url>
      
        <content type="html"><![CDATA[<ul><li><p>è‡ªå®šä¹‰çš„promise</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">myPromise</span>(<span class="params">fn</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">state</span> = <span class="string">&#x27;pending&#x27;</span>; <span class="comment">//è®°å½•çŠ¶æ€ï¼Œåªæœ‰ä¸‰ç§å¯èƒ½pending resolved rejected</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">val</span> = <span class="literal">null</span>; <span class="comment">//promiseæºå¸¦å€¼</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">onResolvedCallback</span> = []; <span class="comment">//å¾…è°ƒç”¨çš„å›è°ƒå‡½æ•°ï¼ŒpendingçŠ¶æ€ä¸‹è°ƒç”¨thenæ—¶éœ€è¦ </span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">onRejectedCallback</span> = [];</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">resolve</span> = <span class="function">(<span class="params">val</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">state</span> === <span class="string">&#x27;pending&#x27;</span>) &#123; <span class="comment">//ä¿è¯çŠ¶æ€ç¡®å®šåä¸ä¼šæ”¹å˜</span></span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">state</span> = <span class="string">&#x27;resolved&#x27;</span>;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">val</span> = val;</span><br><span class="line">            <span class="comment">//çŠ¶æ€å˜åŒ–åï¼Œå–å‡ºæ‰€æœ‰å¾…è°ƒç”¨çš„å›è°ƒå‡½æ•°ï¼Œè¿›è¡Œå¤„ç†ã€‚ä¾‹å¦‚ï¼šthençš„ç¬¬ä¸€ä¸ªå›è°ƒå‡½æ•°</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="variable language_">this</span>.<span class="property">onResolvedCallback</span>.<span class="property">length</span>; i++) &#123;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">onResolvedCallback</span>[i](val);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">reject</span> = <span class="function">(<span class="params">reason</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">state</span> === <span class="string">&#x27;pending&#x27;</span>) &#123; <span class="comment">//ä¿è¯çŠ¶æ€ç¡®å®šåä¸ä¼šæ”¹å˜</span></span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">state</span> = <span class="string">&#x27;rejected&#x27;</span>;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">val</span> = reason;</span><br><span class="line">            <span class="comment">//å’Œresolveç±»ä¼¼</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="variable language_">this</span>.<span class="property">onRejectedCallback</span>.<span class="property">length</span>; i++) &#123;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">onRejectedCallback</span>[i](reason);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">then</span> = <span class="function">(<span class="params">resolveFn, rejectFn</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">//promiseå€¼ç©¿é€ï¼Œå¹¶ä¿è¯é»˜è®¤å¤„ç†å‡½æ•°</span></span><br><span class="line">        resolveFn = <span class="keyword">typeof</span> resolveFn === <span class="string">&#x27;function&#x27;</span> ? resolveFn : <span class="keyword">function</span> (<span class="params">v</span>) &#123; <span class="keyword">return</span> v &#125;;</span><br><span class="line">        rejectFn = <span class="keyword">typeof</span> rejectFn === <span class="string">&#x27;function&#x27;</span> ? rejectFn : <span class="keyword">function</span> (<span class="params">r</span>) &#123; <span class="keyword">return</span> r &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">state</span> === <span class="string">&#x27;resolved&#x27;</span>) &#123; <span class="comment">//è°ƒç”¨thenæ—¶çŠ¶æ€æ˜¯resolved</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title function_">myPromise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123; <span class="comment">//thenæ°¸è¿œè¿”å›ä¸€ä¸ªpromiseï¼Œç”¨äºé“¾å¼è°ƒç”¨</span></span><br><span class="line">                <span class="keyword">try</span> &#123; <span class="comment">//tryæ•è·é”™è¯¯ï¼Œç”¨æ¥reject</span></span><br><span class="line">                    <span class="keyword">let</span> next = <span class="title function_">resolveFn</span>(<span class="variable language_">this</span>.<span class="property">val</span>); <span class="comment">//è°ƒç”¨ç”¨æˆ·è‡ªå®šä¹‰çš„resolveå¤„ç†å‡½æ•°ï¼ŒæŠŠå€¼ä¼ å‡ºå»ï¼Œå¹¶è·å–ç”¨æˆ·è¿”å›çš„å€¼</span></span><br><span class="line">                    <span class="keyword">if</span> (next <span class="keyword">instanceof</span> myPromise) &#123; <span class="comment">//resolveå¤„ç†å‡½æ•°è¿”å›çš„æ˜¯promiseæ—¶ï¼Œè°ƒç”¨thenè§£åŒ…</span></span><br><span class="line">                        next.<span class="title function_">then</span>(resolve, reject)</span><br><span class="line">                        <span class="comment">//æ³¨æ„ï¼Œæ­¤å¤„å°†å¤–éƒ¨ï¼ˆthenå‡½æ•°å®šä¹‰ï¼‰å³å°†è¿”å›çš„promiseçš„resolveä¼ å…¥äº†ç”¨æˆ·è‡ªå®šä¹‰çš„resolveå¤„ç†å‡½æ•°è¿”å›çš„promiseä¸­ï¼Œå½“ç”¨æˆ·çš„promiseçŠ¶æ€æ”¹å˜æ—¶ï¼Œå°±ä¼šè°ƒç”¨æ­¤å¤„çš„resolveå¹¶å°†å€¼ä¼ ç»™å¤–éƒ¨çš„promiseï¼Œä»è€Œå¯ä»¥ä½¿ç”¨æœ€å¤–éƒ¨çš„thenæ¥æ”¶ï¼Œæ„æˆè¿”å› new promise çš„promiseé“¾å¼è°ƒç”¨</span></span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="title function_">resolve</span>(next) <span class="comment">//å¦åˆ™ç›´æ¥resolveç”¨æˆ·ä¼ è¿›æ¥çš„å€¼</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">                    <span class="title function_">rejectFn</span>(e)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">state</span> === <span class="string">&#x27;rejected&#x27;</span>) &#123; <span class="comment">//rejectçš„çŠ¶æ€ï¼Œé€»è¾‘å’Œä¸Šé¢å·®ä¸å¤š</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title function_">myPromise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">let</span> next = <span class="title function_">rejectFn</span>(<span class="variable language_">this</span>.<span class="property">val</span>);</span><br><span class="line">                    <span class="keyword">if</span> (next <span class="keyword">instanceof</span> myPromise) &#123;</span><br><span class="line">                        next.<span class="title function_">then</span>(resolve, reject)</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">                    <span class="title function_">rejectFn</span>(e)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">state</span> === <span class="string">&#x27;pending&#x27;</span>) &#123; <span class="comment">//è°ƒç”¨thenæ—¶ï¼ŒçŠ¶æ€æœªç¡®å®š</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title function_">myPromise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">                <span class="comment">//ç”±äºçŠ¶æ€æœªç¡®å®šï¼Œå…ˆæŠŠçŠ¶æ€ç¡®å®šæ—¶è¦æ‰§è¡Œçš„é€»è¾‘ä¿å­˜èµ·æ¥ï¼Œç­‰åˆ°çŠ¶æ€ç¡®å®šæ—¶ï¼Œæ‰§è¡Œ</span></span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">onResolvedCallback</span>.<span class="title function_">push</span>(<span class="keyword">function</span> (<span class="params">val</span>) &#123; <span class="comment">//resolvedé€»è¾‘ä¿å­˜</span></span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="keyword">let</span> next = <span class="title function_">resolveFn</span>(val);</span><br><span class="line">                        <span class="keyword">if</span> (next <span class="keyword">instanceof</span> myPromise) &#123;</span><br><span class="line">                            next.<span class="title function_">then</span>(resolve, reject)</span><br><span class="line">                        &#125;;</span><br><span class="line">                        <span class="title function_">resolve</span>(next);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">                        <span class="title function_">reject</span>(e)</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;)</span><br><span class="line"></span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">onRejectedCallback</span>.<span class="title function_">push</span>(<span class="keyword">function</span> (<span class="params">reason</span>) &#123; <span class="comment">//rejecté€»è¾‘ä¿å­˜</span></span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="keyword">let</span> next = <span class="title function_">rejectFn</span>(reason);</span><br><span class="line">                        <span class="keyword">if</span> (next <span class="keyword">instanceof</span> myPromise) &#123;</span><br><span class="line">                            next.<span class="title function_">then</span>(resolve, reject)</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="title function_">reject</span>(next)</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">                        <span class="title function_">reject</span>(e)</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;)</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123; <span class="comment">//å°è¯•æ‰§è¡Œpromiseæ„é€ å‡½æ•°çš„ä»£ç ï¼Œå¹¶å°†è‡ªèº«å®šä¹‰å¥½çš„resolve,rejectä¼ å…¥</span></span><br><span class="line">        <span class="title function_">fn</span>(<span class="variable language_">this</span>.<span class="property">resolve</span>, <span class="variable language_">this</span>.<span class="property">reject</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">reject</span>(e)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æµ‹è¯•æ ·ä¾‹</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> <span class="title function_">myPromise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="title function_">resolve</span>(<span class="number">1</span>)</span><br><span class="line">&#125;).<span class="title function_">then</span>(<span class="function">(<span class="params">val</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(val);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title function_">myPromise</span>(<span class="function">(<span class="params">resolve</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">            <span class="title function_">resolve</span>(<span class="number">2</span>)</span><br><span class="line">        &#125;, <span class="number">1000</span>);</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;).<span class="title function_">then</span>(<span class="function">(<span class="params">val</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(val);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><ul><li>å¼‚æ­¥throwæ— æ³•æ•è·</li><li>é€šè¿‡thiså®šä¹‰å‡½æ•°ï¼Œå¯¼è‡´æ¯ä¸ªpromiseå®ä¾‹ä¸å…±ç”¨æ–¹æ³•ï¼Œæ€§èƒ½å½±å“</li></ul></li><li><p>all,raceæ‰‹å†™</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Promise</span>.<span class="property">myAll</span> = <span class="function">(<span class="params">promiseArr</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> count = <span class="number">0</span>, all = promiseArr.<span class="property">length</span>;</span><br><span class="line">        <span class="keyword">let</span> resArr = [];</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; all; i++) &#123;</span><br><span class="line">            promiseArr[i].<span class="title function_">then</span>(<span class="function">(<span class="params">val</span>) =&gt;</span> &#123;</span><br><span class="line">                count++;</span><br><span class="line">                resArr[i] = val;</span><br><span class="line">                <span class="keyword">if</span> (count === all) &#123; <span class="comment">//ä¸»è¦é€šè¿‡promiseæ•°é‡ç¡®å®šæ˜¯å¦ç»“æŸ</span></span><br><span class="line">                    <span class="title function_">resolve</span>(resArr)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;, <span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">                <span class="title function_">reject</span>(err)</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//raceæ›´ç®€å• å¾…ä¼šå†™....</span></span><br></pre></td></tr></table></figure></li></ul>]]></content>
      
      
      <categories>
          
          <category> javascript </category>
          
      </categories>
      
      
        <tags>
            
            <tag> javascript </tag>
            
            <tag> promise </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
